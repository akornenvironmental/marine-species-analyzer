<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marine Species Analyzer</title>
    <style>
        /* Enhanced styles - preserving original functionality */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #09306b;
            min-height: 100vh;
        }

        /* Main Layout - preserved */
        .main-layout {
            display: flex;
            min-height: 100vh;
        }

        /* AI Assistant Panel - preserved */
        .ai-assistant {
            width: 350px;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .ai-body {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ai-intro {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border: 1px solid #5a7ba8;
            border-radius: 8px;
            padding: 15px;
        }

        .ai-intro p {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
        }

        .ai-features {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .ai-features li {
            padding: 4px 0;
            font-size: 14px;
            color: #555;
            line-height: 1.3;
        }

        .ai-features li:before {
            content: "▶ ";
            color: #5a7ba8;
            font-weight: bold;
            margin-right: 5px;
        }

        .ai-input-section {
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .ai-input-box {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .ai-input-box:focus {
            outline: none;
            border-color: #5a7ba8;
            box-shadow: 0 0 5px rgba(90, 123, 168, 0.3);
        }

        .ai-send-button {
            width: 100%;
            background: linear-gradient(135deg, #209e5d, #1a7a47);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
        }

        .ai-send-button:hover {
            background: linear-gradient(135deg, #1a7a47, #209e5d);
            transform: translateY(-1px);
        }

        /* Main Content - preserved */
        .main-content {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .content-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-bottom: 2px solid #e9ecef;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-title h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .content-title p {
            color: #666;
            font-size: 16px;
            font-weight: 400;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #e8f5e8;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #4caf50;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .top-bar {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .language-selector {
            display: flex;
            gap: 5px;
        }

        .lang-btn {
            background: none;
            border: 1px solid #dee2e6;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .lang-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .lang-btn:hover:not(.active) {
            background: #f8f9fa;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2c5aa0;
            margin-bottom: 10px;
        }

        .header p {
            color: #6c757d;
            font-size: 1.1rem;
        }

        .tabs-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            background: white;
            color: #2c5aa0;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #2c5aa0;
        }

        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Results section with enhanced layout */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-title {
            font-size: 1.8rem;
            color: #333;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: #2c5aa0;
            color: white;
            border-color: #2c5aa0;
        }

        .results-stats {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .stat-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .stat-verified {
            background: #d4edda;
            color: #155724;
        }

        .stat-synonyms {
            background: #fff3cd;
            color: #856404;
        }

        .stat-not-found {
            background: #f8d7da;
            color: #721c24;
        }

        /* Enhanced species cards */
        .species-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .species-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .species-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .species-card.verified {
            border-left: 4px solid #28a745;
        }

        .species-card.synonym {
            border-left: 4px solid #ffc107;
        }

        .species-card.not-found {
            border-left: 4px solid #dc3545;
        }

        .species-header {
            margin-bottom: 15px;
        }

        .species-name {
            font-style: italic;
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c5aa0;
            margin-bottom: 5px;
        }

        .common-names {
            color: #6c757d;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-verified {
            background: #28a745;
            color: white;
        }

        .status-synonym {
            background: #ffc107;
            color: #212529;
        }

        .status-not-found {
            background: #dc3545;
            color: white;
        }

        .confidence-section {
            margin: 15px 0;
        }

        .confidence-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .confidence-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .confidence-high {
            background: linear-gradient(90deg, #28a745, #20c997);
        }

        .confidence-medium {
            background: linear-gradient(90deg, #ffc107, #fd7e14);
        }

        .confidence-low {
            background: linear-gradient(90deg, #dc3545, #e83e8c);
        }

        .species-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .detail-grid {
            display: grid;
            gap: 8px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: start;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }

        .detail-value {
            color: #6c757d;
        }

        .citation {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .source-quote {
            font-style: italic;
            margin-top: 8px;
            padding: 8px 12px;
            background: #fff;
            border-left: 3px solid #dee2e6;
            border-radius: 0 4px 4px 0;
        }

        /* Table view */
        .species-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .species-table.active {
            display: table;
        }

        .species-table th,
        .species-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9rem;
        }

        .species-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .species-table tbody tr:hover {
            background: #f8f9fa;
        }

        .species-table .scientific-name {
            font-style: italic;
            font-weight: 600;
            color: #2c5aa0;
        }

        /* Units standardization display */
        .standardized-value {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .original-value {
            color: #6c757d;
            font-size: 0.85rem;
        }

        .converted-value {
            color: #495057;
            font-weight: 500;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }

            .species-grid {
                grid-template-columns: 1fr;
            }

            .results-header {
                flex-direction: column;
                align-items: stretch;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                text-align: center;
            }
        }

        /* Loading and processing states */
        .processing {
            opacity: 0.7;
            pointer-events: none;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2c5aa0;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 0.95rem;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar with Language Selector -->
    <div style="background: white; border-bottom: 1px solid #e9ecef; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <strong>🐚 Marine Species Analyzer</strong>
        </div>
        <div style="display: flex; gap: 5px;">
            <button class="lang-btn active" onclick="setLanguage('en')" data-lang="en" style="background: #007bff; color: white; border: 1px solid #007bff; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">English</button>
            <button class="lang-btn" onclick="setLanguage('es')" data-lang="es" style="background: none; border: 1px solid #dee2e6; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Español</button>
            <button class="lang-btn" onclick="setLanguage('fr')" data-lang="fr" style="background: none; border: 1px solid #dee2e6; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Français</button>
        </div>
    </div>

    <!-- Main Layout - preserved original structure -->
    <div class="main-layout">
        <!-- AI Assistant Panel - preserved -->
        <div class="ai-assistant">
            <div class="ai-body">
                <div class="ai-intro">
                    <p><strong>🤖 Marine Species AI Helper</strong></p>
                    <ul class="ai-features">
                        <li>Help with PDF processing questions</li>
                        <li>Explain WoRMS verification results</li>
                        <li>Suggest fixes for unverified species</li>
                        <li>Generate species reports</li>
                        <li>Provide taxonomic guidance</li>
                        <li>Export data in various formats</li>
                        <li>Compare database matches</li>
                        <li>Improve OCR accuracy tips</li>
                    </ul>
                </div>
                <div class="ai-input-section">
                    <textarea class="ai-input-box" id="aiInput" placeholder="Ask me anything! For example: 'Why wasn't Mytilus californianus found?' or 'How can I improve OCR accuracy?'"></textarea>
                    <button class="ai-send-button" onclick="sendAIMessage()">Ask AI Helper</button>
                </div>
            </div>
        </div>

        <!-- Main Content - preserved -->
        <div class="main-content">
            <div class="content-header">
                <div class="content-title">
                    <h1>🐚 Marine Species Analyzer</h1>
                    <p>Professional PDF extraction & multi-database verification tool</p>
                </div>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>System Online</span>
                </div>
            </div>

            <!-- Tabs - preserved original layout but moved help to the right -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('upload')">📄 Upload & Extract</button>
                <button class="tab" onclick="switchTab('results')">📊 Results & Verification</button>
                <button class="tab" onclick="switchTab('analytics')">📈 Analytics</button>
                <button class="tab" onclick="switchTab('help')" style="margin-left: auto;">❓ Help</button>
            </div>

            <!-- Upload Tab Content - preserved original structure -->
            <div class="tab-content" id="upload-content">
                <!-- Two-column layout for upload options -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- PDF Upload Section -->
                    <div class="upload-section" id="uploadSection">
                        <div class="upload-icon">📄</div>
                        <div class="upload-text">Upload Marine Field Guide PDF</div>
                        <div class="upload-subtext">Drag and drop your PDF here, or click to browse</div>
                        <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                            Choose PDF File
                        </button>
                        <input type="file" id="fileInput" class="file-input" accept=".pdf">
                        <div style="margin-top: 15px; font-size: 0.9rem; color: #6c757d;">
                            Maximum file size: 1GB • Files stored securely in Google Drive
                        </div>
                    </div>

                    <!-- Manual Species Entry Section - preserved -->
                    <div class="manual-entry-section">
                        <div class="manual-entry-header">
                            <div class="manual-entry-icon">🔍</div>
                            <div class="manual-entry-title">
                                <h3>Manual Species Lookup</h3>
                                <p>Enter species names to verify against marine databases</p>
                            </div>
                        </div>
                        
                        <div class="species-input-container">
                            <div class="input-header">
                                <label for="manualSpeciesInput">Species Names:</label>
                                <div class="input-examples">
                                    <span class="example-item">Scientific names</span>
                                    <span class="example-item">Common names</span>
                                </div>
                            </div>
                            
                            <textarea id="manualSpeciesInput" class="manual-species-input" 
                                      placeholder="Enter species names here, one per line:

Mytilus californianus
California mussel
Blue rockfish"></textarea>
                            
                            <div class="input-controls">
                                <button class="btn btn-primary" onclick="processManualSpecies()">
                                    <span class="btn-icon">🔍</span>
                                    Verify Species
                                </button>
                                <button class="btn btn-secondary" onclick="clearManualInput()">
                                    <span class="btn-icon">🗑️</span>
                                    Clear
                                </button>
                                <button class="btn btn-success" onclick="loadSampleSpecies()">
                                    <span class="btn-icon">📋</span>
                                    Examples
                                </button>
                            </div>
                            
                            <div class="input-tips">
                                <div class="tip-item">
                                    <span class="tip-icon">✅</span>
                                    <span>Accepts scientific & common names</span>
                                </div>
                                <div class="tip-item">
                                    <span class="tip-icon">🔄</span>
                                    <span>Auto-resolves common to scientific names</span>
                                </div>
                                <div class="tip-item">
                                    <span class="tip-icon">🌊</span>
                                    <span>Verifies against 4 marine databases</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OR Divider -->
                <div style="display: flex; align-items: center; margin: 30px 0;">
                    <div style="flex: 1; height: 1px; background: #dee2e6;"></div>
                    <span style="padding: 0 20px; color: #6c757d; font-weight: 600;">PROCESSING WORKFLOW</span>
                    <div style="flex: 1; height: 1px; background: #dee2e6;"></div>
                </div>

                <!-- Processing Steps - preserved -->
                <div class="processing-steps">
                    <div class="step-card" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-title">Input Processing</div>
                        <div class="step-description">Process PDF or manual species entries</div>
                    </div>
                    <div class="step-card" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-title">Species Parsing</div>
                        <div class="step-description">Extract and validate species names</div>
                    </div>
                    <div class="step-card" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-title">Name Resolution</div>
                        <div class="step-description">Resolve common names to scientific names</div>
                    </div>
                    <div class="step-card" id="step4">
                        <div class="step-number">4</div>
                        <div class="step-title">Database Verification</div>
                        <div class="step-description">Verify against WoRMS, GBIF, iNaturalist & OBIS</div>
                    </div>
                    <div class="step-card" id="step5">
                        <div class="step-number">5</div>
                        <div class="step-title">Results Analysis</div>
                        <div class="step-description">Analyze verification results and confidence</div>
                    </div>
                </div>

                <div id="processingResults">
                    <!-- Processing messages will appear here -->
                </div>
            </div>

            <!-- Results Tab Content - enhanced with view toggle and common names -->
            <div class="tab-content hidden" id="results-content">
                <div class="results-header">
                    <div class="results-title">Species Verification Results</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="view-btn active" onclick="setView('cards')" style="background: #2c5aa0; color: white; border: 1px solid #2c5aa0; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">📋 Cards</button>
                        <button class="view-btn" onclick="setView('table')" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">📊 Table</button>
                    </div>
                    <div class="results-stats" id="resultsStats">
                        <span class="stat-badge stat-verified" id="verifiedCount">0 Verified</span>
                        <span class="stat-badge stat-synonyms" id="synonymCount">0 Synonyms</span>
                        <span class="stat-badge stat-not-found" id="notFoundCount">0 Not Found</span>
                    </div>
                </div>
                
                <!-- Cards View - enhanced -->
                <div class="species-grid" id="speciesGrid">
                    <!-- Species cards will be populated here -->
                </div>

                <!-- Table View - new addition -->
                <div style="overflow-x: auto; display: none;" id="tableView">
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" id="speciesTable">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600; color: #495057;">Scientific Name</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600; color: #495057;">Common Name(s)</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600; color: #495057;">Status</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600; color: #495057;">Confidence</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600; color: #495057;">Size (Standard)</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600; color: #495057;">Habitat</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600; color: #495057;">Source</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600; color: #495057;">Page(s)</th>
                            </tr>
                        </thead>
                        <tbody id="speciesTableBody">
                            <!-- Table rows will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div class="export-section">
                    <button class="export-btn" onclick="exportToCSV()">📊 Export CSV</button>
                    <button class="export-btn" onclick="exportToExcel()">📈 Export Excel</button>
                    <button class="export-btn" onclick="generateReport()">📋 Generate Report</button>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-content" id="analytics-content">
                <h2 data-translate="analytics.title">Verification Analytics</h2>
                
                <!-- Compact Analytics Dashboard -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: #2c5aa0; font-weight: bold;" id="totalProcessed">0</div>
                        <div style="color: #6c757d; font-size: 0.9rem;">Total Species</div>
                    </div>
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: #28a745; font-weight: bold;" id="successRate">0%</div>
                        <div style="color: #6c757d; font-size: 0.9rem;">Success Rate</div>
                    </div>
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: #17a2b8; font-weight: bold;" id="avgConfidence">0%</div>
                        <div style="color: #6c757d; font-size: 0.9rem;">Avg Confidence</div>
                    </div>
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: #ffc107; font-weight: bold;" id="needsReview">0</div>
                        <div style="color: #6c757d; font-size: 0.9rem;">Need Review</div>
                    </div>
                </div>

                <!-- Database Coverage -->
                <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333;">🗄️ Database Coverage</h3>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span><strong>WoRMS:</strong> <span id="wormsDetails">0 species</span></span>
                            <span id="wormsPercent" style="font-weight: bold; color: #28a745;">0%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span><strong>GBIF:</strong> <span id="gbifDetails">0 species</span></span>
                            <span id="gbifPercent" style="font-weight: bold; color: #007bff;">0%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span><strong>iNaturalist:</strong> <span id="inatDetails">0 species</span></span>
                            <span id="inatPercent" style="font-weight: bold; color: #6f42c1;">0%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span><strong>OBIS:</strong> <span id="obisDetails">0 species</span></span>
                            <span id="obisPercent" style="font-weight: bold; color: #20c997;">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Confidence Distribution -->
                <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333;">📊 Confidence Distribution</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;" id="excellentCount">0</div>
                            <div style="font-size: 0.85rem; color: #6c757d;">Excellent (80%+)</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #17a2b8;" id="goodCount">0</div>
                            <div style="font-size: 0.85rem; color: #6c757d;">Good (60-79%)</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;" id="fairCount">0</div>
                            <div style="font-size: 0.85rem; color: #6c757d;">Fair (40-59%)</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #dc3545;" id="poorCount">0</div>
                            <div style="font-size: 0.85rem; color: #6c757d;">Poor (0-39%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help Tab -->
            <div class="tab-content" id="help-content">
                <h2 data-translate="help.title">User Guide & Documentation</h2>
                
                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 30px;">
                    <h3 data-translate="help.quickstart.title">🚀 Quick Start</h3>
                    <ol>
                        <li data-translate="help.quickstart.step1">Upload PDF: Drag and drop a marine field guide or species list PDF</li>
                        <li data-translate="help.quickstart.step2">Wait for Processing: OCR extracts text and AI parses species names</li>
                        <li data-translate="help.quickstart.step3">Review Results: Check verification results in the Results tab</li>
                        <li data-translate="help.quickstart.step4">Export Data: Download CSV or generate reports for analysis</li>
                    </ol>
                </div>

                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 30px;">
                    <h3 data-translate="help.databases.title">🗄️ Databases Used</h3>
                    <ul>
                        <li><strong>WoRMS:</strong> <span data-translate="help.databases.worms">World Register of Marine Species (authoritative taxonomy)</span></li>
                        <li><strong>GBIF:</strong> <span data-translate="help.databases.gbif">Global Biodiversity Information Facility (occurrence data)</span></li>
                        <li><strong>iNaturalist:</strong> <span data-translate="help.databases.inat">Citizen science observations and photos</span></li>
                        <li><strong>OBIS:</strong> <span data-translate="help.databases.obis">Ocean Biodiversity Information System (marine-specific data)</span></li>
                    </ul>
                </div>

                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px;">
                    <h3 data-translate="help.standards.title">📏 Standardized Units</h3>
                    <ul>
                        <li data-translate="help.standards.size"><strong>Size:</strong> Converted to meters (m) for length, kilograms (kg) for weight</li>
                        <li data-translate="help.standards.depth"><strong>Depth:</strong> Converted to meters (m) below sea level</li>
                        <li data-translate="help.standards.temp"><strong>Temperature:</strong> Converted to Celsius (°C)</li>
                        <li data-translate="help.standards.original"><strong>Original values:</strong> Displayed alongside standardized units</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Legal Disclaimer Footer -->
        <div style="background: #f8f9fa; border-top: 1px solid #dee2e6; padding: 20px; margin-top: 40px; font-size: 0.85rem; color: #6c757d; line-height: 1.5;">
            <div style="max-width: 1400px; margin: 0 auto;">
                <h4 style="color: #495057; margin-bottom: 10px;">⚖️ Legal Disclaimer & Data Policy</h4>
                <p><strong>File Storage:</strong> Uploaded PDFs are temporarily stored in Google Drive for processing and automatically deleted after 30 days. Files are not shared with third parties.</p>
                <p><strong>Research Use:</strong> This tool is provided for scientific research and educational purposes only. Verify all species identifications with authoritative taxonomic sources before publication or field use.</p>
                <p><strong>Accuracy Notice:</strong> While we strive for accuracy, automated species identification may contain errors. Users are responsible for validating results against primary taxonomic literature.</p>
                <p><strong>Copyright Compliance:</strong> Users must ensure they have rights to upload and process PDFs. This tool respects fair use principles and does not reproduce substantial portions of copyrighted works.</p>
                <p><strong>No Warranty:</strong> This service is provided "as is" without warranties. Akorn Environmental Consulting LLC is not liable for decisions based on tool outputs.</p>
                <p style="margin-top: 15px; text-align: center;">
                    <a href="https://akornenvironmental.com/privacy" target="_blank" style="color: #2c5aa0; text-decoration: none;">Privacy Policy</a> • 
                    <a href="https://akornenvironmental.com/terms" target="_blank" style="color: #2c5aa0; text-decoration: none;">Terms of Service</a> • 
                    <a href="mailto:aaron.kornbluth@gmail.com" style="color: #2c5aa0; text-decoration: none;">Contact</a>
                </p>
            </div>
        </div>

        <!-- Legal Disclaimer Modal -->
        <div id="legalModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <h3 style="color: #2c5aa0; margin-bottom: 20px;">⚖️ Legal Disclaimer & Terms of Use</h3>
                <div style="font-size: 0.9rem; line-height: 1.6; color: #495057;">
                    <p><strong>Before proceeding, please acknowledge:</strong></p>
                    <ul style="margin: 15px 0; padding-left: 20px;">
                        <li><strong>File Handling:</strong> PDFs are uploaded to Google Drive, processed, and automatically deleted after 30 days</li>
                        <li><strong>Research Tool:</strong> Results are for research/educational use only - verify with authoritative sources</li>
                        <li><strong>No Warranty:</strong> Tool provided "as is" - users responsible for validating outputs</li>
                        <li><strong>Copyright:</strong> Users must own or have rights to upload PDFs</li>
                        <li><strong>Large Files:</strong> 1GB max upload - processing may take several minutes</li>
                        <li><strong>Data Security:</strong> Files processed securely but users should not upload sensitive/classified materials</li>
                    </ul>
                    <p style="margin-top: 20px;"><strong>By clicking "I Agree," you accept these terms and our data handling practices.</strong></p>
                </div>
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="acceptLegalTerms()" style="background: #28a745; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer; margin-right: 10px;">
                        I Agree & Continue
                    </button>
                    <button onclick="declineLegalTerms()" style="background: #6c757d; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                        Decline
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables - preserved
        let speciesData = [];
        let currentLanguage = 'en';
        let currentView = 'cards';
        let currentProcessingStep = 0;
        let uploadedPDFInfo = null;
        let pdfLibReady = false;

        // Configuration - updated for 1GB support
        const CONFIG = {
            WORMS_API: {
                BASE_URL: 'https://www.marinespecies.org/rest',
                RATE_LIMIT: 500,
                RETRY_DELAY: 1000,
                MAX_RETRIES: 3
            },
            GBIF_API: {
                BASE_URL: 'https://api.gbif.org/v1',
                RATE_LIMIT: 300
            },
            INATURALIST_API: {
                BASE_URL: 'https://api.inaturalist.org/v1',
                RATE_LIMIT: 200
            },
            OBIS_API: {
                BASE_URL: 'https://api.obis.org',
                RATE_LIMIT: 400
            },
            MAX_FILE_SIZE: 1024 * 1024 * 1024, // 1GB
            CHUNK_SIZE: 10 * 1024 * 1024 // 10MB chunks
        };

        // Sample data - preserved
        const SAMPLE_DATA = {
            nudibranch: `649. Eubranchus madapamensis (Rao, 1969) Madapam Aeolid
Description: Body color translucent gray brown with brown-yellow, white, clear and dark spots and blotches. Bulbous cerata with tubercles; with a gold and a blue band distally, with 4-6 pinkish orange dots.
Size: To 0.5 in.
Habitat: Intertidal and shallow subtidal, to at least 30 ft.
Distribution: Indo-Pacific, from Tanzania to Hawai'i; in eastern Pacific at Bahía de los Ángeles and Bahía de Banderas.

650. Eubranchus steinbecki Behrens, 1987 Steinbeck's Aeolid
Description: Irregular, nodular cerata; body color tan with dark olive-green mottling.
Size: To 0.23 in.
Habitat: Intertidal and on boat docks.
Distribution: Palos Verdes and Mission Bay, California, and La Paz, Baja California Sur.`,

            species: `Mytilus californianus California mussel
Eubranchus steinbecki Steinbeck's Aeolid
Blue rockfish Sebastes mystinus
Haliotis rufescens Red abalone
Aeolidia loui Lou's Southern Aeolidia`
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkLegalAcceptance();
        });

        function checkLegalAcceptance() {
            const accepted = localStorage.getItem('msa_legal_accepted');
            if (!accepted) {
                document.getElementById('legalModal').style.display = 'block';
            } else {
                initializeApp();
            }
        }

        function acceptLegalTerms() {
            localStorage.setItem('msa_legal_accepted', 'true');
            localStorage.setItem('msa_legal_date', new Date().toISOString());
            document.getElementById('legalModal').style.display = 'none';
            initializeApp();
        }

        function declineLegalTerms() {
            alert('You must accept the terms to use this tool.');
            window.location.href = 'https://akornenvironmental.com';
        }

        function initializeApp() {
            console.log('Marine Species Analyzer initialized');
            updateLanguage();
        }

        // Language functions
        function setLanguage(lang) {
            currentLanguage = lang;
            
            // Update active button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-lang="${lang}"]`).classList.add('active');
            
            updateLanguage();
        }

        function updateLanguage() {
            const texts = translations[currentLanguage];
            
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (texts[key]) {
                    element.textContent = texts[key];
                }
            });
        }

        // Tab navigation
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        // View toggle
        function setView(viewType) {
            currentView = viewType;
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            if (viewType === 'cards') {
                document.getElementById('speciesGrid').style.display = 'grid';
                document.getElementById('speciesTable').classList.remove('active');
            } else {
                document.getElementById('speciesGrid').style.display = 'none';
                document.getElementById('speciesTable').classList.add('active');
            }
        }

        // File upload handlers
        function handleDragOver(event) {
            event.preventDefault();
            event.target.style.backgroundColor = '#f0f8ff';
            event.target.style.borderColor = '#2c5aa0';
        }

        function handleDragLeave(event) {
            event.target.style.backgroundColor = '';
            event.target.style.borderColor = '#dee2e6';
        }

        function handleDrop(event) {
            event.preventDefault();
            event.target.style.backgroundColor = '';
            event.target.style.borderColor = '#dee2e6';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            if (!validateFile(file)) return;

            try {
                showProcessingMessage('Starting large file upload...', 'info');
                
                // Show file size info for large files
                const fileSizeMB = Math.round(file.size / (1024 * 1024));
                if (fileSizeMB > 100) {
                    showProcessingMessage(`Uploading large file (${fileSizeMB}MB)... This may take several minutes.`, 'info');
                }
                
                // For very large files, implement chunked upload
                if (file.size > CONFIG.CHUNK_SIZE) {
                    await processLargeFile(file);
                } else {
                    await processStandardFile(file);
                }
                
            } catch (error) {
                showMessage('Error processing file: ' + error.message, 'error');
            }
        }

        async function processLargeFile(file) {
            showProcessingMessage('Processing large PDF with chunked upload...', 'info');
            
            // Simulate chunked upload progress
            for (let i = 0; i <= 100; i += 10) {
                await new Promise(resolve => setTimeout(resolve, 200));
                showProcessingMessage(`Uploading... ${i}% complete`, 'info');
            }
            
            // Continue with standard processing
            await processStandardFile(file);
        }

        async function processStandardFile(file) {
            // Simulate processing for demo
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Create sample data
            const sampleData = createSampleData(file.name);
            speciesData = sampleData;
            
            showMessage('Processing complete!', 'success');
            populateResults();
            updateAnalytics();
            
            // Switch to results tab
            setTimeout(() => {
                switchTab('results');
            }, 1000);
        }

        function validateFile(file) {
            if (file.size > CONFIG.MAX_FILE_SIZE) {
                showMessage(`File too large. Maximum size is ${CONFIG.MAX_FILE_SIZE / (1024 * 1024)}MB`, 'error');
                return false;
            }

            if (!CONFIG.SUPPORTED_TYPES.includes(file.type)) {
                showMessage('Please upload a PDF file only.', 'error');
                return false;
            }

            return true;
        }

        function createSampleData(fileName) {
            return [
                {
                    scientificName: 'Eubranchus madapamensis',
                    commonNames: ['Madapam Aeolid', 'Eólido de Madapam'],
                    status: 'verified',
                    confidence: 75,
                    author: 'Rao',
                    year: '1969',
                    originalSize: 'To 0.5 in.',
                    standardizedSize: { value: 0.0127, unit: 'm', original: 'To 0.5 in.' },
                    habitat: 'Intertidal and shallow subtidal, to at least 30 ft.',
                    distribution: 'Indo-Pacific, from Tanzania to Hawai\'i; in eastern Pacific at Bahía de los Ángeles and Bahía de Banderas.',
                    description: 'Body color translucent gray brown with brown-yellow, white, clear and dark spots and blotches. Bulbous cerata with tubercles; with a gold and a blue band distally, with 4-6 pinkish orange dots.',
                    sourceFile: fileName,
                    sourcePage: '294',
                    sourceQuote: 'Intertidal and shallow subtidal, to at least 30 ft. Distribution: Indo-Pacific, from Tanzania to Hawai\'i; in eastern Pacific at Bahía de los Ángeles and Bahía de Banderas. Remarks: Only recorded from two specimens in Mexican waters; genetic testing needs to be done to establish its identity.',
                    citation: 'Bertsch, H., Behrens, D. W., & Aguilar Rosas, L. E. (2023). Invertebrados Marinos del Noroeste de México. Universidad Autónoma de Baja California.',
                    sourceUrl: 'https://example.com/marine-invertebrates-northwest-mexico'
                },
                {
                    scientificName: 'Eubranchus steinbecki',
                    commonNames: ['Steinbeck\'s Aeolid', 'Eólido de Steinbeck'],
                    status: 'verified',
                    confidence: 90,
                    author: 'Behrens',
                    year: '1987',
                    originalSize: 'To 0.23 in.',
                    standardizedSize: { value: 0.0058, unit: 'm', original: 'To 0.23 in.' },
                    habitat: 'Intertidal and on boat docks.',
                    distribution: 'Palos Verdes and Mission Bay, California, and La Paz, Baja California Sur.',
                    description: 'Irregular, nodular cerata; body color tan with dark olive-green mottling.',
                    sourceFile: fileName,
                    sourcePage: '294',
                    sourceQuote: 'This rare aeolid is named in honor of Nobel Prize winner John Steinbeck, who wrote with Ed "Doc" Ricketts the classic narrative and scientific summary of their 1940 Gulf of California expedition, Sea of Cortez.',
                    citation: 'Bertsch, H., Behrens, D. W., & Aguilar Rosas, L. E. (2023). Invertebrados Marinos del Noroeste de México. Universidad Autónoma de Baja California.',
                    sourceUrl: 'https://example.com/marine-invertebrates-northwest-mexico'
                },
                {
                    scientificName: 'Aeolidia loui',
                    commonNames: ['Lou\'s Southern Aeolidia', 'Eólido Sureño de Lou'],
                    status: 'verified',
                    confidence: 85,
                    author: 'Kienberger et al.',
                    year: '2016',
                    originalSize: 'To about 1.2 in.',
                    standardizedSize: { value: 0.030, unit: 'm', original: 'To about 1.2 in.' },
                    habitat: 'Intertidal and shallow subtidal.',
                    distribution: 'Cape Arago, Oregon, to Punta Baja and northern Isla de Cedros, Baja California.',
                    description: 'Body covered with numerous bristly cerata; white, with cream white patches on dorsum, and cream white lines on the cerata. Rhinophores covered with irregular warts.',
                    sourceFile: fileName,
                    sourcePage: '294',
                    sourceQuote: 'This is a distinct species from the amphiboreal Aeolidia papillosa (Linnaeus, 1761), which occurs in the northeast Pacific from Washington to Alaska.',
                    citation: 'Bertsch, H., Behrens, D. W., & Aguilar Rosas, L. E. (2023). Invertebrados Marinos del Noroeste de México. Universidad Autónoma de Baja California.',
                    sourceUrl: 'https://example.com/marine-invertebrates-northwest-mexico'
                }
            ];
        }

        function populateResults() {
            updateResultsStats();
            populateSpeciesCards();
            populateSpeciesTable();
        }

        function updateResultsStats() {
            const verified = speciesData.filter(s => s.status === 'verified').length;
            const synonyms = speciesData.filter(s => s.status === 'synonym').length;
            const notFound = speciesData.filter(s => s.status === 'not-found').length;

            document.getElementById('verifiedCount').textContent = `${verified} Verified`;
            document.getElementById('synonymCount').textContent = `${synonyms} Synonyms`;
            document.getElementById('notFoundCount').textContent = `${notFound} Not Found`;
        }

        function populateSpeciesCards() {
            const grid = document.getElementById('speciesGrid');
            grid.innerHTML = '';

            speciesData.forEach(species => {
                const card = createSpeciesCard(species);
                grid.appendChild(card);
            });
        }

        function createSpeciesCard(species) {
            const div = document.createElement('div');
            div.className = `species-card ${species.status}`;
            
            const confidenceClass = species.confidence >= 80 ? 'high' : 
                                  species.confidence >= 60 ? 'medium' : 'low';

            div.innerHTML = `
                <div class="species-header">
                    <div class="species-name">${species.scientificName}</div>
                    <div class="common-names">${species.commonNames.join(', ')}</div>
                    <span class="status-badge status-${species.status}">${species.status.toUpperCase()}</span>
                </div>
                
                <div class="confidence-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span style="font-size: 0.9rem; font-weight: 500;">Confidence</span>
                        <span style="font-size: 0.9rem; font-weight: 600;">${species.confidence}%</span>
                    </div>
                    <div class="confidence-bar">
                        <div class="confidence-fill confidence-${confidenceClass}" style="width: ${species.confidence}%"></div>
                    </div>
                </div>

                <div class="species-details">
                    <div class="detail-grid">
                        <div class="detail-row">
                            <span class="detail-label">Author & Year:</span>
                            <span class="detail-value">${species.author} (${species.year})</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Size:</span>
                            <div class="detail-value standardized-value">
                                <span class="converted-value">${species.standardizedSize.value} ${species.standardizedSize.unit}</span>
                                <span class="original-value">${species.standardizedSize.original}</span>
                            </div>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Habitat:</span>
                            <span class="detail-value">${species.habitat}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Distribution:</span>
                            <span class="detail-value">${species.distribution}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Source Page:</span>
                            <span class="detail-value">${species.sourcePage}</span>
                        </div>
                    </div>

                    <div class="citation">
                        <strong>Source:</strong> ${species.citation}
                        ${species.sourceUrl ? `<br><a href="${species.sourceUrl}" target="_blank" style="color: #2c5aa0;">View Source</a>` : ''}
                    </div>

                    ${species.sourceQuote ? `
                        <div class="source-quote">
                            "${species.sourceQuote}"
                        </div>
                    ` : ''}
                </div>
            `;

            return div;
        }

        function populateSpeciesTable() {
            const tbody = document.getElementById('speciesTableBody');
            tbody.innerHTML = '';

            speciesData.forEach(species => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="scientific-name">${species.scientificName}</td>
                    <td>${species.commonNames.join(', ')}</td>
                    <td><span class="status-badge status-${species.status}">${species.status.toUpperCase()}</span></td>
                    <td>${species.confidence}%</td>
                    <td>
                        <div class="standardized-value">
                            <span class="converted-value">${species.standardizedSize.value} ${species.standardizedSize.unit}</span>
                            <span class="original-value">${species.standardizedSize.original}</span>
                        </div>
                    </td>
                    <td>${species.habitat}</td>
                    <td>${species.distribution}</td>
                    <td style="font-size: 0.85rem;">${species.citation}</td>
                    <td>${species.sourcePage}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function showMessage(message, type) {
            const container = document.getElementById('processingResults');
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
        }

        function showProcessingMessage(message, type) {
            const container = document.getElementById('processingResults');
            container.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="loading-spinner"></div>
                    <div class="message ${type}">${message}</div>
                </div>
            `;
        }

        function exportToCSV() {
            if (!speciesData.length) {
                showMessage('No data to export.', 'error');
                return;
            }

            const headers = [
                'Scientific Name',
                'Common Names',
                'Author',
                'Year',
                'Status',
                'Confidence %',
                'Size (Standard)',
                'Size (Original)',
                'Habitat',
                'Distribution',
                'Source',
                'Page',
                'Source Quote'
            ];

            const rows = speciesData.map(species => [
                species.scientificName,
                species.commonNames.join('; '),
                species.author,
                species.year,
                species.status,
                species.confidence,
                `${species.standardizedSize.value} ${species.standardizedSize.unit}`,
                species.standardizedSize.original,
                species.habitat,
                species.distribution,
                species.citation,
                species.sourcePage,
                species.sourceQuote || ''
            ]);

            const csvContent = [headers, ...rows].map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            downloadFile(csvContent, 'marine_species_analysis.csv', 'text/csv');
            showMessage('CSV exported successfully!', 'success');
        }

        function updateAnalytics() {
            if (!speciesData || speciesData.length === 0) return;

            const total = speciesData.length;
            const verified = speciesData.filter(s => s.status === 'verified').length;
            const successRate = Math.round((verified / total) * 100);
            
            const confidenceSum = speciesData.reduce((sum, s) => sum + s.confidence, 0);
            const avgConfidence = Math.round(confidenceSum / total);
            
            const needsReview = speciesData.filter(s => s.confidence < 60).length;

            // Update summary cards
            document.getElementById('totalProcessed').textContent = total;
            document.getElementById('successRate').textContent = `${successRate}%`;
            document.getElementById('avgConfidence').textContent = `${avgConfidence}%`;
            document.getElementById('needsReview').textContent = needsReview;

            // Update database coverage (simplified)
            const databases = ['worms', 'gbif', 'inat', 'obis'];
            databases.forEach(db => {
                const found = Math.floor(Math.random() * total); // Simulated data
                const percentage = Math.round((found / total) * 100);
                
                const percentElement = document.getElementById(`${db}Percent`);
                const detailsElement = document.getElementById(`${db}Details`);
                
                if (percentElement) percentElement.textContent = `${percentage}%`;
                if (detailsElement) detailsElement.textContent = `${found} species`;
            });

            // Update confidence distribution
            const buckets = {
                excellent: speciesData.filter(s => s.confidence >= 80).length,
                good: speciesData.filter(s => s.confidence >= 60 && s.confidence < 80).length,
                fair: speciesData.filter(s => s.confidence >= 40 && s.confidence < 60).length,
                poor: speciesData.filter(s => s.confidence < 40).length
            };

            Object.entries(buckets).forEach(([bucket, count]) => {
                const countElement = document.getElementById(`${bucket}Count`);
                if (countElement) countElement.textContent = count;
            });
        }

        function generateReport() {
            if (!speciesData.length) {
                showMessage('No data to generate report.', 'error');
                return;
            }

            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Marine Species Analysis Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .summary { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
                        .species { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
                        .scientific-name { font-style: italic; font-size: 1.2em; color: #2c5aa0; font-weight: bold; }
                        .citation { background: #e3f2fd; padding: 10px; border-left: 4px solid #2196f3; margin-top: 10px; font-size: 0.9em; }
                        .quote { font-style: italic; background: #f5f5f5; padding: 10px; border-left: 3px solid #ccc; margin-top: 10px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>🐚 Marine Species Analysis Report</h1>
                        <p>Generated on ${new Date().toLocaleDateString()}</p>
                    </div>

                    <div class="summary">
                        <h2>📊 Summary</h2>
                        <p><strong>Total Species:</strong> ${speciesData.length}</p>
                        <p><strong>Verified:</strong> ${speciesData.filter(s => s.status === 'verified').length}</p>
                        <p><strong>Average Confidence:</strong> ${Math.round(speciesData.reduce((sum, s) => sum + s.confidence, 0) / speciesData.length)}%</p>
                    </div>

                    <h2>📋 Species Details</h2>
                    ${speciesData.map(species => `
                        <div class="species">
                            <div class="scientific-name">${species.scientificName}</div>
                            <p><strong>Common Names:</strong> ${species.commonNames.join(', ')}</p>
                            <p><strong>Author & Year:</strong> ${species.author} (${species.year})</p>
                            <p><strong>Size:</strong> ${species.standardizedSize.value} ${species.standardizedSize.unit} (${species.standardizedSize.original})</p>
                            <p><strong>Status:</strong> ${species.status.toUpperCase()} (${species.confidence}% confidence)</p>
                            <p><strong>Habitat:</strong> ${species.habitat}</p>
                            <p><strong>Distribution:</strong> ${species.distribution}</p>
                            <p><strong>Page:</strong> ${species.sourcePage}</p>
                            <div class="citation">
                                <strong>Source:</strong> ${species.citation}
                            </div>
                            ${species.sourceQuote ? `
                                <div class="quote">
                                    "${species.sourceQuote}"
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </body>
                </html>
            `;

            downloadFile(reportHTML, 'marine_species_report.html', 'text/html');
            showMessage('Report generated successfully!', 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
