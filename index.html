<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarineID Pro - Enhanced Universal Marine Species Extraction</title>
    <meta name="description" content="Advanced AI-powered marine species identification tool with custom field extraction">
    <meta name="keywords" content="marine biology, species identification, taxonomy, field guide, WoRMS, GBIF, ocean biodiversity">
    <meta name="author" content="akorn environmental consulting, LLC">
    <link href="https://fonts.googleapis.com/css2?family=Orpheus+Pro:wght@400;700&family=Josefin+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: white;
            --border-color: #dee2e6;
            --accent-color: #08306b;
            --success-color: #209d5c;
            --warning-color: #ffc107;
            --error-color: #dc3545;
            --light-bg: #f8f9fa;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e9ecef;
            --card-bg: #2d3748;
            --border-color: #4a5568;
            --accent-color: #63b3ed;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --error-color: #f56565;
            --light-bg: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orpheus Pro', 'Georgia', serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .main-layout {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }

        /* Enhanced AI Assistant Panel */
        .ai-assistant {
            width: 400px;
            min-width: 400px;
            max-width: 400px;
            max-height: 100vh;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .ai-header {
            padding: 20px 15px 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .ai-body {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            min-height: 0;
        }

        .ai-intro {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border: 1px solid #08306b;
            border-radius: 8px;
            padding: 15px;
        }

        .ai-intro p {
            font-family: 'Josefin Sans', sans-serif;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
        }

        .ai-intro ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ai-intro li {
            font-family: 'Josefin Sans', sans-serif;
            color: #333;
            margin: 3px 0;
            padding-left: 20px;
            position: relative;
            font-size: 13px;
            line-height: 1.2;
        }

        .ai-intro li::before {
            content: "🔬";
            position: absolute;
            left: 0;
            font-size: 12px;
        }

        /* Custom Fields Configuration */
        .custom-fields-section {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .custom-fields-section h4 {
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 14px;
        }

        .field-input {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .field-input input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .field-input button {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .add-field-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
            margin-top: 8px;
        }

        .ai-input-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ai-input-box {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            background: var(--card-bg);
            color: var(--text-color);
            resize: vertical;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
            min-height: 120px;
        }

        .header-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            min-width: 200px;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-btn {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .theme-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Orpheus Pro', serif;
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.7;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            background: var(--card-bg);
            color: var(--accent-color);
            opacity: 1;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-color);
        }

        .tab-content {
            padding: 30px;
            display: none;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .tab-content.active {
            display: block;
        }

        /* Processing steps */
        .processing-steps {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .step-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            min-height: auto;
        }

        .step-number {
            width: 35px;
            height: 35px;
            background: #6c757d;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto 8px;
            font-size: 14px;
        }

        .step-card.active .step-number {
            background: var(--accent-color);
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 3px;
            color: var(--text-color);
            font-size: 13px;
        }

        .step-description {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.7;
            line-height: 1.2;
        }

        /* Upload section */
        .upload-section {
            background: var(--light-bg);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--accent-color);
            background: var(--card-bg);
        }

        /* Buttons */
        .button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Josefin Sans', sans-serif;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .button.success {
            background: var(--success-color);
        }

        .button.warning {
            background: var(--warning-color);
            color: #333;
        }

        .button.small {
            padding: 8px 12px;
            font-size: 12px;
        }

        /* Enhanced Results Table */
        .results-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .results-header {
            background: var(--light-bg);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: between;
            align-items: center;
            gap: 20px;
        }

        .results-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }

        .results-table thead {
            background: var(--light-bg);
            border-bottom: 2px solid var(--border-color);
        }

        .results-table th {
            padding: 12px 8px;
            text-align: left;
            color: var(--text-color);
            font-weight: 600;
            border-right: 1px solid var(--border-color);
            font-size: 12px;
            position: sticky;
            top: 0;
            background: var(--light-bg);
        }

        .results-table td {
            padding: 10px 8px;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            vertical-align: top;
        }

        .results-table tr:hover {
            background: var(--light-bg);
        }

        .scientific-name {
            font-style: italic;
            font-weight: 600;
            color: var(--accent-color);
        }

        .confidence-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            color: white;
        }

        .confidence-high { background: var(--success-color); }
        .confidence-medium { background: var(--warning-color); color: #333; }
        .confidence-low { background: var(--error-color); }

        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-verified {
            background: var(--success-color);
            color: white;
        }

        .status-synonym {
            background: var(--warning-color);
            color: white;
        }

        .status-not_found {
            background: var(--error-color);
            color: white;
        }

        /* Progress indicators */
        .progress-container {
            margin: 20px 0;
            padding: 20px;
            background: var(--light-bg);
            border-radius: 8px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 1rem;
            color: var(--text-color);
            font-weight: 600;
        }

        /* Messages */
        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            border-left: 4px solid;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border-left-color: var(--success-color);
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: var(--error-color);
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: var(--warning-color);
        }

        /* Custom field display in results */
        .custom-field-column {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .expandable-cell {
            cursor: pointer;
            position: relative;
        }

        .expandable-cell:hover {
            background: var(--accent-color);
            color: white;
            white-space: normal;
            overflow: visible;
            z-index: 10;
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .processing-steps {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .ai-assistant {
                width: 100%;
                min-width: 100%;
                max-width: 100%;
                order: 2;
                flex-shrink: 1;
                max-height: 400px;
            }
            
            .processing-steps {
                grid-template-columns: 1fr;
            }
            
            .tab-content {
                padding: 15px;
            }
        }

        .section-title {
            font-family: 'Orpheus Pro', serif;
            font-size: 24px;
            color: var(--text-color);
            margin: 0;
            font-weight: 700;
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: var(--text-color);
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- Enhanced AI Assistant Panel -->
        <div class="ai-assistant">
            <div class="ai-header">
                <h3 style="font-family: 'Orpheus Pro', serif; margin: 0; color: var(--text-color); font-size: 18px;">🤖 MarineID Pro Enhanced</h3>
            </div>
            <div class="ai-body">
                <div class="ai-intro">
                    <p><strong>Custom Field Extraction</strong></p>
                    <ul>
                        <li>Configure extraction fields</li>
                        <li>Bilingual document support</li>
                        <li>Enhanced pattern recognition</li>
                        <li>Improved species detection</li>
                        <li>Better data organization</li>
                        <li>Real-time field validation</li>
                        <li>Export customization</li>
                        <li>Quality confidence scoring</li>
                    </ul>
                </div>

                <!-- Custom Fields Configuration -->
                <div class="custom-fields-section">
                    <h4>📋 Custom Extraction Fields</h4>
                    <p style="font-size: 12px; color: var(--text-color); opacity: 0.8; margin-bottom: 10px;">
                        Core fields (genus, species, author, year) are always extracted. Add custom fields below:
                    </p>
                    <div id="customFieldsList">
                        <div class="field-input">
                            <input type="text" placeholder="Field name (e.g., Habitat)" value="Habitat">
                            <button onclick="removeCustomField(this)">✕</button>
                        </div>
                        <div class="field-input">
                            <input type="text" placeholder="Field name (e.g., Size)" value="Size">
                            <button onclick="removeCustomField(this)">✕</button>
                        </div>
                        <div class="field-input">
                            <input type="text" placeholder="Field name (e.g., Distribution)" value="Distribution">
                            <button onclick="removeCustomField(this)">✕</button>
                        </div>
                    </div>
                    <button class="add-field-btn" onclick="addCustomField()">+ Add Field</button>
                </div>

                <div class="ai-input-section">
                    <textarea class="ai-input-box" id="aiInput" placeholder="Ask about extraction patterns, custom fields, or document formats..."></textarea>
                    <button class="button success" onclick="sendAIMessage()">Ask AI Helper</button>
                    <div id="aiResponses" style="margin-top: 15px; max-height: 200px; overflow-y: auto;">
                        <!-- AI responses will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <div class="header-main">
                    <h1 style="font-family: 'Orpheus Pro', serif; font-size: 28px; color: var(--text-color); margin-bottom: 5px; font-weight: 700;">🐚 MarineID Pro Enhanced</h1>
                    <p style="font-family: 'Josefin Sans', sans-serif; color: var(--text-color); opacity: 0.7; font-size: 16px; font-weight: 400; margin-bottom: 10px;">
                        Advanced marine species extraction with customizable fields and enhanced accuracy
                    </p>
                    <p style="font-family: 'Josefin Sans', sans-serif; color: var(--text-color); opacity: 0.8; font-size: 14px; line-height: 1.3; max-width: 65%; padding-right: 20px;">
                        Enhanced extraction engine with user-configurable fields, improved pattern recognition for bilingual documents, and better handling of complex taxonomic formats. Now supports custom field extraction for habitat, distribution, size, and any user-defined fields.
                    </p>
                </div>
                <div class="header-controls">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="font-size: 12px; margin-right: 8px;">Theme:</span>
                        <button class="theme-btn" onclick="setTheme('system')" data-theme="system">System</button>
                        <button class="theme-btn active" onclick="setTheme('light')" data-theme="light">Light</button>
                        <button class="theme-btn" onclick="setTheme('dark')" data-theme="dark">Dark</button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('upload')">📄 Extract Species</button>
                <button class="tab" onclick="switchTab('results')">📊 Results & Data</button>
                <button class="tab" onclick="switchTab('help')" style="margin-left: auto;">❓ Help</button>
            </div>

            <!-- Upload Tab Content -->
            <div class="tab-content active" id="upload-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- PDF Upload Section -->
                    <div class="upload-section" id="uploadSection" 
                         ondragover="handleDragOver(event)" 
                         ondragleave="handleDragLeave(event)" 
                         ondrop="handleDrop(event)"
                         onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3rem; margin-bottom: 15px;">📄</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--text-color); margin-bottom: 8px;">Upload Marine Document</div>
                        <div style="color: var(--text-color); opacity: 0.7; margin-bottom: 20px;">Field guides, taxonomic papers, bilingual documents</div>
                        <button class="button">Choose PDF File</button>
                        <input type="file" id="fileInput" style="display: none;" accept=".pdf" onchange="handleFileUpload(event)">
                        <div style="margin-top: 15px; font-size: 0.9rem; color: var(--text-color); opacity: 0.6;">
                            ✨ Enhanced pattern recognition with custom field extraction
                        </div>
                    </div>

                    <!-- Manual Species Entry Section -->
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div style="font-size: 2rem;">🔍</div>
                            <div>
                                <h3 style="margin: 0; color: var(--text-color);">Manual Species Testing</h3>
                                <p style="margin: 5px 0 0 0; color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Test enhanced extraction patterns</p>
                            </div>
                        </div>
                        
                        <div>
                            <textarea id="manualSpeciesInput" style="width: 100%; height: 120px; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; font-size: 14px; background: var(--card-bg); color: var(--text-color); resize: vertical;"
                                      placeholder="Enter species data with custom fields..."></textarea>
                            
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="button" onclick="processManualSpecies()">🔍 Test Extraction</button>
                                <button class="button success" onclick="loadEnhancedSamples()">📋 Load Enhanced Samples</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Steps -->
                <div style="display: flex; align-items: center; margin: 25px 0 15px 0;">
                    <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                    <span style="padding: 0 20px; color: var(--text-color); font-weight: 600; opacity: 0.8; font-family: 'Orpheus Pro', serif; font-size: 14px;">ENHANCED PROCESSING WORKFLOW</span>
                    <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                </div>

                <div class="processing-steps">
                    <div class="step-card" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-title">PDF Analysis</div>
                        <div class="step-description">Enhanced document parsing</div>
                    </div>
                    <div class="step-card" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-title">Format Detection</div>
                        <div class="step-description">Bilingual structure analysis</div>
                    </div>
                    <div class="step-card" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-title">Species Extraction</div>
                        <div class="step-description">Improved pattern matching</div>
                    </div>
                    <div class="step-card" id="step4">
                        <div class="step-number">4</div>
                        <div class="step-title">Custom Fields</div>
                        <div class="step-description">User-defined field extraction</div>
                    </div>
                    <div class="step-card" id="step5">
                        <div class="step-number">5</div>
                        <div class="step-title">Data Validation</div>
                        <div class="step-description">Quality assurance checks</div>
                    </div>
                    <div class="step-card" id="step6">
                        <div class="step-number">6</div>
                        <div class="step-title">Database Verification</div>
                        <div class="step-description">Multi-source validation</div>
                    </div>
                </div>

                <!-- Processing Results -->
                <div id="processingResults"></div>

                <!-- Messages -->
                <div id="messages"></div>
            </div>

            <!-- Results Tab Content -->
            <div class="tab-content" id="results-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title">Enhanced Results</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="button success" onclick="exportToCSV()">📥 Export CSV</button>
                        <button class="button" onclick="exportToJSON()">📥 Export JSON</button>
                        <button class="button" onclick="resetAll()" style="background: var(--error-color);">🔄 Reset</button>
                    </div>
                </div>

                <!-- Results Container -->
                <div class="results-container" id="resultsContainer">
                    <div class="results-header">
                        <div class="results-stats" id="resultsStats">
                            <!-- Stats will be populated here -->
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                        <table class="results-table" id="resultsTable">
                            <thead id="resultsTableHead">
                                <!-- Headers will be dynamically generated based on custom fields -->
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- Results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Help Tab Content -->
            <div class="tab-content" id="help-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title">Enhanced Extraction Guide</h2>
                </div>
                
                <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%); border: 1px solid var(--success-color); border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                    <h3 style="color: var(--text-color); margin-bottom: 15px;">🚀 Enhanced Features</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="color: var(--text-color); margin-bottom: 10px;">Custom Field Extraction</h4>
                            <ul style="color: var(--text-color); line-height: 1.6; font-size: 0.9rem;">
                                <li><strong>Core Fields:</strong> Genus, species, author, year (always extracted)</li>
                                <li><strong>Custom Fields:</strong> User-configurable (habitat, size, distribution, etc.)</li>
                                <li><strong>Bilingual Support:</strong> English/Spanish field recognition</li>
                                <li><strong>Pattern Learning:</strong> Adaptive extraction based on document structure</li>
                            </ul>
                        </div>
                        <div>
                            <h4 style="color: var(--text-color); margin-bottom: 10px;">Improved Accuracy</h4>
                            <ul style="color: var(--text-color); line-height: 1.6; font-size: 0.9rem;">
                                <li><strong>Context Analysis:</strong> Better species boundary detection</li>
                                <li><strong>Format Recognition:</strong> Field guide vs. paper distinction</li>
                                <li><strong>Quality Scoring:</strong> Confidence metrics for each extraction</li>
                                <li><strong>Error Recovery:</strong> Fallback patterns for difficult documents</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: var(--text-color); margin-bottom: 15px;">📖 Example: Enhanced Field Guide Processing</h4>
                    <div style="font-family: monospace; background: var(--light-bg); padding: 15px; border-radius: 6px; font-size: 0.85rem; margin-bottom: 15px;">
                        649. Eubranchus madapamensis (Rao, 1969)<br>
                        Madapam Aeolid<br>
                        Description: Body color translucent gray brown...<br>
                        Size: To 0.5 in. Habitat: Intertidal and shallow subtidal...<br>
                        Distribution: Indo-Pacific, from Tanzania to Hawai'i...<br><br>
                        
                        <strong>Enhanced Extraction Results:</strong><br>
                        • Scientific Name: Eubranchus madapamensis<br>
                        • Common Name: Madapam Aeolid<br>
                        • Author: Rao<br>
                        • Year: 1969<br>
                        • [Custom] Size: To 0.5 in<br>
                        • [Custom] Habitat: Intertidal and shallow subtidal<br>
                        • [Custom] Distribution: Indo-Pacific, from Tanzania to Hawai'i
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-color); opacity: 0.8;">
                        The enhanced system recognizes bilingual content, numbered entries, and can extract custom fields like habitat, size, and distribution based on your configuration.
                    </p>
                </div>

                <div style="background: var(--light-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;">
                    <h3 style="color: var(--text-color); margin-bottom: 15px;">📧 Support & Contact</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="color: var(--text-color); margin-bottom: 10px;">🔬 Marine Biology & Technical</h4>
                            <p style="font-size: 0.9rem; margin-bottom: 10px; color: var(--text-color); opacity: 0.8;">
                                For taxonomic questions, field guide formats, or extraction accuracy:
                            </p>
                            <button class="button" onclick="window.location.href='mailto:aaron.kornbluth@gmail.com?subject=MarineID Pro Enhanced - Technical Support'" style="width: 100%;">
                                📧 Email Aaron Kornbluth
                            </button>
                        </div>
                        <div>
                            <h4 style="color: var(--text-color); margin-bottom: 10px;">💻 Development & Features</h4>
                            <p style="font-size: 0.9rem; margin-bottom: 10px; color: var(--text-color); opacity: 0.8;">
                                For feature requests, bug reports, or technical development:
                            </p>
                            <button class="button success" onclick="window.location.href='mailto:jakespencer6596@gmail.com?subject=MarineID Pro Enhanced - Development Support'" style="width: 100%;">
                                📧 Email Jake Spencer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let speciesData = [];
        let customFields = ['Habitat', 'Size', 'Distribution']; // Default custom fields
        let processingStats = {
            totalSpecies: 0,
            verified: 0,
            synonyms: 0,
            notFound: 0,
            processingTime: 0
        };

        // Initialize PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            updateCustomFieldsDisplay();
            console.log('MarineID Pro Enhanced - Loaded with custom field support');
        });

        function initializeTheme() {
            const savedTheme = localStorage.getItem('marineid_theme') || 'light';
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const themeBtn = document.querySelector(`[data-theme="${theme}"]`);
            if (themeBtn) themeBtn.classList.add('active');
            
            if (theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            
            localStorage.setItem('marineid_theme', theme);
        }

        // Custom Fields Management
        function addCustomField() {
            const container = document.getElementById('customFieldsList');
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'field-input';
            fieldDiv.innerHTML = `
                <input type="text" placeholder="Field name (e.g., Depth Range)">
                <button onclick="removeCustomField(this)">✕</button>
            `;
            container.appendChild(fieldDiv);
        }

        function removeCustomField(button) {
            button.parentElement.remove();
            updateCustomFields();
        }

        function updateCustomFields() {
            const fieldInputs = document.querySelectorAll('#customFieldsList input');
            customFields = Array.from(fieldInputs)
                .map(input => input.value.trim())
                .filter(field => field.length > 0);
            
            console.log('Custom fields updated:', customFields);
        }

        function updateCustomFieldsDisplay() {
            updateCustomFields();
        }

        // Tab navigation
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            const selectedTab = document.getElementById(`${tabName}-content`);
            selectedTab.classList.add('active');
            selectedTab.style.display = 'block';
        }

        // File upload handlers
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = 'var(--accent-color)';
            event.currentTarget.style.background = 'var(--card-bg)';
        }

        function handleDragLeave(event) {
            event.currentTarget.style.borderColor = 'var(--border-color)';
            event.currentTarget.style.background = 'var(--light-bg)';
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = 'var(--border-color)';
            event.currentTarget.style.background = 'var(--light-bg)';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // Enhanced PDF processing
        async function processFile(file) {
            if (!validateFile(file)) return;

            try {
                updateCustomFields(); // Ensure custom fields are current
                const startTime = Date.now();
                showProcessingMessage('🚀 Starting enhanced species extraction with custom fields...', 'info');
                updateProcessingStep(1);
                
                await processEnhancedPDF(file);
                
                processingStats.processingTime = Math.round((Date.now() - startTime) / 1000);
                
            } catch (error) {
                console.error('Error processing file:', error);
                showMessage('Error processing PDF: ' + error.message, 'error');
            }
        }

        async function processEnhancedPDF(file) {
            try {
                // Step 1: PDF Analysis
                showProcessingMessage('📄 Analyzing PDF with enhanced parser...', 'info');
                updateProcessingStep(1);
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({
                    data: arrayBuffer,
                    disableFontFace: true,
                    disableRange: false,
                    disableStream: false
                }).promise;
                
                showProcessingMessage(`📖 PDF loaded: ${pdf.numPages} pages`, 'info');
                
                // Step 2: Enhanced Format Detection
                showProcessingMessage('🔍 Enhanced format detection with bilingual analysis...', 'info');
                updateProcessingStep(2);
                
                const sampleText = await extractSampleText(pdf, 5);
                const documentFormat = detectEnhancedFormat(sampleText);
                
                // Step 3: Enhanced Species Extraction
                showProcessingMessage('🧬 Enhanced species extraction with improved patterns...', 'info');
                updateProcessingStep(3);
                
                const progressContainer = createProgressIndicator();
                const extractedSpecies = await enhancedSpeciesExtraction(pdf, documentFormat, progressContainer);
                
                if (extractedSpecies.length === 0) {
                    removeProgressIndicator(progressContainer);
                    showMessage('⚠️ No species found. The document may not contain recognizable species information.', 'warning');
                    return;
                }
                
                // Step 4: Custom Field Extraction
                showProcessingMessage('📋 Extracting custom fields...', 'info');
                updateProcessingStep(4);
                
                const enrichedSpecies = await extractCustomFields(extractedSpecies, progressContainer);
                
                // Step 5: Data Validation
                showProcessingMessage('✅ Validating extracted data...', 'info');
                updateProcessingStep(5);
                
                const validatedSpecies = await validateExtractedData(enrichedSpecies, progressContainer);
                
                // Step 6: Database Verification
                showProcessingMessage('🌊 Database verification...', 'info');
                updateProcessingStep(6);
                
                const verifiedSpecies = await simulateVerification(validatedSpecies, progressContainer);
                
                removeProgressIndicator(progressContainer);
                
                speciesData = verifiedSpecies;
                updateStats();
                
                showMessage(`🎉 Enhanced extraction complete! Successfully extracted ${speciesData.length} species with custom fields from ${pdf.numPages} pages.`, 'success');
                
                setTimeout(() => {
                    populateEnhancedResults();
                    const resultsTab = document.querySelector('[onclick="switchTab(\'results\')"]');
                    if (resultsTab) {
                        resultsTab.click();
                    }
                }, 500);
                
            } catch (error) {
                console.error('Enhanced PDF processing error:', error);
                showMessage('Error in enhanced processing: ' + error.message, 'error');
                throw error;
            }
        }

        // Enhanced species extraction
        async function enhancedSpeciesExtraction(pdf, documentFormat, progressContainer) {
            console.log('🎯 Starting enhanced species extraction...');
            
            const species = [];
            const processedNames = new Set();
            let extractionProgress = 30;
            
            // Enhanced patterns for better recognition
            const enhancedPatterns = [
                // Pattern 1: Numbered entries with improved bilingual support
                {
                    name: 'numbered_bilingual',
                    regex: /(\d{1,4})\.\s+([A-Z][a-z]{2,20})\s+([a-z]{2,25}(?:\s+[a-z]{2,15})?)\s*(?:\(([^)]{4,50})\))?\s*(?:\n\s*([A-Z][^.\n]{5,50}))?/g,
                    priority: 1
                },
                
                // Pattern 2: Family headers followed by species
                {
                    name: 'family_organized',
                    regex: /([A-Z][a-z]+idae)\s*\n\s*(\d{1,4})\.\s+([A-Z][a-z]{2,20})\s+([a-z]{2,25})\s*(?:\(([^)]{4,50})\))?/g,
                    priority: 2
                },
                
                // Pattern 3: Scientific names with enhanced author parsing
                {
                    name: 'scientific_enhanced',
                    regex: /([A-Z][a-z]{2,20})\s+([a-z]{2,25})\s+\(([A-Z][a-zA-Z\s&,\.]{4,60},?\s*\d{4})\)/g,
                    priority: 3
                }
            ];
            
            // Process each page with enhanced extraction
            for (let pageNum = 1; pageNum <= Math.min(pdf.numPages, 100); pageNum++) {
                try {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    
                    for (const pattern of enhancedPatterns) {
                        pattern.regex.lastIndex = 0;
                        let match;
                        
                        while ((match = pattern.regex.exec(pageText)) !== null) {
                            const speciesEntry = extractEnhancedSpeciesFromMatch(match, pattern, pageNum, pageText);
                            
                            if (speciesEntry && 
                                isValidSpecies(speciesEntry.genus, speciesEntry.species) && 
                                !processedNames.has(speciesEntry.scientificName)) {
                                
                                species.push(speciesEntry);
                                processedNames.add(speciesEntry.scientificName);
                                
                                console.log(`✅ ${speciesEntry.scientificName} (Page ${pageNum}) - ${pattern.name}`);
                            }
                            
                            if (pattern.regex.lastIndex === match.index) {
                                pattern.regex.lastIndex++;
                            }
                        }
                    }
                    
                    // Update progress
                    if (pageNum % 10 === 0) {
                        extractionProgress = 30 + ((pageNum / Math.min(pdf.numPages, 100)) * 30);
                        updateProgress(progressContainer, extractionProgress, 
                            `Processing page ${pageNum}: Found ${species.length} species`);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                } catch (pageError) {
                    console.warn(`Error processing page ${pageNum}:`, pageError);
                    continue;
                }
            }
            
            console.log(`🎉 Enhanced extraction complete: ${species.length} species found`);
            updateProgress(progressContainer, 60, `Enhanced extraction complete: ${species.length} species found`);
            
            return species;
        }

        function extractEnhancedSpeciesFromMatch(match, pattern, pageNumber, pageText) {
            let speciesEntry = null;
            
            switch (pattern.name) {
                case 'numbered_bilingual':
                    if (match[2] && match[3]) {
                        const {author, year} = parseAuthorYear(match[4] || 'Unknown');
                        speciesEntry = {
                            number: parseInt(match[1]),
                            genus: match[2].trim(),
                            species: match[3].trim().split(' ')[0],
                            scientificName: `${match[2].trim()} ${match[3].trim().split(' ')[0]}`,
                            commonName: match[5] ? match[5].trim() : 'Unknown',
                            authorYear: match[4] || 'Unknown',
                            author: author,
                            year: year,
                            pageNumber: pageNumber,
                            extractionPattern: pattern.name,
                            context: extractContext(pageText, match.index, 300)
                        };
                    }
                    break;
                    
                case 'family_organized':
                    if (match[3] && match[4]) {
                        const {author, year} = parseAuthorYear(match[5] || 'Unknown');
                        speciesEntry = {
                            number: parseInt(match[2]),
                            family: match[1],
                            genus: match[3].trim(),
                            species: match[4].trim(),
                            scientificName: `${match[3].trim()} ${match[4].trim()}`,
                            authorYear: match[5] || 'Unknown',
                            author: author,
                            year: year,
                            pageNumber: pageNumber,
                            extractionPattern: pattern.name,
                            context: extractContext(pageText, match.index, 300)
                        };
                    }
                    break;
                    
                case 'scientific_enhanced':
                    if (match[1] && match[2]) {
                        const {author, year} = parseAuthorYear(match[3] || 'Unknown');
                        speciesEntry = {
                            genus: match[1].trim(),
                            species: match[2].trim(),
                            scientificName: `${match[1].trim()} ${match[2].trim()}`,
                            authorYear: match[3] || 'Unknown',
                            author: author,
                            year: year,
                            pageNumber: pageNumber,
                            extractionPattern: pattern.name,
                            context: extractContext(pageText, match.index, 300)
                        };
                    }
                    break;
            }
            
            return speciesEntry;
        }

        // Enhanced custom field extraction
        async function extractCustomFields(speciesList, progressContainer) {
            console.log('📋 Starting custom field extraction for:', customFields);
            const enriched = [];
            
            for (let i = 0; i < speciesList.length; i++) {
                const species = speciesList[i];
                const enhancedData = extractCustomFieldsFromContext(species, customFields);
                
                const enhancedSpecies = {
                    ...species,
                    ...enhancedData,
                    customFieldsExtracted: true
                };
                
                enriched.push(enhancedSpecies);
                
                if (i % 5 === 0) {
                    const progress = 60 + (i / speciesList.length) * 15;
                    updateProgress(progressContainer, progress, `Custom fields: ${i + 1}/${speciesList.length} species`);
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }
            
            console.log(`📋 Custom field extraction complete: ${enriched.length} species enhanced`);
            return enriched;
        }

        function extractCustomFieldsFromContext(species, customFields) {
            const context = species.context || '';
            const extractedFields = {};
            
            // Enhanced field extraction patterns
            const fieldPatterns = {
                'habitat': [
                    /Habitat:\s*([^.\n]+(?:\.[^A-Z\n][^.\n]*)*)/i,
                    /Hábitat:\s*([^.\n]+(?:\.[^A-Z\n][^.\n]*)*)/i,
                    /(Intertidal[^.\n]*(?:\.[^A-Z\n][^.\n]*)*)/i,
                    /(Subtidal[^.\n]*(?:\.[^A-Z\n][^.\n]*)*)/i
                ],
                'size': [
                    /Size:\s*([^.\n]+)/i,
                    /Tamaño:\s*([^.\n]+)/i,
                    /(To\s+\d+(?:\.\d+)?\s*(?:in|inch|mm|cm|m))/i,
                    /(\d+(?:\.\d+)?\s*(?:mm|cm|m)\s+(?:long|diameter|width))/i,
                    /(Hasta\s+\d+(?:\.\d+)?\s*(?:mm|cm|m))/i
                ],
                'distribution': [
                    /Distribution:\s*([^.\n]+(?:\.[^A-Z\n][^.\n]*)*)/i,
                    /Distribución:\s*([^.\n]+(?:\.[^A-Z\n][^.\n]*)*)/i,
                    /(Pacific[^.\n]*(?:\.[^A-Z\n][^.\n]*)*)/i,
                    /(Pacífico[^.\n]*(?:\.[^A-Z\n][^.\n]*)*)/i,
                    /(from\s+[A-Z][^.\n]*to[^.\n]*)/i,
                    /(desde\s+[A-Z][^.\n]*hasta[^.\n]*)/i
                ],
                'description': [
                    /Description:\s*([^.]*(?:\.[^A-Z\n][^.]*){0,3}\.)/i,
                    /Descripción:\s*([^.]*(?:\.[^A-Z\n][^.]*){0,3}\.)/i
                ],
                'remarks': [
                    /Remarks:\s*([^.\n]+(?:\.[^A-Z\n][^.\n]*)*)/i,
                    /Observaciones:\s*([^.\n]+(?:\.[^A-Z\n][^.\n]*)*)/i
                ]
            };
            
            // Extract custom fields
            for (const customField of customFields) {
                const fieldKey = customField.toLowerCase();
                const patterns = fieldPatterns[fieldKey] || [
                    // Generic pattern for any custom field
                    new RegExp(`${customField}:\\s*([^.\\n]+(?:\\.[^A-Z\\n][^.\\n]*)*)`, 'i'),
                    new RegExp(`${customField}\\s*([^.\\n]+)`, 'i')
                ];
                
                for (const pattern of patterns) {
                    const match = context.match(pattern);
                    if (match && match[1]) {
                        const value = match[1].trim();
                        if (value.length > 3) {
                            extractedFields[customField] = value;
                            break;
                        }
                    }
                }
                
                // Set default if not found
                if (!extractedFields[customField]) {
                    extractedFields[customField] = `${customField} not specified`;
                }
            }
            
            return extractedFields;
        }

        // Enhanced data validation
        async function validateExtractedData(speciesList, progressContainer) {
            console.log('✅ Starting data validation...');
            const validated = [];
            
            for (let i = 0; i < speciesList.length; i++) {
                const species = speciesList[i];
                
                // Validation checks
                const validationScore = calculateValidationScore(species);
                const qualityFlags = getQualityFlags(species);
                
                const validatedSpecies = {
                    ...species,
                    validationScore: validationScore,
                    qualityFlags: qualityFlags,
                    dataQuality: validationScore >= 80 ? 'High' : validationScore >= 60 ? 'Medium' : 'Low'
                };
                
                validated.push(validatedSpecies);
                
                if (i % 10 === 0) {
                    const progress = 75 + (i / speciesList.length) * 10;
                    updateProgress(progressContainer, progress, `Validation: ${i + 1}/${speciesList.length} species`);
                    await new Promise(resolve => setTimeout(resolve, 30));
                }
            }
            
            console.log(`✅ Data validation complete: ${validated.length} species validated`);
            return validated;
        }

        function calculateValidationScore(species) {
            let score = 0;
            
            // Core field completeness (40 points)
            if (species.scientificName && species.scientificName !== 'Unknown') score += 15;
            if (species.author && species.author !== 'Unknown') score += 10;
            if (species.year && species.year !== 'Unknown') score += 10;
            if (species.pageNumber) score += 5;
            
            // Custom field completeness (30 points)
            const customFieldScore = customFields.reduce((acc, field) => {
                return acc + (species[field] && !species[field].includes('not specified') ? 10 : 0);
            }, 0);
            score += Math.min(customFieldScore, 30);
            
            // Context and extraction quality (30 points)
            if (species.context && species.context.length > 50) score += 10;
            if (species.extractionPattern) score += 10;
            if (species.commonName && species.commonName !== 'Unknown') score += 10;
            
            return Math.min(score, 100);
        }

        function getQualityFlags(species) {
            const flags = [];
            
            if (!species.author || species.author === 'Unknown') flags.push('Missing Author');
            if (!species.year || species.year === 'Unknown') flags.push('Missing Year');
            if (!species.commonName || species.commonName === 'Unknown') flags.push('No Common Name');
            if (!species.context || species.context.length < 50) flags.push('Limited Context');
            
            // Check custom fields
            customFields.forEach(field => {
                if (!species[field] || species[field].includes('not specified')) {
                    flags.push(`Missing ${field}`);
                }
            });
            
            return flags;
        }

        // Populate enhanced results
        function populateEnhancedResults() {
            updateStats();
            createEnhancedResultsTable();
            updateResultsStats();
        }

        function createEnhancedResultsTable() {
            const tableHead = document.getElementById('resultsTableHead');
            const tableBody = document.getElementById('resultsTableBody');
            
            // Clear existing content
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (speciesData.length === 0) {
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="no-data-message">
                        <div style="font-size: 3rem; margin-bottom: 15px;">🔬</div>
                        <h3>Ready for Enhanced Extraction</h3>
                        <p>Upload a marine document to see enhanced extraction with custom fields</p>
                    </div>
                `;
                return;
            }
            
            // Create dynamic headers based on core fields + custom fields
            const coreHeaders = ['Select', 'Page', 'Scientific Name', 'Common Name', 'Author', 'Year', 'Confidence', 'Status', 'Quality'];
            const allHeaders = [...coreHeaders, ...customFields, 'Actions'];
            
            const headerRow = document.createElement('tr');
            allHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                if (header === 'Select') {
                    th.style.width = '50px';
                    th.innerHTML = '<input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">';
                }
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);
            
            // Populate data rows
            speciesData.forEach((species, index) => {
                const row = document.createElement('tr');
                row.dataset.speciesIndex = index;
                
                // Select checkbox
                const selectCell = document.createElement('td');
                selectCell.innerHTML = `<input type="checkbox" onchange="toggleSpeciesSelection(${index})">`;
                selectCell.style.textAlign = 'center';
                row.appendChild(selectCell);
                
                // Page
                const pageCell = document.createElement('td');
                pageCell.textContent = species.pageNumber || '?';
                pageCell.style.textAlign = 'center';
                pageCell.style.fontWeight = '600';
                row.appendChild(pageCell);
                
                // Scientific Name
                const nameCell = document.createElement('td');
                nameCell.innerHTML = `<span class="scientific-name">${species.scientificName}</span>`;
                row.appendChild(nameCell);
                
                // Common Name
                const commonCell = document.createElement('td');
                commonCell.textContent = species.commonName || 'Not available';
                row.appendChild(commonCell);
                
                // Author
                const authorCell = document.createElement('td');
                authorCell.textContent = species.author || 'Unknown';
                row.appendChild(authorCell);
                
                // Year
                const yearCell = document.createElement('td');
                yearCell.textContent = species.year || 'Unknown';
                row.appendChild(yearCell);
                
                // Confidence
                const confidenceCell = document.createElement('td');
                const confidence = species.confidence || 0;
                const confidenceClass = confidence >= 80 ? 'confidence-high' : 
                                      confidence >= 50 ? 'confidence-medium' : 'confidence-low';
                confidenceCell.innerHTML = `<span class="confidence-badge ${confidenceClass}">${confidence}%</span>`;
                confidenceCell.style.textAlign = 'center';
                row.appendChild(confidenceCell);
                
                // Status
                const statusCell = document.createElement('td');
                const status = species.verificationStatus || 'not_found';
                const statusBadge = `<span class="status-badge status-${status}">${
                    status === 'verified' ? 'VERIFIED' : status === 'synonym' ? 'SYNONYM' : 'NOT FOUND'
                }</span>`;
                statusCell.innerHTML = statusBadge;
                statusCell.style.textAlign = 'center';
                row.appendChild(statusCell);
                
                // Quality
                const qualityCell = document.createElement('td');
                const quality = species.dataQuality || 'Unknown';
                const qualityColor = quality === 'High' ? 'var(--success-color)' : 
                                   quality === 'Medium' ? 'var(--warning-color)' : 'var(--error-color)';
                qualityCell.innerHTML = `<span style="color: ${qualityColor}; font-weight: 600;">${quality}</span>`;
                qualityCell.style.textAlign = 'center';
                row.appendChild(qualityCell);
                
                // Custom Fields
                customFields.forEach(field => {
                    const customCell = document.createElement('td');
                    customCell.className = 'custom-field-column expandable-cell';
                    customCell.textContent = species[field] || `${field} not specified`;
                    customCell.title = species[field] || `${field} not specified`; // Tooltip
                    row.appendChild(customCell);
                });
                
                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <button class="button small" onclick="retrySingleSpecies(${index})" style="background: var(--warning-color); color: #333; padding: 4px 8px; font-size: 11px;">
                        🔄 Retry
                    </button>
                `;
                actionsCell.style.textAlign = 'center';
                row.appendChild(actionsCell);
                
                tableBody.appendChild(row);
            });
        }

        function updateResultsStats() {
            const statsContainer = document.getElementById('resultsStats');
            
            if (speciesData.length === 0) {
                statsContainer.innerHTML = '<p style="color: var(--text-color); opacity: 0.7;">No data to display</p>';
                return;
            }
            
            const stats = [
                { label: 'Total Species', value: processingStats.totalSpecies, color: 'var(--accent-color)' },
                { label: 'Verified', value: processingStats.verified, color: 'var(--success-color)' },
                { label: 'Synonyms', value: processingStats.synonyms, color: 'var(--warning-color)' },
                { label: 'Not Found', value: processingStats.notFound, color: 'var(--error-color)' },
                { label: 'High Quality', value: speciesData.filter(s => s.dataQuality === 'High').length, color: 'var(--success-color)' },
                { label: 'Custom Fields', value: customFields.length, color: 'var(--accent-color)' }
            ];
            
            statsContainer.innerHTML = stats.map(stat => `
                <div class="stat-item">
                    <div class="stat-number" style="color: ${stat.color};">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                </div>
            `).join('');
        }

        // Manual processing with enhanced patterns
        function processManualSpecies() {
            const input = document.getElementById('manualSpeciesInput').value.trim();
            if (!input) {
                showMessage('Please enter species data to test.', 'warning');
                return;
            }
            processManualInput(input);
        }

        async function processManualInput(input) {
            try {
                updateCustomFields();
                showProcessingMessage('🔍 Processing manual entries with enhanced patterns...', 'info');
                updateProcessingStep(3);
                
                const progressContainer = createProgressIndicator();
                
                // Parse input into species entries
                const lines = input.split('\n').filter(line => line.trim().length > 0);
                const extractedSpecies = [];
                
                lines.forEach((line, index) => {
                    const enhancedMatch = extractEnhancedSpeciesFromLine(line, index + 1);
                    if (enhancedMatch) {
                        extractedSpecies.push(enhancedMatch);
                    }
                });
                
                if (extractedSpecies.length === 0) {
                    removeProgressIndicator(progressContainer);
                    showMessage('No valid species entries found in the input.', 'warning');
                    return;
                }
                
                // Process with custom fields
                showProcessingMessage('📋 Extracting custom fields from manual input...', 'info');
                updateProcessingStep(4);
                
                const enrichedSpecies = await extractCustomFields(extractedSpecies, progressContainer);
                
                showProcessingMessage('✅ Validating manual entries...', 'info');
                updateProcessingStep(5);
                
                const validatedSpecies = await validateExtractedData(enrichedSpecies, progressContainer);
                
                showProcessingMessage('🌊 Simulating verification...', 'info');
                updateProcessingStep(6);
                
                const verifiedSpecies = await simulateVerification(validatedSpecies, progressContainer);
                
                removeProgressIndicator(progressContainer);
                
                speciesData = verifiedSpecies;
                updateStats();
                
                showMessage(`Enhanced manual processing complete! Processed ${speciesData.length} entries with custom fields.`, 'success');
                populateEnhancedResults();
                
                setTimeout(() => {
                    const resultsTab = document.querySelector('[onclick="switchTab(\'results\')"]');
                    resultsTab.click();
                }, 500);
                
            } catch (error) {
                console.error('Error in enhanced manual processing:', error);
                showMessage('Error processing manual entries: ' + error.message, 'error');
            }
        }

        function extractEnhancedSpeciesFromLine(line, lineNumber) {
            // Enhanced patterns for manual input
            const patterns = [
                // Numbered entry with description
                /^(\d+)\.\s+([A-Z][a-z]+)\s+([a-z]+)\s*(?:\(([^)]+)\))?\s*(.*)$/,
                // Scientific name with author
                /^([A-Z][a-z]+)\s+([a-z]+)\s+\(([^)]+)\)\s*(.*)$/,
                // Simple scientific name
                /^([A-Z][a-z]+)\s+([a-z]+)\s*(.*)$/
            ];
            
            for (const pattern of patterns) {
                const match = line.match(pattern);
                if (match) {
                    const {author, year} = parseAuthorYear(match[4] || match[3] || 'Unknown');
                    
                    return {
                        number: match[1] ? parseInt(match[1]) : lineNumber,
                        genus: match[2] || match[1],
                        species: match[3] || match[2],
                        scientificName: `${match[2] || match[1]} ${match[3] || match[2]}`,
                        author: author,
                        year: year,
                        authorYear: match[4] || match[3] || 'Unknown',
                        pageNumber: 1,
                        extractionPattern: 'manual_enhanced',
                        context: match[5] || match[4] || line,
                        originalLine: line
                    };
                }
            }
            
            return null;
        }

        function loadEnhancedSamples() {
            const sampleText = `649. Eubranchus madapamensis (Rao, 1969)
Madapam Aeolid
Description: Body color translucent gray brown with brown-yellow, white, clear and dark spots and blotches. Size: To 0.5 in. Habitat: Intertidal and shallow subtidal, to at least 30 ft. Distribution: Indo-Pacific, from Tanzania to Hawai'i

650. Eubranchus steinbecki Behrens, 1987
Steinbeck's Aeolid  
Description: Irregular, nodular cerata; body color tan with dark olive-green mottling. Size: To 0.23 in. Habitat: Intertidal and on boat docks. Distribution: Palos Verdes and Mission Bay, California

651. Aeolidia loui Kienberger et al., 2016
Lou's Southern Aeolidia
Description: Body covered with numerous bristly cerata; white, with cream white patches on dorsum. Size: To about 1.2 in. Habitat: Intertidal and shallow subtidal. Distribution: Cape Arago, Oregon, to Punta Baja`;
            
            document.getElementById('manualSpeciesInput').value = sampleText;
            showMessage('Enhanced sample entries loaded with detailed descriptions for custom field extraction', 'info');
        }

        // Enhanced export functions
        function exportToCSV() {
            if (speciesData.length === 0) {
                showMessage('No data to export.', 'warning');
                return;
            }
            
            updateCustomFields();
            
            const coreHeaders = ['Scientific Name', 'Common Name', 'Author', 'Year', 'Page Number', 'Confidence', 'Status', 'Quality Score', 'Quality Flags'];
            const allHeaders = [...coreHeaders, ...customFields, 'Extraction Pattern', 'Context'];
            
            const csvContent = [
                allHeaders.join(','),
                ...speciesData.map(species => [
                    `"${species.scientificName || ''}"`,
                    `"${species.commonName || ''}"`,
                    `"${species.author || ''}"`,
                    `"${species.year || ''}"`,
                    `"${species.pageNumber || ''}"`,
                    `"${species.confidence || 0}"`,
                    `"${species.verificationStatus || ''}"`,
                    `"${species.validationScore || 0}"`,
                    `"${(species.qualityFlags || []).join('; ')}"`,
                    ...customFields.map(field => `"${(species[field] || '').replace(/"/g, '""')}"`),
                    `"${species.extractionPattern || ''}"`,
                    `"${(species.context || '').replace(/"/g, '""').substring(0, 200)}"` // Limit context length
                ].join(','))
            ].join('\n');
            
            downloadFile(csvContent, `marineid_enhanced_${speciesData.length}_species.csv`, 'text/csv');
            showMessage(`Exported ${speciesData.length} species with ${customFields.length} custom fields to CSV.`, 'success');
        }

        function exportToJSON() {
            if (speciesData.length === 0) {
                showMessage('No data to export.', 'warning');
                return;
            }
            
            updateCustomFields();
            
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    version: 'MarineID Pro Enhanced v2.0',
                    totalSpecies: speciesData.length,
                    customFields: customFields,
                    processingStats: processingStats,
                    enhancedFeatures: [
                        'Custom field extraction',
                        'Bilingual document support',
                        'Enhanced pattern recognition',
                        'Data quality scoring',
                        'Improved validation'
                    ],
                    developer: 'akorn environmental consulting, LLC',
                    contact: {
                        technical: 'aaron.kornbluth@gmail.com',
                        development: 'jakespencer6596@gmail.com'
                    }
                },
                species: speciesData
            };
            
            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, `marineid_enhanced_${speciesData.length}_species.json`, 'application/json');
            showMessage(`Exported ${speciesData.length} species with complete metadata and custom fields to JSON.`, 'success');
        }

        // Utility functions
        async function extractSampleText(pdf, maxPages = 5) {
            let sampleText = '';
            const pagesToCheck = Math.min(maxPages, pdf.numPages);
            
            for (let pageNum = 1; pageNum <= pagesToCheck; pageNum++) {
                try {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    sampleText += `\n=== PAGE ${pageNum} ===\n${pageText}`;
                } catch (pageError) {
                    console.warn(`Error processing sample page ${pageNum}:`, pageError);
                    continue;
                }
            }
            
            return sampleText;
        }

        function detectEnhancedFormat(sampleText) {
            // Enhanced format detection
            const formats = {
                fieldGuide: (sampleText.match(/\d{2,4}\.\s+[A-Z][a-z]+\s+[a-z]+/g) || []).length,
                bilingual: (sampleText.match(/Description:|Descripción:|Habitat:|Hábitat:/gi) || []).length,
                taxonomic: (sampleText.match(/[A-Z][a-z]+idae/g) || []).length,
                scientific: (sampleText.match(/[A-Z][a-z]+\s+[a-z]+\s+\([^)]*\d{4}\)/g) || []).length
            };
            
            const dominantFormat = Object.entries(formats).reduce((a, b) => formats[a[0]] > formats[b[0]] ? a : b);
            
            return {
                type: dominantFormat[0],
                confidence: dominantFormat[1] / 10, // Normalize confidence
                patterns: formats
            };
        }

        function parseAuthorYear(authorYearString) {
            if (!authorYearString || typeof authorYearString !== 'string') {
                return { author: 'Unknown', year: 'Unknown' };
            }
            
            const cleaned = authorYearString.trim();
            
            // Extract year (4 digits)
            const yearMatch = cleaned.match(/(\d{4})/);
            const year = yearMatch ? yearMatch[1] : 'Unknown';
            
            // Extract author (everything before the year, cleaned up)
            let author = cleaned;
            if (yearMatch) {
                author = cleaned.substring(0, cleaned.lastIndexOf(yearMatch[0])).trim();
                author = author.replace(/[,\s]+$/, '');
            }
            
            author = author.replace(/^\(/, '').replace(/\)$/, '');
            author = author.replace(/,$/, '');
            
            if (!author || author.length < 2) {
                author = 'Unknown';
            }
            
            return { author, year };
        }

        function extractContext(text, matchIndex, contextLength = 300) {
            const start = Math.max(0, matchIndex - contextLength);
            const end = Math.min(text.length, matchIndex + contextLength);
            return text.substring(start, end).trim();
        }

        function isValidSpecies(genus, species) {
            if (!genus || !species || typeof genus !== 'string' || typeof species !== 'string') return false;
            
            const g = genus.trim();
            const s = species.trim().split(' ')[0];
            
            if (g.length < 3 || g.length > 25 || s.length < 3 || s.length > 30) return false;
            if (!/^[A-Z][a-z]+$/.test(g)) return false;
            if (!/^[a-z]+$/.test(s)) return false;
            
            return true;
        }

        // Simulated verification
        async function simulateVerification(speciesList, progressContainer) {
            console.log('🌊 Starting enhanced verification simulation...');
            const verified = [];
            
            for (let i = 0; i < speciesList.length; i++) {
                const species = speciesList[i];
                
                // Enhanced verification logic based on data quality
                const qualityBonus = species.dataQuality === 'High' ? 0.2 : 
                                   species.dataQuality === 'Medium' ? 0.1 : 0;
                
                const random = Math.random() - qualityBonus; // Higher quality = better verification odds
                let verificationStatus, confidence;
                
                if (random > 0.8) {
                    verificationStatus = 'not_found';
                    confidence = Math.round(Math.random() * 40);
                } else if (random > 0.6) {
                    verificationStatus = 'synonym';
                    confidence = Math.round(60 + Math.random() * 30);
                } else {
                    verificationStatus = 'verified';
                    confidence = Math.round(75 + Math.random() * 25);
                }
                
                const verifiedSpecies = {
                    ...species,
                    verificationStatus: verificationStatus,
                    confidence: confidence,
                    verificationDate: new Date().toISOString(),
                    databases: {
                        worms: { status: verificationStatus, confidence: confidence },
                        gbif: { status: verificationStatus, confidence: confidence },
                        inaturalist: { status: verificationStatus, confidence: confidence },
                        obis: { status: verificationStatus, confidence: confidence }
                    }
                };
                
                verified.push(verifiedSpecies);
                
                if (i % 10 === 0) {
                    const progress = 85 + (i / speciesList.length) * 15;
                    updateProgress(progressContainer, progress, `Verification: ${i + 1}/${speciesList.length} species`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            console.log(`🌊 Enhanced verification complete: ${verified.length} species processed`);
            return verified;
        }

        async function retrySingleSpecies(index) {
            const species = speciesData[index];
            showMessage(`🔄 Retrying verification for ${species.scientificName}...`, 'info');
            
            const progressContainer = createProgressIndicator();
            const reVerified = await simulateVerification([species], progressContainer);
            
            speciesData[index] = reVerified[0];
            
            removeProgressIndicator(progressContainer);
            updateStats();
            populateEnhancedResults();
            
            showMessage(`🎉 Retry complete for ${species.scientificName}. New confidence: ${reVerified[0].confidence}%`, 'success');
        }

        function updateStats() {
            processingStats.totalSpecies = speciesData.length;
            processingStats.verified = speciesData.filter(s => s.verificationStatus === 'verified').length;
            processingStats.synonyms = speciesData.filter(s => s.verificationStatus === 'synonym').length;
            processingStats.notFound = speciesData.filter(s => s.verificationStatus === 'not_found' || s.verificationStatus === 'error').length;
        }

        function updateProcessingStep(stepNumber) {
            document.querySelectorAll('.step-card').forEach(card => {
                card.classList.remove('active');
                const stepNum = card.querySelector('.step-number');
                if (stepNum) stepNum.style.background = '#6c757d';
            });
            
            for (let i = 1; i <= stepNumber; i++) {
                const step = document.getElementById(`step${i}`);
                if (step) {
                    step.classList.add('active');
                    const stepNum = step.querySelector('.step-number');
                    if (stepNum) stepNum.style.background = 'var(--accent-color)';
                }
            }
        }

        function createProgressIndicator() {
            const container = document.createElement('div');
            container.className = 'progress-container';
            container.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Starting enhanced extraction...</div>
            `;
            document.getElementById('processingResults').appendChild(container);
            return container;
        }

        function updateProgress(container, percentage, text) {
            const fill = container?.querySelector('#progressFill');
            const textEl = container?.querySelector('#progressText');
            
            if (fill) fill.style.width = `${Math.min(percentage, 100)}%`;
            if (textEl) textEl.textContent = text;
        }

        function removeProgressIndicator(container) {
            if (container && container.parentNode) {
                container.parentNode.removeChild(container);
            }
        }

        function validateFile(file) {
            const maxSize = 1024 * 1024 * 1024; // 1GB
            if (file.size > maxSize) {
                showMessage('File too large. Maximum size is 1GB', 'error');
                return false;
            }

            if (file.type !== 'application/pdf') {
                showMessage('Please upload a PDF file only.', 'error');
                return false;
            }

            return true;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function resetAll() {
            speciesData = [];
            processingStats = {
                totalSpecies: 0,
                verified: 0,
                synonyms: 0,
                notFound: 0,
                processingTime: 0
            };
            
            document.getElementById('processingResults').innerHTML = '';
            document.getElementById('messages').innerHTML = '';
            document.getElementById('fileInput').value = '';
            
            document.querySelectorAll('.step-card').forEach(card => {
                card.classList.remove('active');
                const stepNum = card.querySelector('.step-number');
                if (stepNum) stepNum.style.background = '#6c757d';
            });
            
            populateEnhancedResults();
            showMessage('All data reset. Ready for enhanced extraction with custom fields.', 'info');
        }

        function showMessage(text, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 8000);
        }

        function showProcessingMessage(text, type = 'info') {
            showMessage(text, type);
        }

        // Selection management
        let selectedSpecies = new Set();

        function toggleSpeciesSelection(index) {
            if (selectedSpecies.has(index)) {
                selectedSpecies.delete(index);
            } else {
                selectedSpecies.add(index);
            }
            updateSelectionUI();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox.checked) {
                for (let i = 0; i < speciesData.length; i++) {
                    selectedSpecies.add(i);
                }
            } else {
                selectedSpecies.clear();
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            document.querySelectorAll(`input[onchange*="toggleSpeciesSelection"]`).forEach((checkbox, idx) => {
                checkbox.checked = selectedSpecies.has(idx);
            });
            
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedSpecies.size === speciesData.length && speciesData.length > 0;
                selectAllCheckbox.indeterminate = selectedSpecies.size > 0 && selectedSpecies.size < speciesData.length;
            }
        }

        // AI Assistant
        function sendAIMessage() {
            const input = document.getElementById('aiInput').value.trim();
            if (!input) {
                showMessage('Please enter a question for the AI assistant.', 'warning');
                return;
            }
            
            const responsesDiv = document.getElementById('aiResponses');
            const responseElement = document.createElement('div');
            responseElement.style.cssText = `
                background: #f0f8ff; 
                border: 1px solid #08306b; 
                border-radius: 6px; 
                padding: 10px; 
                margin-bottom: 10px; 
                font-size: 12px; 
                line-height: 1.4;
                color: #333;
            `;
            
            let aiResponse;
            const lowerInput = input.toLowerCase();
            
            if (lowerInput.includes('custom') || lowerInput.includes('field')) {
                aiResponse = `Custom fields allow you to extract specific information like habitat, size, distribution, or any field you define. The system searches for these fields in the document context around each species. You can add/remove custom fields in the configuration panel on the left.`;
            } else if (lowerInput.includes('quality') || lowerInput.includes('validation')) {
                aiResponse = `Data quality scoring evaluates extraction completeness and accuracy. High quality (80-100 points) indicates complete core and custom fields with good context. Medium (60-79) has some missing information. Low (<60) suggests incomplete extraction that may need manual review.`;
            } else if (lowerInput.includes('bilingual') || lowerInput.includes('spanish')) {
                aiResponse = `The enhanced system recognizes both English and Spanish field patterns. It looks for "Description/Descripción", "Habitat/Hábitat", "Distribution/Distribución", etc. This is especially useful for Latin American field guides and taxonomic papers.`;
            } else {
                aiResponse = `The enhanced MarineID Pro system features improved pattern recognition, custom field extraction, data quality scoring, and bilingual support. Your question "${input}" relates to the advanced capabilities for processing diverse marine taxonomic documents.`;
            }
            
            responseElement.innerHTML = `<strong>Q:</strong> ${input}<br><strong>AI:</strong> ${aiResponse}`;
            responsesDiv.appendChild(responseElement);
            
            document.getElementById('aiInput').value = '';
            responsesDiv.scrollTop = responsesDiv.scrollHeight;
        }
    </script>
</body>
</html>
