<div style="margin-top: 15px; display: flex; flex-direction: column; gap: 6px;">
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-color); opacity: 0.8;">
                                    <span>✅</span>
                                    <span>Accepts scientific & common names</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-color); opacity: 0.8;">
                                    <span>🔄</span>
                                    <span>Auto-resolves common to scientific names</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-color); opacity: 0.8;">
                                    <span>🌊</span>
                                    <span>Verifies against 4 marine databases</span>
                                </div>
                            </div><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarineID Pro - Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Orpheus+Pro:wght@400;700&family=Josefin+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* Theme styles */
        :root {
            --bg-color: #08306b;
            --text-color: #333;
            --card-bg: white;
            --border-color: #dee2e6;
            --accent-color: #08306b;
            --success-color: #209d5c;
            --warning-color: #ffc107;
            --error-color: #dc3545;
            --light-bg: #f8f9fa;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e9ecef;
            --card-bg: #2d3748;
            --border-color: #4a5568;
            --accent-color: #63b3ed;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --error-color: #f56565;
            --light-bg: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orpheus Pro', 'Georgia', serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .main-layout {
            display: flex;
            min-height: 100vh;
        }

        /* AI Assistant Panel */
        .ai-assistant {
            width: 350px;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .ai-body {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ai-intro {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border: 1px solid #08306b;
            border-radius: 8px;
            padding: 15px;
        }

        .ai-intro p {
            font-family: 'Josefin Sans', sans-serif;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
        }

        .ai-features {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .ai-features li {
            padding: 4px 0;
            font-family: 'Josefin Sans', sans-serif;
            font-size: 14px;
            color: #555;
            line-height: 1.3;
        }

        .ai-features li:before {
            content: "▶ ";
            color: #08306b;
            font-weight: bold;
            margin-right: 5px;
        }

        .ai-input-section {
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .ai-input-box {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .ai-send-button {
            width: 100%;
            background: linear-gradient(135deg, #209d5c, #1a7a47);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Josefin Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
        }

        .content-header {
            background: linear-gradient(135deg, var(--light-bg) 0%, var(--card-bg) 100%);
            border-bottom: 2px solid var(--border-color);
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-main {
            flex: 1;
        }

        .header-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .controls-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-btn, .lang-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-color);
            transition: all 0.2s;
        }

        .theme-btn.active, .lang-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.7;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            background: var(--card-bg);
            color: var(--accent-color);
            opacity: 1;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-color);
        }

        .tab-content {
            padding: 30px;
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* Upload section */
        .upload-section {
            background: var(--light-bg);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--accent-color);
            background: var(--card-bg);
        }

        /* Processing steps */
        .processing-steps {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .step-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #6c757d;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto 10px;
        }

        .step-card.active .step-number {
            background: var(--accent-color);
        }

        /* Results */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-title {
            font-size: 1.8rem;
            color: var(--text-color);
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .results-stats {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .stat-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .stat-verified {
            background: #d4edda;
            color: #155724;
        }

        .stat-synonyms {
            background: #fff3cd;
            color: #856404;
        }

        .stat-not-found {
            background: #f8d7da;
            color: #721c24;
        }

        /* Species cards */
        .species-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .species-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .species-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .species-card.verified {
            border-left: 4px solid #28a745;
        }

        .species-card.synonym {
            border-left: 4px solid #ffc107;
        }

        .species-card.not-found {
            border-left: 4px solid #dc3545;
        }

        .species-header {
            margin-bottom: 15px;
        }

        .species-name {
            font-style: italic;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .common-names {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-verified {
            background: #28a745;
            color: white;
        }

        .status-synonym {
            background: #ffc107;
            color: #212529;
        }

        .status-not-found {
            background: #dc3545;
            color: white;
        }

        /* Species details */
        .species-details {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .detail-grid {
            display: grid;
            gap: 8px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: start;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-color);
            white-space: nowrap;
        }

        .detail-value {
            color: var(--text-color);
            opacity: 0.8;
        }

        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 0.95rem;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        /* Progress indicator */
        .progress-container {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 14px;
            color: var(--text-color);
            margin-top: 10px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }

            .ai-assistant {
                width: 100%;
                order: 2;
            }

            .species-grid {
                grid-template-columns: 1fr;
            }

            .processing-steps {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- AI Assistant Panel -->
        <div class="ai-assistant">
            <div class="ai-body">
                <div class="ai-intro">
                    <p><strong>🤖 MarineID AI Assistant</strong></p>
                    <ul class="ai-features">
                        <li>Help with PDF processing questions</li>
                        <li>Explain WoRMS verification results</li>
                        <li>Suggest fixes for unverified species</li>
                        <li>Generate species reports</li>
                        <li>Provide taxonomic guidance</li>
                        <li>Export data in various formats</li>
                        <li>Compare database matches</li>
                        <li>Improve OCR accuracy tips</li>
                    </ul>
                </div>
                <div class="ai-input-section">
                    <textarea class="ai-input-box" id="aiInput" placeholder="Ask about PDF processing, species extraction, or any technical questions..."></textarea>
                    <button class="ai-send-button" onclick="sendAIMessage()">Ask AI Helper</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <div class="header-main">
                    <h1 style="font-family: 'Orpheus Pro', serif; font-size: 28px; color: var(--text-color); margin-bottom: 5px; font-weight: 700;">🐚 MarineID Pro</h1>
                    <p style="font-family: 'Josefin Sans', sans-serif; color: var(--text-color); opacity: 0.7; font-size: 16px; font-weight: 400; margin-bottom: 10px;">
                        Advanced AI-powered marine species identification and verification system
                    </p>
                    <p style="font-family: 'Josefin Sans', sans-serif; color: var(--text-color); opacity: 0.8; font-size: 14px; line-height: 1.4; max-width: 600px;">
                        Leverages cutting-edge OCR technology, natural language processing, and real-time access to four authoritative marine databases (WoRMS, GBIF, iNaturalist, OBIS) to extract, identify, and verify marine species from field guides and research documents with unprecedented accuracy and speed.
                    </p>
                </div>
                <div class="header-controls">
                    <div class="controls-row">
                        <div class="theme-selector">
                            <span style="font-size: 12px; margin-right: 8px;">Theme:</span>
                            <button class="theme-btn active" onclick="setTheme('system')" data-theme="system">System</button>
                            <button class="theme-btn" onclick="setTheme('light')" data-theme="light">Light</button>
                            <button class="theme-btn" onclick="setTheme('dark')" data-theme="dark">Dark</button>
                        </div>
                    </div>
                    <div class="controls-row">
                        <div style="display: flex; gap: 5px;">
                            <button class="lang-btn active" onclick="setLanguage('en')" data-lang="en">English</button>
                            <button class="lang-btn" onclick="setLanguage('es')" data-lang="es">Español</button>
                            <button class="lang-btn" onclick="setLanguage('fr')" data-lang="fr">Français</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('upload')">📄 Upload & Extract</button>
                <button class="tab" onclick="switchTab('results')">📊 Results & Verification</button>
                <button class="tab" onclick="switchTab('analytics')">📈 Analytics</button>
                <button class="tab" onclick="switchTab('help')" style="margin-left: auto;">❓ Help</button>
            </div>

            <!-- Upload Tab Content -->
            <div class="tab-content active" id="upload-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- PDF Upload Section -->
                    <div class="upload-section" id="uploadSection" 
                         ondragover="handleDragOver(event)" 
                         ondragleave="handleDragLeave(event)" 
                         ondrop="handleDrop(event)"
                         onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3rem; margin-bottom: 15px;">📄</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--text-color); margin-bottom: 8px;">Upload Marine Field Guide PDF</div>
                        <div style="color: var(--text-color); opacity: 0.7; margin-bottom: 20px;">Drag and drop your PDF here, or click to browse</div>
                        <button style="background: var(--accent-color); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer;">
                            Choose PDF File
                        </button>
                        <input type="file" id="fileInput" style="display: none;" accept=".pdf" onchange="handleFileUpload(event)">
                        <div style="margin-top: 15px; font-size: 0.9rem; color: var(--text-color); opacity: 0.6;">
                            Maximum file size: 1GB • Files stored securely in Google Drive
                        </div>
                    </div>

                    <!-- Manual Species Entry Section -->
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div style="font-size: 2rem;">🔍</div>
                            <div>
                                <h3 style="margin: 0; color: var(--text-color);">Manual Species Lookup</h3>
                                <p style="margin: 5px 0 0 0; color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Enter species names (scientific and/or common names) to verify against marine databases</p>
                            </div>
                        </div>
                        
                        <div>
                            <textarea id="manualSpeciesInput" style="width: 100%; height: 100px; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; font-size: 14px; background: var(--card-bg); color: var(--text-color); resize: vertical;"
                                      placeholder="Enter species name(s) here, one per line or separated by commas"></textarea>
                            
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button onclick="processManualSpecies()" style="background: var(--accent-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 14px;">
                                    🔍 Verify Species
                                </button>
                                <button onclick="clearManualInput()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 14px;">
                                    🗑️ Clear
                                </button>
                                <button onclick="loadSampleSpecies()" style="background: var(--success-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 14px;">
                                    📋 Examples
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Steps -->
                <div style="display: flex; align-items: center; margin: 30px 0;">
                    <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                    <span style="padding: 0 20px; color: var(--text-color); font-weight: 600; opacity: 0.7;">PROCESSING WORKFLOW</span>
                    <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                </div>

                <div class="processing-steps">
                    <div class="step-card" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-title">Input Processing</div>
                        <div class="step-description">Process PDF or manual species entries</div>
                    </div>
                    <div class="step-card" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-title">Species Parsing</div>
                        <div class="step-description">Extract and validate species names</div>
                    </div>
                    <div class="step-card" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-title">Name Resolution</div>
                        <div class="step-description">Resolve common names to scientific names</div>
                    </div>
                    <div class="step-card" id="step4">
                        <div class="step-number">4</div>
                        <div class="step-title">Database Verification</div>
                        <div class="step-description">Verify against WoRMS, GBIF, iNaturalist & OBIS</div>
                    </div>
                    <div class="step-card" id="step5">
                        <div class="step-number">5</div>
                        <div class="step-title">Results Analysis</div>
                        <div class="step-description">Analyze verification results and confidence</div>
                    </div>
                </div>

                <div id="processingResults">
                    <!-- Processing messages will appear here -->
                </div>
            </div>

            <!-- Results Tab Content -->
            <div class="tab-content" id="results-content">
                <div class="results-header">
                    <div class="results-title">Species Extraction Results</div>
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="setView('cards')">📋 Cards</button>
                        <button class="view-btn" onclick="setView('table')">📊 Table</button>
                    </div>
                </div>
                
                <div class="results-stats" id="resultsStats">
                    <span class="stat-badge stat-verified" id="extractedCount">0 Extracted</span>
                    <span class="stat-badge stat-synonyms" id="withDataCount">0 With Data</span>
                    <span class="stat-badge stat-not-found" id="incompleteCount">0 Incomplete</span>
                </div>
                
                <!-- Cards View -->
                <div class="species-grid" id="speciesGrid">
                    <!-- Species cards will be populated here -->
                </div>

                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                    <button onclick="exportToCSV()" style="background: var(--success-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">📊 Export CSV</button>
                    <button onclick="exportToJSON()" style="background: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">📋 Export JSON</button>
                    <button onclick="generateReport()" style="background: var(--warning-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">📄 Generate Report</button>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-content" id="analytics-content">
                <h2>Extraction Analytics</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--accent-color); font-weight: bold;" id="totalExtracted">0</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Total Species</div>
                    </div>
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--success-color); font-weight: bold;" id="phylaCount">0</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Phyla Found</div>
                    </div>
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: #17a2b8; font-weight: bold;" id="pagesProcessed">0</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Pages Processed</div>
                    </div>
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--warning-color); font-weight: bold;" id="extractionRate">0%</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Success Rate</div>
                    </div>
                </div>

                <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--text-color);">📊 Processing Summary</h3>
                    <div id="processingSummary">
                        <p>Upload a PDF to see processing analytics</p>
                    </div>
                </div>
            </div>

            <!-- Help Tab -->
            <div class="tab-content" id="help-content">
                <h2>User Guide & Documentation</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- Quick Start -->
                    <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                        <h3>🚀 Quick Start</h3>
                        <ol style="margin: 15px 0; padding-left: 20px; line-height: 1.6;">
                            <li><strong>Upload PDF:</strong> Drag and drop a marine field guide or species list PDF</li>
                            <li><strong>Wait for Processing:</strong> OCR extracts text and AI parses species names</li>
                            <li><strong>Review Results:</strong> Check verification results in the Results tab</li>
                            <li><strong>Export Data:</strong> Download CSV or generate reports for analysis</li>
                        </ol>
                    </div>

                    <!-- Common Issues -->
                    <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                        <h3>⚠️ Common Issues</h3>
                        <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.6;">
                            <li><strong>Species Not Found:</strong> Check spelling, try common names, or verify it's a marine species</li>
                            <li><strong>Low Confidence:</strong> May indicate taxonomic uncertainty or data quality issues</li>
                            <li><strong>PDF Processing Slow:</strong> Large files (>100MB) may take several minutes</li>
                            <li><strong>Missing Species:</strong> OCR may miss faint text or unusual formatting</li>
                        </ul>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- Databases -->
                    <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                        <h3>🗄️ Databases Used</h3>
                        <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.6;">
                            <li><strong>WoRMS:</strong> World Register of Marine Species (authoritative taxonomy)</li>
                            <li><strong>GBIF:</strong> Global Biodiversity Information Facility (occurrence data)</li>
                            <li><strong>iNaturalist:</strong> Citizen science observations and photos</li>
                            <li><strong>OBIS:</strong> Ocean Biodiversity Information System (marine-specific data)</li>
                        </ul>
                    </div>

                    <!-- Best Practices -->
                    <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                        <h3>✅ Best Practices</h3>
                        <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.6;">
                            <li><strong>File Quality:</strong> Use high-resolution PDFs with clear text</li>
                            <li><strong>Manual Review:</strong> Always verify results against authoritative sources</li>
                            <li><strong>Data Export:</strong> Export results before closing browser</li>
                            <li><strong>Large Files:</strong> Split very large PDFs for faster processing</li>
                        </ul>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- Standardized Units -->
                    <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                        <h3>📏 Standardized Units</h3>
                        <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.6;">
                            <li><strong>Size:</strong> Converted to meters (m) for length, kilograms (kg) for weight</li>
                            <li><strong>Depth:</strong> Converted to meters (m) below sea level</li>
                            <li><strong>Temperature:</strong> Converted to Celsius (°C)</li>
                            <li><strong>Original values:</strong> Always displayed alongside standardized units</li>
                        </ul>
                    </div>

                    <!-- Data Interpretation -->
                    <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                        <h3>📊 Data Interpretation</h3>
                        <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.6;">
                            <li><strong>Verified (Green):</strong> Found in primary databases with high confidence</li>
                            <li><strong>Synonym (Yellow):</strong> Valid name but may have taxonomic synonyms</li>
                            <li><strong>Not Found (Red):</strong> Not located in marine databases - check spelling</li>
                            <li><strong>Confidence %:</strong> Based on database matches and data quality</li>
                        </ul>
                    </div>
                </div>

                <!-- Screenshots Section -->
                <div style="background: var(--light-bg); padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                    <h3>📸 Tool Screenshots</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                        <div style="text-align: center;">
                            <div style="background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 8px; padding: 20px; min-height: 150px; display: flex; align-items: center; justify-content: center; color: var(--text-color); opacity: 0.7;">
                                <div>
                                    <div style="font-size: 2rem; margin-bottom: 10px;">📊</div>
                                    <div style="font-size: 14px;">Results Dashboard</div>
                                    <div style="font-size: 12px; margin-top: 5px;">Species verification with confidence scores</div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 8px; padding: 20px; min-height: 150px; display: flex; align-items: center; justify-content: center; color: var(--text-color); opacity: 0.7;">
                                <div>
                                    <div style="font-size: 2rem; margin-bottom: 10px;">📈</div>
                                    <div style="font-size: 14px;">Analytics View</div>
                                    <div style="font-size: 12px; margin-top: 5px;">Database coverage and success metrics</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-color); opacity: 0.8; text-align: center; margin-top: 10px;">
                        <em>Note: Screenshots will be added in the next version update</em>
                    </p>
                </div>

                <!-- Video Tutorial -->
                <div style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%); border: 1px solid #b3d9ff; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">🎥 Video Tutorial</h3>
                    <div style="text-align: center; padding: 40px; background: var(--card-bg); border-radius: 8px; border: 2px dashed var(--border-color);">
                        <div style="font-size: 3rem; margin-bottom: 15px;">🎬</div>
                        <h4 style="margin-bottom: 10px; color: var(--text-color);">Complete Walkthrough</h4>
                        <p style="color: var(--text-color); opacity: 0.7; margin-bottom: 15px;">
                            5-minute video showing PDF upload, species verification, and data export
                        </p>
                        <button onclick="alert('Video tutorial coming soon!')" style="background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            📺 Watch Tutorial (Coming Soon)
                        </button>
                    </div>
                </div>

                <!-- Contact Support -->
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%); border: 1px solid #2196f3; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">📧 Need Help?</h3>
                    <p style="margin-bottom: 15px; line-height: 1.6;">
                        Having issues or questions about the Marine Species Analyzer? Our team is here to help!
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="margin-bottom: 10px;">🔬 Technical Support</h4>
                            <button onclick="sendSupportEmail('technical')" style="background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%;">
                                Email Aaron Kornbluth
                            </button>
                            <p style="font-size: 0.9rem; margin-top: 8px; opacity: 0.8;">Marine biology expertise, tool functionality</p>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 10px;">💻 Development Support</h4>
                            <button onclick="sendSupportEmail('development')" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%;">
                                Email Jake Spencer
                            </button>
                            <p style="font-size: 0.9rem; margin-top: 8px; opacity: 0.8;">Bug reports, feature requests</p>
                        </div>
                    </div>
                </div>

                <!-- Keyboard Shortcuts -->
                <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                    <h3>⌨️ Keyboard Shortcuts</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                        <div>
                            <ul style="list-style: none; padding: 0; line-height: 1.8;">
                                <li><kbd style="background: var(--card-bg); padding: 2px 6px; border: 1px solid var(--border-color); border-radius: 3px;">Ctrl/Cmd + U</kbd> - Upload Tab</li>
                                <li><kbd style="background: var(--card-bg); padding: 2px 6px; border: 1px solid var(--border-color); border-radius: 3px;">Ctrl/Cmd + R</kbd> - Results Tab</li>
                                <li><kbd style="background: var(--card-bg); padding: 2px 6px; border: 1px solid var(--border-color); border-radius: 3px;">Ctrl/Cmd + A</kbd> - Analytics Tab</li>
                            </ul>
                        </div>
                        <div>
                            <ul style="list-style: none; padding: 0; line-height: 1.8;">
                                <li><kbd style="background: var(--card-bg); padding: 2px 6px; border: 1px solid var(--border-color); border-radius: 3px;">Ctrl/Cmd + E</kbd> - Export CSV</li>
                                <li><kbd style="background: var(--card-bg); padding: 2px 6px; border: 1px solid var(--border-color); border-radius: 3px;">Ctrl/Cmd + G</kbd> - Generate Report</li>
                                <li><kbd style="background: var(--card-bg); padding: 2px 6px; border: 1px solid var(--border-color); border-radius: 3px;">Ctrl/Cmd + H</kbd> - Help Tab</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Language Selection Modal -->
    <div id="languageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; animation: fadeIn 0.3s ease;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); border-radius: 15px; padding: 40px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div>
                <h2 style="color: var(--accent-color); margin-bottom: 10px; font-size: 1.8rem; font-family: 'Orpheus Pro', serif;">🌍 Welcome / Bienvenido / Bienvenue</h2>
                <p style="color: var(--text-color); margin-bottom: 30px; opacity: 0.8; font-family: 'Josefin Sans', sans-serif;">Please select your preferred language / Seleccione su idioma / Sélectionnez votre langue</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                <div class="language-option selected" onclick="selectLanguage('en')" data-lang="en" style="background: var(--light-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 20px 10px; cursor: pointer; transition: all 0.3s ease; text-align: center;">
                    <span style="font-size: 2rem; margin-bottom: 8px; display: block;">🇺🇸</span>
                    <div style="font-weight: 600; font-size: 14px; font-family: 'Josefin Sans', sans-serif;">English</div>
                </div>
                <div class="language-option" onclick="selectLanguage('es')" data-lang="es" style="background: var(--light-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 20px 10px; cursor: pointer; transition: all 0.3s ease; text-align: center;">
                    <span style="font-size: 2rem; margin-bottom: 8px; display: block;">🇪🇸</span>
                    <div style="font-weight: 600; font-size: 14px; font-family: 'Josefin Sans', sans-serif;">Español</div>
                </div>
                <div class="language-option" onclick="selectLanguage('fr')" data-lang="fr" style="background: var(--light-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 20px 10px; cursor: pointer; transition: all 0.3s ease; text-align: center;">
                    <span style="font-size: 2rem; margin-bottom: 8px; display: block;">🇫🇷</span>
                    <div style="font-weight: 600; font-size: 14px; font-family: 'Josefin Sans', sans-serif;">Français</div>
                </div>
            </div>
            <button onclick="confirmLanguageSelection()" style="background: var(--success-color); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; min-width: 120px; font-family: 'Josefin Sans', sans-serif;">Continue / Continuar / Continuer</button>
        </div>
    </div>

    <!-- Legal Disclaimer Modal -->
    <div id="legalModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10004; animation: fadeIn 0.3s ease;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); border-radius: 15px; padding: 30px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <h3 style="color: var(--accent-color); margin-bottom: 20px; text-align: center; font-family: 'Orpheus Pro', serif;">⚖️ MarineID Pro - Terms of Use & User Registration</h3>
            
            <!-- User Registration Form -->
            <div style="margin-bottom: 30px;">
                <h4 style="color: var(--accent-color); margin-bottom: 15px; font-family: 'Josefin Sans', sans-serif;">📋 User Information</h4>
                <p style="margin-bottom: 15px; font-size: 14px; opacity: 0.8; font-family: 'Josefin Sans', sans-serif;">Please provide your information to access MarineID Pro. This helps us improve the tool and provide support.</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-family: 'Josefin Sans', sans-serif;">First Name *</label>
                        <input type="text" id="firstName" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-family: inherit;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-family: 'Josefin Sans', sans-serif;">Last Name *</label>
                        <input type="text" id="lastName" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-family: inherit;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-family: 'Josefin Sans', sans-serif;">Email Address *</label>
                        <input type="email" id="userEmail" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-family: inherit;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-family: 'Josefin Sans', sans-serif;">Organization *</label>
                        <input type="text" id="organization" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-family: inherit;">
                    </div>
                </div>
                
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; font-family: 'Josefin Sans', sans-serif;">Role/Position *</label>
                    <select id="userRole" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-family: inherit;">
                        <option value="">Select your role</option>
                        <option value="researcher">Researcher/Scientist</option>
                        <option value="student">Student</option>
                        <option value="educator">Educator/Professor</option>
                        <option value="consultant">Environmental Consultant</option>
                        <option value="government">Government Agency</option>
                        <option value="ngo">NGO/Non-profit</option>
                        <option value="industry">Industry Professional</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Legal Terms -->
            <div style="font-size: 0.9rem; line-height: 1.6; font-family: 'Josefin Sans', sans-serif;">
                <p><strong>By proceeding, you acknowledge and agree to:</strong></p>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li><strong>File Handling:</strong> PDFs are uploaded to Google Drive, processed, and automatically deleted after 30 days</li>
                    <li><strong>Research Tool:</strong> Results are for research/educational use only - verify with authoritative sources</li>
                    <li><strong>No Warranty:</strong> Tool provided "as is" - users responsible for validating outputs</li>
                    <li><strong>Copyright:</strong> Users must own or have rights to upload PDFs</li>
                    <li><strong>Large Files:</strong> 1GB max upload - processing may take several minutes</li>
                </ul>
                <p style="margin-top: 20px;"><strong>Clicking "I Agree & Continue" confirms you accept these terms and our data handling practices.</strong></p>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                <button onclick="acceptLegalTermsWithRegistration()" style="padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; min-width: 120px; background: var(--success-color); color: white; font-family: 'Josefin Sans', sans-serif;">I Agree & Continue</button>
                <button onclick="declineLegalTerms()" style="padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; min-width: 120px; background: #6c757d; color: white; font-family: 'Josefin Sans', sans-serif;">Decline</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div style="background: var(--light-bg); border-top: 1px solid var(--border-color); padding: 20px; margin-top: 40px; text-align: center; font-size: 0.9rem; color: var(--text-color); opacity: 0.8;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <a href="https://akornenvironmental.com/privacy" target="_blank" style="color: var(--accent-color); text-decoration: none; margin: 0 10px;">Privacy Policy</a>
            <a href="https://akornenvironmental.com/terms" target="_blank" style="color: var(--accent-color); text-decoration: none; margin: 0 10px;">Terms of Service</a>
            <a href="mailto:aaron.kornbluth@gmail.com" style="color: var(--accent-color); text-decoration: none; margin: 0 10px;">Contact</a>
            <a href="#" onclick="alert('Legal disclaimer content would be shown here')" style="color: var(--accent-color); text-decoration: none; margin: 0 10px;">Legal Disclaimer</a>
        </div>
    </div>

    <!-- Load PDF.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Global variables
        let speciesData = [];
        let currentLanguage = 'en';
        let currentView = 'cards';
        let processingStats = {
            totalPages: 0,
            speciesFound: 0,
            phylaFound: new Set(),
            processedSize: 0
        };

        // Enhanced species extraction patterns
        const SPECIES_PATTERNS = {
            // Numbered species entries (e.g., "1. Craniella arb (de Laubenfels, 1930)")
            numbered: /^(\d+)\.\s+([A-Z][a-z]+\s+[a-z]+(?:\s+[a-z]+)*)\s*(?:\([^)]+\))?/gm,
            
            // Scientific names in taxonomic context
            scientific: /([A-Z][a-z]+)\s+([a-z]+(?:\s+[a-z]+)*)\s+([A-Z][^,\n]*,?\s*\d{4})/g,
            
            // Family/Class headers
            family: /(Phylum|Class|Order|Family|Subfamily)\s+([A-Z][A-Za-z]+)/g,
            
            // Common name patterns
            commonName: /^([A-Z][A-Za-z\s]+(?:Sponge|Crab|Star|Urchin|Anemone|Coral|Worm|Clam|Snail|Slug))/gm,
            
            // Size information
            size: /Size:\s*([^\.]+)/gi,
            
            // Habitat information
            habitat: /Habitat:\s*([^\.]+)/gi,
            
            // Distribution information
            distribution: /Distribution:\s*([^\.]+)/gi,
            
            // Description
            description: /Description:\s*([^\.]+)/gi
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            checkLanguageAndLegalAcceptance();
            console.log('MarineID Pro initialized with PDF.js support');
        });

        function initializeTheme() {
            const savedTheme = localStorage.getItem('msa_theme') || 'system';
            setTheme(savedTheme);
        }

        function checkLanguageAndLegalAcceptance() {
            const languageSelected = localStorage.getItem('msa_language_selected');
            const legalAccepted = localStorage.getItem('msa_legal_accepted');
            
            if (!languageSelected) {
                showLanguageSelection();
            } else if (!legalAccepted) {
                showLegalModal();
            } else {
                initializeApp();
            }
        }

        function showLanguageSelection() {
            document.getElementById('languageModal').style.display = 'block';
        }

        function selectLanguage(lang) {
            // Update selected language option
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('selected');
                option.style.borderColor = 'var(--border-color)';
                option.style.background = 'var(--light-bg)';
            });
            const selected = document.querySelector(`[data-lang="${lang}"]`);
            selected.classList.add('selected');
            selected.style.borderColor = 'var(--accent-color)';
            selected.style.background = 'var(--accent-color)';
            selected.style.color = 'white';
            
            // Store selection temporarily
            window.selectedLanguage = lang;
        }

        function confirmLanguageSelection() {
            const selectedLang = window.selectedLanguage || 'en';
            localStorage.setItem('msa_language_selected', 'true');
            localStorage.setItem('msa_current_language', selectedLang);
            
            // Set the language
            setLanguage(selectedLang);
            
            // Hide language modal and show legal modal
            document.getElementById('languageModal').style.display = 'none';
            showLegalModal();
        }

        function showLegalModal() {
            document.getElementById('legalModal').style.display = 'block';
        }

        function acceptLegalTermsWithRegistration() {
            // Simple validation
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const organization = document.getElementById('organization').value.trim();
            const role = document.getElementById('userRole').value;
            
            if (!firstName || !lastName || !email || !organization || !role) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Store acceptance and user info
            localStorage.setItem('msa_legal_accepted', 'true');
            localStorage.setItem('msa_legal_date', new Date().toISOString());
            
            document.getElementById('legalModal').style.display = 'none';
            initializeApp();
        }

        function declineLegalTerms() {
            alert('You must accept the terms to use this tool.');
            window.location.href = 'https://akornenvironmental.com';
        }

        function initializeApp() {
            console.log('MarineID Pro application ready');
        }

        function setTheme(theme) {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const themeBtn = document.querySelector(`[data-theme="${theme}"]`);
            if (themeBtn) themeBtn.classList.add('active');
            
            if (theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            
            localStorage.setItem('msa_theme', theme);
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const langBtn = document.querySelector(`.lang-btn[data-lang="${lang}"]`);
            if (langBtn) langBtn.classList.add('active');
            localStorage.setItem('msa_current_language', lang);
        }

        // Tab navigation
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            const selectedTab = document.getElementById(`${tabName}-content`);
            selectedTab.classList.add('active');
            selectedTab.style.display = 'block';
        }

        // File upload handlers
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = 'var(--accent-color)';
            event.currentTarget.style.background = 'var(--card-bg)';
        }

        function handleDragLeave(event) {
            event.currentTarget.style.borderColor = 'var(--border-color)';
            event.currentTarget.style.background = 'var(--light-bg)';
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = 'var(--border-color)';
            event.currentTarget.style.background = 'var(--light-bg)';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // Enhanced PDF processing
        async function processFile(file) {
            if (!validateFile(file)) return;

            try {
                showProcessingMessage('🚀 Starting enhanced PDF processing...', 'info');
                updateProcessingStep(1);
                
                const fileSizeMB = Math.round(file.size / (1024 * 1024));
                if (fileSizeMB > 100) {
                    showProcessingMessage(`📄 Processing large PDF (${fileSizeMB}MB)... This may take several minutes.`, 'info');
                }
                
                await processPDFWithExtraction(file);
                
            } catch (error) {
                console.error('Error processing file:', error);
                showMessage('Error processing PDF: ' + error.message, 'error');
            }
        }

        async function processPDFWithExtraction(file) {
            try {
                // Step 1: Load PDF
                showProcessingMessage('📄 Loading PDF with PDF.js...', 'info');
                updateProcessingStep(1);
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                processingStats.totalPages = pdf.numPages;
                showProcessingMessage(`📖 PDF loaded: ${pdf.numPages} pages`, 'info');
                
                // Step 2: Extract text from all pages
                showProcessingMessage('🔍 Extracting text from all pages...', 'info');
                updateProcessingStep(2);
                
                let fullText = '';
                const progressContainer = createProgressIndicator();
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += `\n--- PAGE ${i} ---\n${pageText}`;
                    
                    // Update progress
                    const progress = (i / pdf.numPages) * 100;
                    updateProgress(progressContainer, progress, `Processing page ${i} of ${pdf.numPages}`);
                    
                    // Brief pause to prevent blocking
                    if (i % 10 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                removeProgressIndicator(progressContainer);
                
                // Step 3: Parse species
                showProcessingMessage('🧬 Parsing species with advanced patterns...', 'info');
                updateProcessingStep(3);
                
                const extractedSpecies = await extractSpeciesFromText(fullText);
                
                // Step 4: Extract additional data
                showProcessingMessage('📊 Extracting size, habitat, and distribution data...', 'info');
                updateProcessingStep(4);
                
                const enrichedSpecies = await enrichSpeciesData(extractedSpecies, fullText);
                
                // Step 5: Process results
                showProcessingMessage('✅ Processing and organizing results...', 'info');
                updateProcessingStep(5);
                
                speciesData = enrichedSpecies;
                processingStats.speciesFound = speciesData.length;
                
                showMessage(`🎉 Processing complete! Extracted ${speciesData.length} species from ${pdf.numPages} pages.`, 'success');
                
                populateResults();
                updateAnalytics();
                
                // Switch to results tab
                setTimeout(() => {
                    const resultsTab = document.querySelector('[onclick="switchTab(\'results\')"]');
                    resultsTab.click();
                }, 1000);
                
            } catch (error) {
                console.error('Error in processPDFWithExtraction:', error);
                showMessage('Error processing PDF: ' + error.message, 'error');
            }
        }

        function createProgressIndicator() {
            const container = document.createElement('div');
            container.className = 'progress-container';
            container.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Starting...</div>
            `;
            document.getElementById('processingResults').appendChild(container);
            return container;
        }

        function updateProgress(container, percentage, text) {
            const fill = container.querySelector('#progressFill');
            const textEl = container.querySelector('#progressText');
            fill.style.width = `${percentage}%`;
            textEl.textContent = text;
        }

        function removeProgressIndicator(container) {
            if (container && container.parentNode) {
                container.parentNode.removeChild(container);
            }
        }

        async function extractSpeciesFromText(text) {
            const species = [];
            const seenNames = new Set();
            
            // Extract numbered species entries
            const numberedMatches = [...text.matchAll(SPECIES_PATTERNS.numbered)];
            console.log(`Found ${numberedMatches.length} numbered species entries`);
            
            numberedMatches.forEach(match => {
                const [fullMatch, number, scientificName] = match;
                const normalizedName = scientificName.trim();
                
                if (!seenNames.has(normalizedName)) {
                    seenNames.add(normalizedName);
                    const nameParts = normalizedName.split(' ');
                    
                    species.push({
                        number: parseInt(number),
                        scientificName: normalizedName,
                        genus: nameParts[0],
                        species: nameParts.slice(1).join(' '),
                        commonNames: [],
                        fullMatch: fullMatch,
                        extractionMethod: 'numbered',
                        sourceText: text.substring(match.index, match.index + 500).trim()
                    });
                }
            });
            
            // Extract scientific names with authors
            const scientificMatches = [...text.matchAll(SPECIES_PATTERNS.scientific)];
            console.log(`Found ${scientificMatches.length} scientific name matches`);
            
            scientificMatches.forEach(match => {
                const [fullMatch, genus, speciesName, author] = match;
                const scientificName = `${genus} ${speciesName}`;
                
                if (!seenNames.has(scientificName)) {
                    seenNames.add(scientificName);
                    
                    species.push({
                        scientificName: scientificName,
                        genus: genus,
                        species: speciesName,
                        author: author.trim(),
                        commonNames: [],
                        fullMatch: fullMatch,
                        extractionMethod: 'scientific',
                        sourceText: text.substring(match.index, match.index + 500).trim()
                    });
                }
            });
            
            return species;
        }

        async function enrichSpeciesData(species, fullText) {
            console.log(`Enriching data for ${species.length} species...`);
            
            return species.map(sp => {
                // Extract size information
                const sizeRegex = new RegExp(`${sp.scientificName}[\\s\\S]{0,500}Size:\\s*([^\\n\\.]+)`, 'i');
                const sizeMatch = fullText.match(sizeRegex);
                
                // Extract habitat information
                const habitatRegex = new RegExp(`${sp.scientificName}[\\s\\S]{0,500}Habitat:\\s*([^\\n\\.]+)`, 'i');
                const habitatMatch = fullText.match(habitatRegex);
                
                // Extract distribution information
                const distributionRegex = new RegExp(`${sp.scientificName}[\\s\\S]{0,500}Distribution:\\s*([^\\n\\.]+)`, 'i');
                const distributionMatch = fullText.match(distributionRegex);
                
                // Extract description
                const descriptionRegex = new RegExp(`${sp.scientificName}[\\s\\S]{0,500}Description:\\s*([^\\n\\.]+)`, 'i');
                const descriptionMatch = fullText.match(descriptionRegex);
                
                // Extract common name (look for text immediately after scientific name)
                const commonNameRegex = new RegExp(`${sp.scientificName}[\\s\\n]*([A-Z][A-Za-z\\s-]+(?:Sponge|Crab|Star|Urchin|Anemone|Coral|Worm|Clam|Snail|Slug|Fish))`, 'i');
                const commonNameMatch = fullText.match(commonNameRegex);
                
                return {
                    ...sp,
                    size: sizeMatch ? sizeMatch[1].trim() : '',
                    habitat: habitatMatch ? habitatMatch[1].trim() : '',
                    distribution: distributionMatch ? distributionMatch[1].trim() : '',
                    description: descriptionMatch ? descriptionMatch[1].trim() : '',
                    commonNames: commonNameMatch ? [commonNameMatch[1].trim()] : [],
                    hasAdditionalData: !!(sizeMatch || habitatMatch || distributionMatch || descriptionMatch),
                    extractedAt: new Date().toISOString()
                };
            });
        }

        function validateFile(file) {
            const maxSize = 1024 * 1024 * 1024; // 1GB
            if (file.size > maxSize) {
                showMessage('File too large. Maximum size is 1GB', 'error');
                return false;
            }

            if (file.type !== 'application/pdf') {
                showMessage('Please upload a PDF file only.', 'error');
                return false;
            }

            return true;
        }

        function updateProcessingStep(stepNumber) {
            document.querySelectorAll('.step-card').forEach(card => {
                card.classList.remove('active');
                const stepNum = card.querySelector('.step-number');
                if (stepNum) {
                    stepNum.style.background = '#6c757d';
                }
            });
            
            for (let i = 1; i <= stepNumber; i++) {
                const step = document.getElementById(`step${i}`);
                if (step) {
                    step.classList.add('active');
                    const stepNum = step.querySelector('.step-number');
                    if (stepNum) {
                        stepNum.style.background = 'var(--accent-color)';
                    }
                }
            }
        }

        // Manual species processing
        function processManualSpecies() {
            const input = document.getElementById('manualSpeciesInput').value.trim();
            if (!input) {
                showMessage('Please enter some text first.', 'warning');
                return;
            }

            processTextExtraction(input);
        }

        async function processTextExtraction(text) {
            try {
                showProcessingMessage('🔍 Processing text with species extraction patterns...', 'info');
                updateProcessingStep(3);
                
                const extractedSpecies = await extractSpeciesFromText(text);
                const enrichedSpecies = await enrichSpeciesData(extractedSpecies, text);
                
                speciesData = enrichedSpecies;
                
                showMessage(`Processing complete! Found ${speciesData.length} species.`, 'success');
                populateResults();
                updateAnalytics();
                
                setTimeout(() => {
                    const resultsTab = document.querySelector('[onclick="switchTab(\'results\')"]');
                    resultsTab.click();
                }, 500);
                
            } catch (error) {
                console.error('Error processing text:', error);
                showMessage('Error processing text: ' + error.message, 'error');
            }
        }

        function clearManualInput() {
            document.getElementById('manualSpeciesInput').value = '';
        }

        function loadSampleSpecies() {
            const sampleText = `Mytilus californianus
California mussel, Blue rockfish
Sebastes mystinus, Haliotis rufescens
Red abalone
Pisaster ochraceus, Purple sea star`;
            
            document.getElementById('manualSpeciesInput').value = sampleText;
        }

        // Results display
        function populateResults() {
            updateResultsStats();
            populateSpeciesCards();
        }

        function updateResultsStats() {
            const total = speciesData.length;
            const withData = speciesData.filter(s => s.hasAdditionalData).length;
            const incomplete = total - withData;

            document.getElementById('extractedCount').textContent = `${total} Extracted`;
            document.getElementById('withDataCount').textContent = `${withData} With Data`;
            document.getElementById('incompleteCount').textContent = `${incomplete} Incomplete`;
        }

        function populateSpeciesCards() {
            const grid = document.getElementById('speciesGrid');
            grid.innerHTML = '';

            speciesData.forEach((species, index) => {
                const card = createSpeciesCard(species, index);
                grid.appendChild(card);
            });
        }

        function createSpeciesCard(species, index) {
            const div = document.createElement('div');
            const status = species.hasAdditionalData ? 'verified' : 'not-found';
            div.className = `species-card ${status}`;
            
            div.innerHTML = `
                <div class="species-header">
                    <div class="species-name">${species.scientificName}</div>
                    <div class="common-names">${species.commonNames.join(', ') || 'No common name found'}</div>
                    <span class="status-badge status-${status}">
                        ${species.hasAdditionalData ? 'WITH DATA' : 'BASIC'}
                    </span>
                </div>
                
                <div class="species-details">
                    <div class="detail-grid">
                        ${species.number ? `
                        <div class="detail-row">
                            <span class="detail-label">Number:</span>
                            <span class="detail-value">${species.number}</span>
                        </div>
                        ` : ''}
                        ${species.author ? `
                        <div class="detail-row">
                            <span class="detail-label">Author:</span>
                            <span class="detail-value">${species.author}</span>
                        </div>
                        ` : ''}
                        ${species.size ? `
                        <div class="detail-row">
                            <span class="detail-label">Size:</span>
                            <span class="detail-value">${species.size}</span>
                        </div>
                        ` : ''}
                        ${species.habitat ? `
                        <div class="detail-row">
                            <span class="detail-label">Habitat:</span>
                            <span class="detail-value">${species.habitat}</span>
                        </div>
                        ` : ''}
                        ${species.distribution ? `
                        <div class="detail-row">
                            <span class="detail-label">Distribution:</span>
                            <span class="detail-value">${species.distribution}</span>
                        </div>
                        ` : ''}
                        <div class="detail-row">
                            <span class="detail-label">Extraction Method:</span>
                            <span class="detail-value">${species.extractionMethod}</span>
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

        function updateAnalytics() {
            if (!speciesData || speciesData.length === 0) return;

            const total = speciesData.length;
            const phylaSet = new Set();
            
            speciesData.forEach(s => {
                if (s.genus) phylaSet.add(s.genus);
            });

            document.getElementById('totalExtracted').textContent = total;
            document.getElementById('phylaCount').textContent = phylaSet.size;
            document.getElementById('pagesProcessed').textContent = processingStats.totalPages;
            document.getElementById('extractionRate').textContent = `${Math.round((total / Math.max(processingStats.totalPages, 1)) * 100)}%`;

            // Update processing summary
            const summaryEl = document.getElementById('processingSummary');
            summaryEl.innerHTML = `
                <div style="display: grid; gap: 10px;">
                    <p><strong>Species Extracted:</strong> ${total}</p>
                    <p><strong>Unique Genera:</strong> ${phylaSet.size}</p>
                    <p><strong>With Additional Data:</strong> ${speciesData.filter(s => s.hasAdditionalData).length}</p>
                    <p><strong>Pages Processed:</strong> ${processingStats.totalPages}</p>
                    <p><strong>Extraction Methods:</strong> ${[...new Set(speciesData.map(s => s.extractionMethod))].join(', ')}</p>
                </div>
            `;
        }

        // Export functions
        function exportToCSV() {
            if (!speciesData.length) {
                showMessage('No data to export.', 'error');
                return;
            }

            const headers = [
                'Number',
                'Scientific Name',
                'Genus',
                'Species',
                'Author',
                'Common Names',
                'Size',
                'Habitat',
                'Distribution',
                'Description',
                'Extraction Method',
                'Has Additional Data',
                'Extracted At'
            ];

            const rows = speciesData.map(species => [
                species.number || '',
                species.scientificName,
                species.genus,
                species.species,
                species.author || '',
                species.commonNames.join('; '),
                species.size || '',
                species.habitat || '',
                species.distribution || '',
                species.description || '',
                species.extractionMethod,
                species.hasAdditionalData ? 'Yes' : 'No',
                species.extractedAt || ''
            ]);

            const csvContent = [headers, ...rows].map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            downloadFile(csvContent, 'marine_species_extracted.csv', 'text/csv');
            showMessage('CSV exported successfully!', 'success');
        }

        function exportToJSON() {
            if (!speciesData.length) {
                showMessage('No data to export.', 'error');
                return;
            }

            const exportData = {
                extractedAt: new Date().toISOString(),
                totalSpecies: speciesData.length,
                processingStats: processingStats,
                species: speciesData
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, 'marine_species_extracted.json', 'application/json');
            showMessage('JSON exported successfully!', 'success');
        }

        function generateReport() {
            if (!speciesData.length) {
                showMessage('No data to generate report.', 'error');
                return;
            }

            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Marine Species Extraction Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .summary { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
                        .species { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
                        .scientific-name { font-style: italic; font-size: 1.2em; color: #2c5aa0; font-weight: bold; }
                        .data-section { background: #f5f5f5; padding: 10px; border-left: 3px solid #2c5aa0; margin-top: 10px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>🐚 Marine Species Extraction Report</h1>
                        <p>Generated on ${new Date().toLocaleDateString()}</p>
                        <p>Enhanced MarineID Pro with PDF.js Processing</p>
                    </div>

                    <div class="summary">
                        <h2>📊 Extraction Summary</h2>
                        <p><strong>Total Species Extracted:</strong> ${speciesData.length}</p>
                        <p><strong>Species with Additional Data:</strong> ${speciesData.filter(s => s.hasAdditionalData).length}</p>
                        <p><strong>Unique Genera:</strong> ${new Set(speciesData.map(s => s.genus)).size}</p>
                        <p><strong>Pages Processed:</strong> ${processingStats.totalPages}</p>
                        <p><strong>Extraction Methods:</strong> ${[...new Set(speciesData.map(s => s.extractionMethod))].join(', ')}</p>
                    </div>

                    <h2>📋 Species Details</h2>
                    ${speciesData.map((species, index) => `
                        <div class="species">
                            <div class="scientific-name">
                                ${species.number ? `${species.number}. ` : ''}${species.scientificName}
                            </div>
                            ${species.author ? `<p><strong>Author:</strong> ${species.author}</p>` : ''}
                            ${species.commonNames.length ? `<p><strong>Common Names:</strong> ${species.commonNames.join(', ')}</p>` : ''}
                            
                            ${species.hasAdditionalData ? `
                                <div class="data-section">
                                    ${species.size ? `<p><strong>Size:</strong> ${species.size}</p>` : ''}
                                    ${species.habitat ? `<p><strong>Habitat:</strong> ${species.habitat}</p>` : ''}
                                    ${species.distribution ? `<p><strong>Distribution:</strong> ${species.distribution}</p>` : ''}
                                    ${species.description ? `<p><strong>Description:</strong> ${species.description}</p>` : ''}
                                </div>
                            ` : ''}
                            
                            <p style="font-size: 0.9em; color: #666;">
                                <strong>Extraction Method:</strong> ${species.extractionMethod}
                            </p>
                        </div>
                    `).join('')}
                </body>
                </html>
            `;

            downloadFile(reportHTML, 'marine_species_extraction_report.html', 'text/html');
            showMessage('Report generated successfully!', 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // View toggle and AI helper
        function setView(viewType) {
            currentView = viewType;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            
            if (!message) {
                alert('Please enter a question first.');
                return;
            }
            
            const responses = [
                "That's a great question! For species verification issues, I recommend checking the original source and cross-referencing with multiple databases.",
                "To improve OCR accuracy, ensure your PDF has clear, high-contrast text. Scanned documents work better than photos.",
                "For unverified species, try searching with alternate spellings or check if it might be a synonym.",
                "The tool checks WoRMS, GBIF, iNaturalist, and OBIS. If a species isn't found, it might be newly described or have naming issues.",
                "For export options, you can download CSV for data analysis or generate HTML reports for presentations.",
                "Common issues with species identification include: misspelled names, outdated taxonomy, non-marine species, or subspecies not in databases.",
                "WoRMS is the most authoritative marine database. If a species isn't in WoRMS, double-check the spelling and taxonomic status."
            ];
            
            const response = responses[Math.floor(Math.random() * responses.length)];
            alert(`AI Helper: ${response}`);
            
            input.value = '';
        }

        function sendSupportEmail(type) {
            const subject = type === 'technical' ? 
                'MarineID Pro - Technical Support Request' : 
                'MarineID Pro - Development Support Request';
            
            const recipient = type === 'technical' ? 
                'aaron.kornbluth@gmail.com' : 
                'jakespencer6596@gmail.com';
            
            const body = `Hello ${type === 'technical' ? 'Aaron' : 'Jake'},

I need help with the MarineID Pro tool.

Issue Description:
[Please describe your issue or question here]

Technical Information:
Browser: ${navigator.userAgent}
Tool Version: Enhanced PDF Processing
Current Language: ${currentLanguage}
Species Data Count: ${speciesData.length}

Thank you for your assistance!

Best regards,
[Your name]`;

            const mailtoLink = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
        }

        // Message display functions
        function showMessage(message, type) {
            const container = document.getElementById('processingResults');
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
        }

        function showProcessingMessage(message, type) {
            const container = document.getElementById('processingResults');
            container.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="message ${type}">${message}</div>
                </div>
            `;
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            const currentTheme = localStorage.getItem('msa_theme');
            if (currentTheme === 'system') {
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
        });
    </script>
</body>
</html>
