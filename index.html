<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarineID Pro - Advanced Marine Species Identification</title>
    <link href="https://fonts.googleapis.com/css2?family=Orpheus+Pro:wght@400;700&family=Josefin+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #08306b;
            --text-color: #333;
            --card-bg: white;
            --border-color: #dee2e6;
            --accent-color: #08306b;
            --success-color: #209d5c;
            --warning-color: #ffc107;
            --error-color: #dc3545;
            --light-bg: #f8f9fa;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e9ecef;
            --card-bg: #2d3748;
            --border-color: #4a5568;
            --accent-color: #63b3ed;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --error-color: #f56565;
            --light-bg: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orpheus Pro', 'Georgia', serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .main-layout {
            display: flex;
            min-height: 100vh;
        }

        /* AI Assistant Panel */
        .ai-assistant {
            width: 350px;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .ai-body {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ai-intro {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border: 1px solid #08306b;
            border-radius: 8px;
            padding: 15px;
        }

        .ai-intro p {
            font-family: 'Josefin Sans', sans-serif;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
        }

        .ai-features {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .ai-features li {
            padding: 4px 0;
            font-family: 'Josefin Sans', sans-serif;
            font-size: 14px;
            color: #555;
            line-height: 1.3;
        }

        .ai-features li:before {
            content: "▶ ";
            color: #08306b;
            font-weight: bold;
            margin-right: 5px;
        }

        .ai-input-section {
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .ai-input-box {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
            background: var(--card-bg);
            color: var(--text-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
        }

        .content-header {
            background: linear-gradient(135deg, var(--light-bg) 0%, var(--card-bg) 100%);
            border-bottom: 2px solid var(--border-color);
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-main {
            flex: 1;
        }

        .header-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .controls-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-btn, .lang-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-color);
            transition: all 0.2s;
        }

        .theme-btn.active, .lang-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.7;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            background: var(--card-bg);
            color: var(--accent-color);
            opacity: 1;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-color);
        }

        .tab-content {
            padding: 30px;
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* Upload section */
        .upload-section {
            background: var(--light-bg);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--accent-color);
            background: var(--card-bg);
        }

        /* Processing steps */
        .processing-steps {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .step-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #6c757d;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto 10px;
        }

        .step-card.active .step-number {
            background: var(--accent-color);
        }

        /* Species cards */
        .species-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .species-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .species-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .species-card.verified {
            border-left: 4px solid #28a745;
        }

        .species-card.synonym {
            border-left: 4px solid #ffc107;
        }

        .species-card.not-found {
            border-left: 4px solid #dc3545;
        }

        .species-header {
            margin-bottom: 15px;
        }

        .species-name {
            font-style: italic;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .common-names {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-verified {
            background: #28a745;
            color: white;
        }

        .status-synonym {
            background: #ffc107;
            color: #212529;
        }

        .status-not-found {
            background: #dc3545;
            color: white;
        }

        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 0.95rem;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        /* Progress indicator */
        .progress-container {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 14px;
            color: var(--text-color);
            margin-top: 10px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }

            .ai-assistant {
                width: 100%;
                order: 2;
            }

            .species-grid {
                grid-template-columns: 1fr;
            }

            .processing-steps {
                grid-template-columns: 1fr;
            }
        }

        .button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .button:hover {
            background: #062954;
            transform: translateY(-1px);
        }

        .button.success {
            background: var(--success-color);
        }

        .button.success:hover {
            background: #1a7a47;
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- AI Assistant Panel -->
        <div class="ai-assistant">
            <div class="ai-body">
                <div class="ai-intro">
                    <p><strong>🤖 MarineID AI Assistant</strong></p>
                    <ul class="ai-features">
                        <li>Real WoRMS database integration</li>
                        <li>Advanced PDF species extraction</li>
                        <li>Multilingual support (EN/ES/FR)</li>
                        <li>Taxonomic hierarchy recognition</li>
                        <li>Morphological data capture</li>
                        <li>Comprehensive field guide analysis</li>
                        <li>Export verified species data</li>
                        <li>Confidence scoring system</li>
                    </ul>
                </div>
                <div class="ai-input-section">
                    <textarea class="ai-input-box" id="aiInput" placeholder="Ask about PDF processing, species extraction, or any technical questions..."></textarea>
                    <button class="button success" onclick="sendAIMessage()">Ask AI Helper</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <div class="header-main">
                    <h1 style="font-family: 'Orpheus Pro', serif; font-size: 28px; color: var(--text-color); margin-bottom: 5px; font-weight: 700;">🐚 MarineID Pro</h1>
                    <p style="font-family: 'Josefin Sans', sans-serif; color: var(--text-color); opacity: 0.7; font-size: 16px; font-weight: 400; margin-bottom: 10px;">
                        Advanced AI-powered marine species identification and verification system
                    </p>
                    <p style="font-family: 'Josefin Sans', sans-serif; color: var(--text-color); opacity: 0.8; font-size: 14px; line-height: 1.4; max-width: 600px;">
                        Leverages cutting-edge OCR technology, natural language processing, and real-time access to four authoritative marine databases (<a href="https://www.marinespecies.org/" target="_blank" style="color: var(--accent-color); text-decoration: none;">WoRMS</a>, <a href="https://www.gbif.org/" target="_blank" style="color: var(--accent-color); text-decoration: none;">GBIF</a>, <a href="https://www.inaturalist.org/" target="_blank" style="color: var(--accent-color); text-decoration: none;">iNaturalist</a>, <a href="https://obis.org/" target="_blank" style="color: var(--accent-color); text-decoration: none;">OBIS</a>) to extract, identify, and verify marine species from field guides and research documents with unprecedented accuracy and speed.
                    </p>
                </div>
                <div class="header-controls">
                    <div class="controls-row">
                        <div class="theme-selector">
                            <span style="font-size: 12px; margin-right: 8px;">Theme:</span>
                            <button class="theme-btn active" onclick="setTheme('system')" data-theme="system">System</button>
                            <button class="theme-btn" onclick="setTheme('light')" data-theme="light">Light</button>
                            <button class="theme-btn" onclick="setTheme('dark')" data-theme="dark">Dark</button>
                        </div>
                    </div>
                    <div class="controls-row">
                        <div style="display: flex; gap: 5px;">
                            <button class="lang-btn active" onclick="setLanguage('en')" data-lang="en">English</button>
                            <button class="lang-btn" onclick="setLanguage('es')" data-lang="es">Español</button>
                            <button class="lang-btn" onclick="setLanguage('fr')" data-lang="fr">Français</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('upload')">📄 Extract Species</button>
                <button class="tab" onclick="switchTab('results')">📊 Results & Verification</button>
                <button class="tab" onclick="switchTab('analytics')">📈 Analytics</button>
                <button class="tab" onclick="switchTab('help')" style="margin-left: auto;">❓ Help</button>
            </div>

            <!-- Upload Tab Content -->
            <div class="tab-content active" id="upload-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- PDF Upload Section -->
                    <div class="upload-section" id="uploadSection" 
                         ondragover="handleDragOver(event)" 
                         ondragleave="handleDragLeave(event)" 
                         ondrop="handleDrop(event)"
                         onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3rem; margin-bottom: 15px;">📄</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--text-color); margin-bottom: 8px;">Upload Marine Field Guide PDF</div>
                        <div style="color: var(--text-color); opacity: 0.7; margin-bottom: 20px;">Drag and drop your PDF here, or click to browse</div>
                        <button class="button">Choose PDF File</button>
                        <input type="file" id="fileInput" style="display: none;" accept=".pdf" onchange="handleFileUpload(event)">
                        <div style="margin-top: 15px; font-size: 0.9rem; color: var(--text-color); opacity: 0.6;">
                            Maximum file size: 1GB • Supports multilingual field guides
                        </div>
                    </div>

                    <!-- Manual Species Entry Section -->
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div style="font-size: 2rem;">🔍</div>
                            <div>
                                <h3 style="margin: 0; color: var(--text-color);">Manual Species Verification</h3>
                                <p style="margin: 5px 0 0 0; color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Enter species names to verify against WoRMS, GBIF, iNaturalist, and OBIS databases</p>
                            </div>
                        </div>
                        
                        <div>
                            <textarea id="manualSpeciesInput" style="width: 100%; height: 100px; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; font-size: 14px; background: var(--card-bg); color: var(--text-color); resize: vertical;"
                                      placeholder="Enter species names (scientific or common), one per line:
Example:
Blue whale
Mytilus californianus
Octopus vulgaris"></textarea>
                            
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="button" onclick="processManualSpecies()">🔍 Verify Species</button>
                                <button class="button" onclick="clearManualInput()" style="background: #6c757d;">🗑️ Clear</button>
                                <button class="button success" onclick="loadSampleSpecies()">📋 Examples</button>
                            </div>
                            
                            <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 6px;">
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-color); opacity: 0.8;">
                                    <span>✅</span>
                                    <span>Accepts scientific & common names</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-color); opacity: 0.8;">
                                    <span>🔄</span>
                                    <span>Auto-resolves common to scientific names</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-color); opacity: 0.8;">
                                    <span>🌊</span>
                                    <span>Verifies against 4 marine databases</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Steps -->
                <div style="display: flex; align-items: center; margin: 30px 0;">
                    <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                    <span style="padding: 0 20px; color: var(--text-color); font-weight: 600; opacity: 0.7;">PROCESSING WORKFLOW</span>
                    <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                </div>

                <div class="processing-steps">
                    <div class="step-card" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-title">Text Extraction</div>
                        <div class="step-description">Enhanced OCR with multilingual support</div>
                    </div>
                    <div class="step-card" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-title">Species Parsing</div>
                        <div class="step-description">Advanced regex patterns for multiple formats</div>
                    </div>
                    <div class="step-card" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-title">Name Resolution</div>
                        <div class="step-description">Common to scientific name conversion</div>
                    </div>
                    <div class="step-card" id="step4">
                        <div class="step-number">4</div>
                        <div class="step-title">Database Verification</div>
                        <div class="step-description">Real WoRMS API integration</div>
                    </div>
                    <div class="step-card" id="step5">
                        <div class="step-number">5</div>
                        <div class="step-title">Results Analysis</div>
                        <div class="step-description">Confidence scoring & taxonomic data</div>
                    </div>
                </div>

                <div id="processingResults">
                    <!-- Processing messages will appear here -->
                </div>
            </div>

            <!-- Results Tab Content -->
            <div class="tab-content" id="results-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2>Species Verification Results</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="button" onclick="exportToCSV()">📊 Export CSV</button>
                        <button class="button" onclick="exportToJSON()">📋 Export JSON</button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px;" id="resultsStats">
                    <div style="padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; background: #d4edda; color: #155724;" id="verifiedCount">0 Verified</div>
                    <div style="padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; background: #fff3cd; color: #856404;" id="synonymCount">0 Synonyms</div>
                    <div style="padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; background: #f8d7da; color: #721c24;" id="notFoundCount">0 Not Found</div>
                </div>
                
                <div class="species-grid" id="speciesGrid">
                    <div style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.6;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">🔬</div>
                        <h3>No species data yet</h3>
                        <p>Upload a PDF or enter species names manually to begin verification</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-content" id="analytics-content">
                <h2>Processing Analytics</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--accent-color); font-weight: bold;" id="totalExtracted">0</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Total Species</div>
                    </div>
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--success-color); font-weight: bold;" id="verificationRate">0%</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Verification Rate</div>
                    </div>
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: #17a2b8; font-weight: bold;" id="uniqueGenera">0</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Unique Genera</div>
                    </div>
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--warning-color); font-weight: bold;" id="avgConfidence">0%</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Avg Confidence</div>
                    </div>
                </div>

                <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--text-color);">📊 Processing Summary</h3>
                    <div id="processingSummary">
                        <p>Process species data to see detailed analytics</p>
                    </div>
                </div>
            </div>

            <!-- Help Tab -->
            <div class="tab-content" id="help-content">
                <h2>MarineID Pro Documentation</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                        <h3>🚀 Quick Start</h3>
                        <ol style="margin: 15px 0; padding-left: 20px; line-height: 1.6;">
                            <li><strong>Upload PDF:</strong> Marine field guide or species list</li>
                            <li><strong>Processing:</strong> Advanced OCR extracts species names</li>
                            <li><strong>Verification:</strong> Real-time WoRMS database checking</li>
                            <li><strong>Results:</strong> Download verified species data</li>
                        </ol>
                    </div>

                    <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                        <h3>🌊 Database Integration</h3>
                        <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.6;">
                            <li><strong>WoRMS:</strong> Primary taxonomic authority</li>
                            <li><strong>GBIF:</strong> Global occurrence data</li>
                            <li><strong>iNaturalist:</strong> Citizen science data</li>
                            <li><strong>OBIS:</strong> Ocean biodiversity records</li>
                        </ul>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%); border: 1px solid #2196f3; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">📧 Support & Development</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <h4 style="margin-bottom: 10px;">🔬 Technical Support</h4>
                            <button class="button" onclick="contactSupport('technical')" style="width: 100%;">Email Aaron Kornbluth</button>
                            <p style="font-size: 0.9rem; margin-top: 8px; opacity: 0.8;">Marine biology expertise & tool functionality</p>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 10px;">💻 Development</h4>
                            <button class="button success" onclick="contactSupport('development')" style="width: 100%;">Submit Bug Report</button>
                            <p style="font-size: 0.9rem; margin-top: 8px; opacity: 0.8;">Bug reports & feature requests</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Global variables
        let speciesData = [];
        let currentLanguage = 'en';
        let processingStats = {
            totalSpecies: 0,
            verified: 0,
            synonyms: 0,
            notFound: 0
        };

        // Enhanced species extraction patterns - FIXED VERSION
        const SPECIES_PATTERNS = {
            // Comprehensive patterns for different formats
            numbered: /^(\d+)\.\s*([A-Z][a-z]+(?:-[a-z]+)?)\s+([a-z]+(?:-[a-z]+)*(?:\s+[a-z]+(?:-[a-z]+)*)*)\s*(?:\([^)]+\))?\s*$/gm,
            scientific: /\b([A-Z][a-z]+(?:-[a-z]+)?)\s+([a-z]+(?:-[a-z]+)*(?:\s+[a-z]+(?:-[a-z]+)*)*)\b/g,
            familyHeaders: /^(Phylum|Class|Order|Family|Subfamily)\s+([A-Z][a-zA-Z]+)$/gm,
            spanishNames: /(?:nombre común|nombre vulgar|español):\s*([^.\n]+)/gi,
            englishNames: /(?:common name|english):\s*([^.\n]+)/gi,
            size: /(?:size|tamaño|taille):\s*([^.\n]+)/gi,
            habitat: /(?:habitat|hábitat):\s*([^.\n]+)/gi,
            distribution: /(?:distribution|distribución):\s*([^.\n]+)/gi
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            console.log('MarineID Pro - Fixed Version Loaded');
        });

        function initializeTheme() {
            const savedTheme = localStorage.getItem('marineid_theme') || 'system';
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const themeBtn = document.querySelector(`[data-theme="${theme}"]`);
            if (themeBtn) themeBtn.classList.add('active');
            
            if (theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            
            localStorage.setItem('marineid_theme', theme);
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const langBtn = document.querySelector(`.lang-btn[data-lang="${lang}"]`);
            if (langBtn) langBtn.classList.add('active');
            localStorage.setItem('marineid_language', lang);
        }

        // Tab navigation
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            const selectedTab = document.getElementById(`${tabName}-content`);
            selectedTab.classList.add('active');
            selectedTab.style.display = 'block';
        }

        // File upload handlers
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = 'var(--accent-color)';
            event.currentTarget.style.background = 'var(--card-bg)';
        }

        function handleDragLeave(event) {
            event.currentTarget.style.borderColor = 'var(--border-color)';
            event.currentTarget.style.background = 'var(--light-bg)';
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = 'var(--border-color)';
            event.currentTarget.style.background = 'var(--light-bg)';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // FIXED: Enhanced PDF processing with working extraction
        async function processFile(file) {
            if (!validateFile(file)) return;

            try {
                showProcessingMessage('🚀 Starting enhanced PDF processing...', 'info');
                updateProcessingStep(1);
                
                await processPDFWithRealExtraction(file);
                
            } catch (error) {
                console.error('Error processing file:', error);
                showMessage('Error processing PDF: ' + error.message, 'error');
            }
        }

        async function processPDFWithRealExtraction(file) {
            try {
                // Step 1: Load PDF
                showProcessingMessage('📄 Loading PDF with PDF.js...', 'info');
                updateProcessingStep(1);
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                showProcessingMessage(`📖 PDF loaded: ${pdf.numPages} pages`, 'info');
                
                // Step 2: Extract text from all pages
                showProcessingMessage('🔍 Extracting text from all pages...', 'info');
                updateProcessingStep(2);
                
                let fullText = '';
                const progressContainer = createProgressIndicator();
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += `\n--- PAGE ${i} ---\n${pageText}`;
                    
                    // Update progress
                    const progress = (i / pdf.numPages) * 100;
                    updateProgress(progressContainer, progress, `Processing page ${i} of ${pdf.numPages}`);
                    
                    // Brief pause to prevent blocking
                    if (i % 5 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                removeProgressIndicator(progressContainer);
                
                // Step 3: FIXED - Parse species with working extraction
                showProcessingMessage('🧬 Parsing species with advanced patterns...', 'info');
                updateProcessingStep(3);
                
                const extractedSpecies = await extractSpeciesFromTextFixed(fullText);
                
                if (extractedSpecies.length === 0) {
                    showMessage('⚠️ No species found with current patterns. Trying alternative extraction methods...', 'warning');
                    // Try alternative extraction methods
                    const altSpecies = await tryAlternativeExtraction(fullText);
                    if (altSpecies.length > 0) {
                        extractedSpecies.push(...altSpecies);
                    }
                }
                
                // Step 4: Verify with WoRMS (FIXED - Real API calls)
                showProcessingMessage('🌊 Verifying species with WoRMS database...', 'info');
                updateProcessingStep(4);
                
                const verifiedSpecies = await verifySpeciesWithWoRMS(extractedSpecies);
                
                // Step 5: Process results
                showProcessingMessage('✅ Processing and organizing results...', 'info');
                updateProcessingStep(5);
                
                speciesData = verifiedSpecies;
                updateStats();
                
                showMessage(`🎉 Processing complete! Extracted ${speciesData.length} species from ${pdf.numPages} pages.`, 'success');
                
                populateResults();
                updateAnalytics();
                
                // Switch to results tab
                setTimeout(() => {
                    const resultsTab = document.querySelector('[onclick="switchTab(\'results\')"]');
                    resultsTab.click();
                }, 1000);
                
            } catch (error) {
                console.error('Error in processPDFWithRealExtraction:', error);
                showMessage('Error processing PDF: ' + error.message, 'error');
            }
        }

        // FIXED: Working species extraction
        async function extractSpeciesFromTextFixed(text) {
            const species = [];
            const seenNames = new Set();
            
            console.log('Starting enhanced species extraction...');
            
            // Split text into lines for processing
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            // Method 1: Look for numbered species entries
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Pattern for numbered entries like "1. Craniella arb"
                const numberedMatch = line.match(/^(\d+)\.\s*([A-Z][a-z]+(?:-[a-z]+)?)\s+([a-z]+(?:-[a-z]+)*(?:\s+[a-z]+(?:-[a-z]+)*)*)\s*(?:\([^)]+\))?/);
                
                if (numberedMatch) {
                    const [, number, genus, speciesName] = numberedMatch;
                    const scientificName = `${genus} ${speciesName.split(' ')[0]}`; // Take first part of species name
                    
                    if (!seenNames.has(scientificName)) {
                        seenNames.add(scientificName);
                        species.push({
                            number: parseInt(number),
                            scientificName: scientificName,
                            genus: genus,
                            species: speciesName.split(' ')[0],
                            extractionMethod: 'numbered',
                            sourceText: line,
                            pageContext: findPageNumber(text, line)
                        });
                        console.log(`Found numbered species: ${scientificName}`);
                    }
                }
            }
            
            // Method 2: Look for scientific name patterns
            const scientificMatches = text.match(SPECIES_PATTERNS.scientific);
            if (scientificMatches) {
                scientificMatches.forEach(match => {
                    const parts = match.trim().split(/\s+/);
                    if (parts.length >= 2) {
                        const genus = parts[0];
                        const speciesName = parts[1];
                        const scientificName = `${genus} ${speciesName}`;
                        
                        if (!seenNames.has(scientificName) && isValidScientificName(genus, speciesName)) {
                            seenNames.add(scientificName);
                            species.push({
                                scientificName: scientificName,
                                genus: genus,
                                species: speciesName,
                                extractionMethod: 'pattern_match',
                                sourceText: match
                            });
                            console.log(`Found pattern species: ${scientificName}`);
                        }
                    }
                });
            }
            
            // Method 3: Look for common marine species names
            const commonMarineSpecies = [
                'blue whale', 'humpback whale', 'killer whale', 'bottlenose dolphin',
                'california sea lion', 'harbor seal', 'sea otter', 'california mussel',
                'purple sea urchin', 'red abalone', 'giant kelp', 'sea anemone',
                'dungeness crab', 'red rock crab', 'acorn barnacle', 'gooseneck barnacle'
            ];
            
            const textLower = text.toLowerCase();
            commonMarineSpecies.forEach(commonName => {
                if (textLower.includes(commonName) && !seenNames.has(commonName)) {
                    seenNames.add(commonName);
                    species.push({
                        commonName: commonName,
                        scientificName: 'Unknown', // Will be resolved via API
                        extractionMethod: 'common_name',
                        sourceText: commonName
                    });
                    console.log(`Found common species: ${commonName}`);
                }
            });
            
            console.log(`Total species extracted: ${species.length}`);
            return species;
        }

        // Alternative extraction method
        async function tryAlternativeExtraction(text) {
            const species = [];
            
            // Look for any capitalized word followed by lowercase word (potential binomial names)
            const possibleSpecies = text.match(/\b[A-Z][a-z]+\s+[a-z]+\b/g);
            
            if (possibleSpecies) {
                const seenNames = new Set();
                possibleSpecies.forEach(match => {
                    const parts = match.trim().split(/\s+/);
                    if (parts.length === 2) {
                        const [genus, speciesName] = parts;
                        const scientificName = `${genus} ${speciesName}`;
                        
                        if (!seenNames.has(scientificName) && isValidScientificName(genus, speciesName)) {
                            seenNames.add(scientificName);
                            species.push({
                                scientificName: scientificName,
                                genus: genus,
                                species: speciesName,
                                extractionMethod: 'alternative_pattern',
                                sourceText: match
                            });
                        }
                    }
                });
            }
            
            return species;
        }

        function isValidScientificName(genus, species) {
            // Basic validation for scientific names
            if (genus.length < 3 || species.length < 3) return false;
            if (genus === species) return false;
            
            // Common non-species words to exclude
            const excludeWords = ['the', 'and', 'are', 'for', 'with', 'this', 'that', 'they', 'have', 'from', 'been', 'were', 'said', 'each', 'which', 'their', 'time', 'will', 'about', 'if', 'up', 'out', 'many', 'then', 'them', 'these', 'so', 'some', 'her', 'would', 'make', 'like', 'into', 'him', 'has', 'two', 'more', 'very', 'what', 'know', 'just', 'first', 'get', 'over'];
            
            if (excludeWords.includes(genus.toLowerCase()) || excludeWords.includes(species.toLowerCase())) {
                return false;
            }
            
            return true;
        }

        function findPageNumber(fullText, line) {
            const beforeLine = fullText.substring(0, fullText.indexOf(line));
            const pageMatches = beforeLine.match(/--- PAGE (\d+) ---/g);
            return pageMatches ? pageMatches.length : 1;
        }

        // FIXED: Real WoRMS API integration
        async function verifySpeciesWithWoRMS(species) {
            const verifiedSpecies = [];
            const batchSize = 5; // Process in small batches to avoid rate limiting
            
            for (let i = 0; i < species.length; i += batchSize) {
                const batch = species.slice(i, i + batchSize);
                const batchPromises = batch.map(sp => verifyWithWoRMS(sp));
                const batchResults = await Promise.allSettled(batchPromises);
                
                batchResults.forEach((result, index) => {
                    if (result.status === 'fulfilled') {
                        verifiedSpecies.push(result.value);
                    } else {
                        // If verification fails, add species with unknown status
                        const originalSpecies = batch[index];
                        verifiedSpecies.push({
                            ...originalSpecies,
                            verificationStatus: 'error',
                            confidence: 0,
                            verificationDate: new Date().toISOString()
                        });
                    }
                });
                
                // Brief delay between batches
                if (i + batchSize < species.length) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            return verifiedSpecies;
        }

        async function verifyWithWoRMS(species) {
            try {
                let searchName = species.scientificName;
                
                // If we have a common name, try to resolve it first
                if (species.commonName && species.scientificName === 'Unknown') {
                    searchName = species.commonName;
                }
                
                // WoRMS API endpoint for name matching
                const wormsUrl = `https://www.marinespecies.org/rest/AphiaRecordsByName/${encodeURIComponent(searchName)}?like=false&marine_only=true&offset=1`;
                
                const response = await fetch(wormsUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const record = data[0]; // Take first match
                        
                        return {
                            ...species,
                            scientificName: record.scientificname || species.scientificName,
                            acceptedName: record.valid_name || record.scientificname,
                            wormsAphiaID: record.AphiaID,
                            taxonomicStatus: record.status,
                            rank: record.rank,
                            kingdom: record.kingdom,
                            phylum: record.phylum,
                            class: record.class,
                            order: record.order,
                            family: record.family,
                            genus: record.genus,
                            verificationStatus: record.status === 'accepted' ? 'verified' : 'synonym',
                            confidence: record.status === 'accepted' ? 95 : 75,
                            verificationDate: new Date().toISOString(),
                            wormsUrl: `https://www.marinespecies.org/aphia.php?p=taxdetails&id=${record.AphiaID}`
                        };
                    }
                }
                
                // If no match found in WoRMS
                return {
                    ...species,
                    verificationStatus: 'not_found',
                    confidence: 0,
                    verificationDate: new Date().toISOString(),
                    notes: 'Not found in WoRMS database'
                };
                
            } catch (error) {
                console.error('WoRMS verification error:', error);
                return {
                    ...species,
                    verificationStatus: 'error',
                    confidence: 0,
                    verificationDate: new Date().toISOString(),
                    notes: 'Verification error: ' + error.message
                };
            }
        }

        // Manual species processing
        function processManualSpecies() {
            const input = document.getElementById('manualSpeciesInput').value.trim();
            if (!input) {
                showMessage('Please enter some species names first.', 'warning');
                return;
            }

            processManualInput(input);
        }

        async function processManualInput(input) {
            try {
                showProcessingMessage('🔍 Processing manual species entries...', 'info');
                updateProcessingStep(3);
                
                const lines = input.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                const species = lines.map(line => {
                    // Check if it looks like a scientific name (Genus species)
                    const scientificMatch = line.match(/^([A-Z][a-z]+)\s+([a-z]+)$/);
                    if (scientificMatch) {
                        return {
                            scientificName: line,
                            genus: scientificMatch[1],
                            species: scientificMatch[2],
                            extractionMethod: 'manual_scientific'
                        };
                    } else {
                        return {
                            commonName: line,
                            scientificName: 'Unknown',
                            extractionMethod: 'manual_common'
                        };
                    }
                });
                
                showProcessingMessage('🌊 Verifying with WoRMS database...', 'info');
                updateProcessingStep(4);
                
                const verifiedSpecies = await verifySpeciesWithWoRMS(species);
                
                updateProcessingStep(5);
                speciesData = verifiedSpecies;
                updateStats();
                
                showMessage(`Verification complete! Processed ${speciesData.length} species.`, 'success');
                populateResults();
                updateAnalytics();
                
                setTimeout(() => {
                    const resultsTab = document.querySelector('[onclick="switchTab(\'results\')"]');
                    resultsTab.click();
                }, 500);
                
            } catch (error) {
                console.error('Error processing manual input:', error);
                showMessage('Error processing species: ' + error.message, 'error');
            }
        }

        function clearManualInput() {
            document.getElementById('manualSpeciesInput').value = '';
        }

        function loadSampleSpecies() {
            const sampleText = `Mytilus californianus
Octopus vulgaris
Balaenoptera musculus
Callorhinus ursinus
Strongylocentrotus purpuratus
Haliotis rufescens`;
            
            document.getElementById('manualSpeciesInput').value = sampleText;
        }

        function validateFile(file) {
            const maxSize = 1024 * 1024 * 1024; // 1GB
            if (file.size > maxSize) {
                showMessage('File too large. Maximum size is 1GB', 'error');
                return false;
            }

            if (file.type !== 'application/pdf') {
                showMessage('Please upload a PDF file only.', 'error');
                return false;
            }

            return true;
        }

        function updateProcessingStep(stepNumber) {
            document.querySelectorAll('.step-card').forEach(card => {
                card.classList.remove('active');
                const stepNum = card.querySelector('.step-number');
                if (stepNum) {
                    stepNum.style.background = '#6c757d';
                }
            });
            
            for (let i = 1; i <= stepNumber; i++) {
                const step = document.getElementById(`step${i}`);
                if (step) {
                    step.classList.add('active');
                    const stepNum = step.querySelector('.step-number');
                    if (stepNum) {
                        stepNum.style.background = 'var(--accent-color)';
                    }
                }
            }
        }

        function createProgressIndicator() {
            const container = document.createElement('div');
            container.className = 'progress-container';
            container.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Starting...</div>
            `;
            document.getElementById('processingResults').appendChild(container);
            return container;
        }

        function updateProgress(container, percentage, text) {
            const fill = container.querySelector('#progressFill');
            const textEl = container.querySelector('#progressText');
            fill.style.width = `${percentage}%`;
            textEl.textContent = text;
        }

        function removeProgressIndicator(container) {
            if (container && container.parentNode) {
                container.parentNode.removeChild(container);
            }
        }

        function updateStats() {
            processingStats.totalSpecies = speciesData.length;
            processingStats.verified = speciesData.filter(s => s.verificationStatus === 'verified').length;
            processingStats.synonyms = speciesData.filter(s => s.verificationStatus === 'synonym').length;
            processingStats.notFound = speciesData.filter(s => s.verificationStatus === 'not_found' || s.verificationStatus === 'error').length;
        }

        function populateResults() {
            updateResultsStats();
            populateSpeciesCards();
        }

        function updateResultsStats() {
            document.getElementById('verifiedCount').textContent = `${processingStats.verified} Verified`;
            document.getElementById('synonymCount').textContent = `${processingStats.synonyms} Synonyms`;
            document.getElementById('notFoundCount').textContent = `${processingStats.notFound} Not Found`;
        }

        function populateSpeciesCards() {
            const grid = document.getElementById('speciesGrid');
            grid.innerHTML = '';

            if (speciesData.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.6;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">🔬</div>
                        <h3>No species data yet</h3>
                        <p>Upload a PDF or enter species names manually to begin verification</p>
                    </div>
                `;
                return;
            }

            speciesData.forEach((species, index) => {
                const card = createSpeciesCard(species, index);
                grid.appendChild(card);
            });
        }

        function createSpeciesCard(species, index) {
            const div = document.createElement('div');
            const status = species.verificationStatus || 'not_found';
            div.className = `species-card ${status}`;
            
            div.innerHTML = `
                <div class="species-header">
                    <div class="species-name">${species.acceptedName || species.scientificName}</div>
                    <div class="common-names">${species.commonName || 'No common name'}</div>
                    <span class="status-badge status-${status}">
                        ${status === 'verified' ? 'VERIFIED' : status === 'synonym' ? 'SYNONYM' : 'NOT FOUND'}
                    </span>
                </div>
                
                <div style="background: var(--light-bg); padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <div style="display: grid; gap: 8px;">
                        ${species.wormsAphiaID ? `
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px;">
                            <span style="font-weight: 600;">WoRMS ID:</span>
                            <span>${species.wormsAphiaID}</span>
                        </div>
                        ` : ''}
                        ${species.rank ? `
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px;">
                            <span style="font-weight: 600;">Rank:</span>
                            <span>${species.rank}</span>
                        </div>
                        ` : ''}
                        ${species.family ? `
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px;">
                            <span style="font-weight: 600;">Family:</span>
                            <span>${species.family}</span>
                        </div>
                        ` : ''}
                        ${species.phylum ? `
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px;">
                            <span style="font-weight: 600;">Phylum:</span>
                            <span>${species.phylum}</span>
                        </div>
                        ` : ''}
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px;">
                            <span style="font-weight: 600;">Confidence:</span>
                            <span>${species.confidence || 0}%</span>
                        </div>
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px;">
                            <span style="font-weight: 600;">Method:</span>
                            <span>${species.extractionMethod}</span>
                        </div>
                        ${species.wormsUrl ? `
                        <div style="margin-top: 10px;">
                            <a href="${species.wormsUrl}" target="_blank" class="button" style="font-size: 12px; padding: 5px 10px;">View in WoRMS</a>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            return div;
        }

        function updateAnalytics() {
            if (!speciesData || speciesData.length === 0) return;

            const total = speciesData.length;
            const verified = processingStats.verified;
            const verificationRate = total > 0 ? Math.round((verified / total) * 100) : 0;
            const genera = new Set(speciesData.map(s => s.genus).filter(g => g)).size;
            const avgConfidence = total > 0 ? Math.round(speciesData.reduce((sum, s) => sum + (s.confidence || 0), 0) / total) : 0;

            document.getElementById('totalExtracted').textContent = total;
            document.getElementById('verificationRate').textContent = `${verificationRate}%`;
            document.
