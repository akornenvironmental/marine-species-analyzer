<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarineID Pro - Advanced Marine Species Identification</title>
    <link href="https://fonts.googleapis.com/css2?family=Orpheus+Pro:wght@400;700&family=Josefin+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: white;
            --border-color: #dee2e6;
            --accent-color: #08306b;
            --success-color: #209d5c;
            --warning-color: #ffc107;
            --error-color: #dc3545;
            --light-bg: #f8f9fa;
        }

        [data-theme="light"] {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: white;
            --border-color: #dee2e6;
            --accent-color: #08306b;
            --success-color: #209d5c;
            --warning-color: #ffc107;
            --error-color: #dc3545;
            --light-bg: #f8f9fa;
        }
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e9ecef;
            --card-bg: #2d3748;
            --border-color: #4a5568;
            --accent-color: #63b3ed;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --error-color: #f56565;
            --light-bg: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orpheus Pro', 'Georgia', serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .main-layout {
            display: flex;
            min-height: 100vh;
        }

        /* AI Assistant Panel */
        .ai-assistant {
            width: 350px;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            border-right: 1px solid var(--border-color);
        }

        .ai-header {
            padding: 20px 15px 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .ai-body {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ai-intro {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border: 1px solid #08306b;
            border-radius: 8px;
            padding: 15px;
        }

        .ai-intro p {
            font-family: 'Josefin Sans', sans-serif;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
        }

        .ai-intro ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ai-intro li {
            font-family: 'Josefin Sans', sans-serif;
            color: #333;
            margin: 5px 0;
            padding-left: 20px;
            position: relative;
            font-size: 14px;
        }

        .ai-intro li::before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #209d5c;
            font-weight: bold;
        }

        .ai-input-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ai-input-box {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            background: var(--card-bg);
            color: var(--text-color);
            resize: vertical;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .content-header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .mobile-notice {
            position: absolute;
            top: 5px;
            right: 15px;
            font-size: 11px;
            color: var(--text-color);
            opacity: 0.6;
            font-family: 'Josefin Sans', sans-serif;
        }

        .section-divider {
            display: flex;
            align-items: center;
            margin: 30px 0;
        }

        .section-divider-line {
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }

        .section-divider-text {
            padding: 0 20px;
            color: var(--text-color);
            font-weight: 600;
            opacity: 0.8;
            font-family: 'Orpheus Pro', serif;
        }

        .results-header {
            font-family: 'Orpheus Pro', serif;
            font-size: 24px;
            color: var(--text-color) !important;
            margin: 0;
            font-weight: 700;
        }

        .section-title {
            font-family: 'Orpheus Pro', serif;
            font-size: 24px;
            color: var(--text-color) !important;
            margin: 0;
            font-weight: 700;
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: var(--text-color) !important;
            opacity: 0.7;
        }

        .no-data-message h3 {
            color: var(--text-color) !important;
            font-family: 'Orpheus Pro', serif;
            margin-bottom: 10px;
        }

        .no-data-message p {
            color: var(--text-color) !important;
            opacity: 0.8;
        }

        .content-header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .mobile-notice {
            position: absolute;
            top: 5px;
            right: 15px;
            font-size: 11px;
            color: var(--text-color);
            opacity: 0.6;
            font-family: 'Josefin Sans', sans-serif;
        }

        .header-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-selector {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .theme-btn, .lang-btn {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .theme-btn.active, .lang-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Orpheus Pro', serif;
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.7;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            background: var(--card-bg);
            color: var(--accent-color);
            opacity: 1;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-color);
        }

        .tab-content {
            padding: 30px;
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* Upload section */
        .upload-section {
            background: var(--light-bg);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--accent-color);
            background: var(--card-bg);
        }

        /* Processing steps */
        .processing-steps {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .step-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #6c757d;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto 10px;
        }

        .step-card.active .step-number {
            background: var(--accent-color);
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .step-description {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Buttons */
        .button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .button.success {
            background: var(--success-color);
        }

        /* Species grid */
        .species-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .species-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .species-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .species-header {
            margin-bottom: 15px;
        }

        .species-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .common-names {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-verified {
            background: var(--success-color);
            color: white;
        }

        .status-synonym {
            background: var(--warning-color);
            color: white;
        }

        .status-not_found {
            background: var(--error-color);
            color: white;
        }

        /* Progress indicators */
        .progress-container {
            margin: 20px 0;
            padding: 15px;
            background: var(--light-bg);
            border-radius: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--text-color);
            text-align: center;
        }

        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .processing-steps {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .processing-steps {
                grid-template-columns: 1fr;
            }
            
            .species-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- AI Assistant Panel -->
        <div class="ai-assistant">
            <div class="ai-header">
                <h3 style="font-family: 'Orpheus Pro', serif; margin: 0; color: var(--text-color); font-size: 18px;">🤖 AI Research Assistant</h3>
            </div>
            <div class="ai-body">
                <div class="ai-intro">
                    <p>Advanced marine species analysis</p>
                    <ul>
                        <li>Advanced PDF species extraction</li>
                        <li>Multilingual support (EN/ES/FR)</li>
                        <li>Taxonomic hierarchy recognition</li>
                        <li>Morphological data capture</li>
                        <li>Comprehensive field guide analysis</li>
                        <li>Export verified species data</li>
                        <li>Confidence scoring system</li>
                    </ul>
                </div>
                <div class="ai-input-section">
                    <textarea class="ai-input-box" id="aiInput" placeholder="Ask about PDF processing, species extraction, or any technical questions..."></textarea>
                    <button class="button success" onclick="sendAIMessage()">Ask AI Helper</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <div class="mobile-notice">Optimized for desktop. Mobile version coming soon.</div>
                <div class="header-main">
                    <h1 style="font-family: 'Orpheus Pro', serif; font-size: 28px; color: var(--text-color); margin-bottom: 5px; font-weight: 700;">🐚 MarineID Pro</h1>
                    <p style="font-family: 'Josefin Sans', sans-serif; color: var(--text-color); opacity: 0.7; font-size: 16px; font-weight: 400; margin-bottom: 10px;">
                        Advanced AI-powered marine species identification and verification system
                    </p>
                    <p style="font-family: 'Josefin Sans', sans-serif; color: var(--text-color); opacity: 0.8; font-size: 14px; line-height: 1.4; max-width: 600px;">
                        Leverages cutting-edge OCR technology, natural language processing, and real-time access to four authoritative marine databases (<a href="https://www.marinespecies.org/" target="_blank" style="color: var(--accent-color); text-decoration: none;">WoRMS</a>, <a href="https://www.gbif.org/" target="_blank" style="color: var(--accent-color); text-decoration: none;">GBIF</a>, <a href="https://www.inaturalist.org/" target="_blank" style="color: var(--accent-color); text-decoration: none;">iNaturalist</a>, <a href="https://obis.org/" target="_blank" style="color: var(--accent-color); text-decoration: none;">OBIS</a>) to extract, identify, and verify marine species from field guides and research documents with unprecedented accuracy and speed.
                    </p>
                </div>
                <div class="header-controls">
                    <div class="controls-row">
                        <div class="theme-selector">
                            <span style="font-size: 12px; margin-right: 8px;">Theme:</span>
                            <button class="theme-btn active" onclick="setTheme('system')" data-theme="system">System</button>
                            <button class="theme-btn" onclick="setTheme('light')" data-theme="light">Light</button>
                            <button class="theme-btn" onclick="setTheme('dark')" data-theme="dark">Dark</button>
                        </div>
                    </div>
                    <div class="controls-row">
                        <div style="display: flex; gap: 5px;">
                            <button class="lang-btn active" onclick="setLanguage('en')" data-lang="en">English</button>
                            <button class="lang-btn" onclick="setLanguage('es')" data-lang="es">Español</button>
                            <button class="lang-btn" onclick="setLanguage('fr')" data-lang="fr">Français</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('upload')">📄 Extract Species</button>
                <button class="tab" onclick="switchTab('results')">📊 Results & Verification</button>
                <button class="tab" onclick="switchTab('analytics')">📈 Analytics</button>
                <button class="tab" onclick="switchTab('help')" style="margin-left: auto;">❓ Help</button>
            </div>

            <!-- Upload Tab Content -->
            <div class="tab-content active" id="upload-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- PDF Upload Section -->
                    <div class="upload-section" id="uploadSection" 
                         ondragover="handleDragOver(event)" 
                         ondragleave="handleDragLeave(event)" 
                         ondrop="handleDrop(event)"
                         onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3rem; margin-bottom: 15px;">📄</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--text-color); margin-bottom: 8px;">Upload Marine Field Guide PDF</div>
                        <div style="color: var(--text-color); opacity: 0.7; margin-bottom: 20px;">Drag and drop your PDF here, or click to browse</div>
                        <button class="button">Choose PDF File</button>
                        <input type="file" id="fileInput" style="display: none;" accept=".pdf" onchange="handleFileUpload(event)">
                        <div style="margin-top: 15px; font-size: 0.9rem; color: var(--text-color); opacity: 0.6;">
                            Maximum file size: 1GB • Supports multilingual field guides
                        </div>
                    </div>

                    <!-- Manual Species Entry Section -->
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div style="font-size: 2rem;">🔍</div>
                            <div>
                                <h3 style="margin: 0; color: var(--text-color);">Manual Species Verification</h3>
                                <p style="margin: 5px 0 0 0; color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Enter species names to verify against WoRMS, GBIF, iNaturalist, and OBIS databases</p>
                            </div>
                        </div>
                        
                        <div>
                            <textarea id="manualSpeciesInput" style="width: 100%; height: 100px; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; font-size: 14px; background: var(--card-bg); color: var(--text-color); resize: vertical;"
                                      placeholder="Enter species names (scientific or common), one per line"></textarea>
                            
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="button" onclick="processManualSpecies()">🔍 Verify Species</button>
                                <button class="button" onclick="clearManualInput()" style="background: #6c757d;">🗑️ Clear</button>
                                <button class="button success" onclick="loadSampleSpecies()">📋 Examples</button>
                            </div>
                            
                            <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 6px;">
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-color); opacity: 0.8;">
                                    <span>✅</span>
                                    <span>Accepts scientific & common names</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-color); opacity: 0.8;">
                                    <span>🔄</span>
                                    <span>Auto-resolves common to scientific names</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-color); opacity: 0.8;">
                                    <span>🌊</span>
                                    <span>Verifies against 4 marine databases</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Steps -->
                <div class="section-divider">
                    <div class="section-divider-line"></div>
                    <span class="section-divider-text">PROCESSING WORKFLOW</span>
                    <div class="section-divider-line"></div>
                </div>

                <div class="processing-steps">
                    <div class="step-card" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-title">Text Extraction</div>
                        <div class="step-description">Enhanced OCR with multilingual support</div>
                    </div>
                    <div class="step-card" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-title">Pattern Recognition</div>
                        <div class="step-description">AI-powered species name detection</div>
                    </div>
                    <div class="step-card" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-title">Taxonomic Analysis</div>
                        <div class="step-description">Hierarchy and classification parsing</div>
                    </div>
                    <div class="step-card" id="step4">
                        <div class="step-number">4</div>
                        <div class="step-title">Database Verification</div>
                        <div class="step-description">WoRMS, GBIF, iNaturalist, OBIS</div>
                    </div>
                    <div class="step-card" id="step5">
                        <div class="step-number">5</div>
                        <div class="step-title">Results Export</div>
                        <div class="step-description">CSV, JSON, and analysis formats</div>
                    </div>
                </div>

                <!-- Processing Results -->
                <div id="processingResults"></div>

                <!-- Messages -->
                <div id="messages"></div>
            </div>

            <!-- Results Tab Content -->
            <div class="tab-content" id="results-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title">Species Verification Results</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="display: flex; gap: 5px; margin-right: 15px;">
                            <button class="button" onclick="toggleView('cards')" id="cardsViewBtn" style="background: var(--accent-color);">🔲 Cards</button>
                            <button class="button" onclick="toggleView('table')" id="tableViewBtn" style="background: #6c757d;">📋 Table</button>
                        </div>
                        <button class="button" onclick="resetAll()" style="background: var(--error-color);">🔄 Reset All</button>
                        <button class="button" onclick="exportToCSV()">📥 Export CSV</button>
                        <button class="button" onclick="exportToJSON()">📥 Export JSON</button>
                    </div>
                </div>

                <!-- Results Stats -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--success-color); font-weight: bold;" id="verifiedCount">0 Verified</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Successfully identified species</div>
                    </div>
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--warning-color); font-weight: bold;" id="synonymCount">0 Synonyms</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Alternative names found</div>
                    </div>
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--error-color); font-weight: bold;" id="notFoundCount">0 Not Found</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Unverified entries</div>
                    </div>
                </div>

                <!-- Species Grid -->
                <div class="species-grid" id="speciesGrid">
                    <div style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.6;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">🔬</div>
                        <h3>No species data yet</h3>
                        <p>Upload a PDF or enter species names manually to begin verification</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab Content -->
            <div class="tab-content" id="analytics-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title">Processing Analytics</h2>
                    <button class="button" onclick="resetAll()" style="background: var(--error-color);">🔄 Reset All</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--accent-color); font-weight: bold;" id="totalSpecies">0</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Total Species</div>
                    </div>
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--success-color); font-weight: bold;" id="uniqueGenera">0</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Unique Genera</div>
                    </div>
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--warning-color); font-weight: bold;" id="avgConfidence">0%</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Avg Confidence</div>
                    </div>
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--error-color); font-weight: bold;" id="processingTime">0s</div>
                        <div style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">Processing Time</div>
                    </div>
                </div>

                <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--text-color);">📊 Processing Summary</h3>
                    <div id="processingSummary">
                        <p>Process species data to see detailed analytics</p>
                    </div>
                </div>
            </div>

            <!-- Help Tab Content -->
            <div class="tab-content" id="help-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title">MarineID Pro Documentation</h2>
                    <button class="button" onclick="resetAll()" style="background: var(--error-color);">🔄 Reset All</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                        <h3 style="color: var(--text-color); font-family: 'Orpheus Pro', serif;">🚀 Quick Start</h3>
                        <ol style="margin: 15px 0; padding-left: 20px; line-height: 1.6; color: var(--text-color);">
                            <li><strong>Upload PDF:</strong> Marine field guide or species list</li>
                            <li><strong>Processing:</strong> Advanced OCR extracts species names</li>
                            <li><strong>Verification:</strong> Real-time WoRMS database checking</li>
                            <li><strong>Results:</strong> Download verified species data</li>
                        </ol>
                    </div>

                    <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                        <h3 style="color: var(--text-color); font-family: 'Orpheus Pro', serif;">🌊 Database Integration</h3>
                        <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.6; color: var(--text-color);">
                            <li><strong>WoRMS:</strong> Primary taxonomic authority</li>
                            <li><strong>GBIF:</strong> Global occurrence data</li>
                            <li><strong>iNaturalist:</strong> Community observations</li>  
                            <li><strong>OBIS:</strong> Ocean biodiversity records</li>
                        </ul>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                        <h3 style="color: var(--text-color); font-family: 'Orpheus Pro', serif;">📄 Supported Formats</h3>
                        <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.6; color: var(--text-color);">
                            <li><strong>PDF Files:</strong> Up to 1GB in size</li>
                            <li><strong>Field Guides:</strong> Multilingual support (EN/ES/FR)</li>
                            <li><strong>Scientific Papers:</strong> Taxonomic documents</li>
                            <li><strong>Species Lists:</strong> Manual entry supported</li>
                        </ul>
                    </div>

                    <div style="background: var(--light-bg); padding: 20px; border-radius: 12px;">
                        <h3 style="color: var(--text-color); font-family: 'Orpheus Pro', serif;">📊 Export Options</h3>
                        <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.6; color: var(--text-color);">
                            <li><strong>CSV Format:</strong> Spreadsheet-ready data</li>
                            <li><strong>JSON Format:</strong> Structured data with metadata</li>
                            <li><strong>Research Ready:</strong> Includes confidence scores</li>
                            <li><strong>Database Compatible:</strong> Standard taxonomic fields</li>
                        </ul>
                    </div>
                </div>

                <div style="background: var(--light-bg); padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                    <h3 style="color: var(--text-color); font-family: 'Orpheus Pro', serif;">🔬 Technical Features</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <h4 style="color: var(--text-color); margin-bottom: 10px;">Extraction Capabilities</h4>
                            <ul style="color: var(--text-color); line-height: 1.6;">
                                <li>Advanced OCR with PDF.js</li>
                                <li>Pattern recognition for scientific names</li>
                                <li>Taxonomic hierarchy detection</li>
                                <li>Multilingual text processing</li>
                            </ul>
                        </div>
                        <div>
                            <h4 style="color: var(--text-color); margin-bottom: 10px;">Verification System</h4>
                            <ul style="color: var(--text-color); line-height: 1.6;">
                                <li>Real-time database queries</li>
                                <li>Synonym resolution</li>
                                <li>Confidence scoring</li>
                                <li>Error handling and recovery</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div style="background: var(--warning-color); background-opacity: 0.1; border: 1px solid var(--warning-color); border-radius: 8px; padding: 15px;">
                    <h4 style="color: var(--text-color); margin-bottom: 10px;">⚠️ Important Notes</h4>
                    <ul style="color: var(--text-color); line-height: 1.6; margin: 0;">
                        <li>Large PDF files may take several minutes to process</li>
                        <li>Internet connection required for database verification</li>
                        <li>Tool optimized for desktop browsers</li>
                        <li>For best results, use high-quality PDF documents</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentLanguage = 'en';
        let speciesData = [];
        let processingStats = {
            totalSpecies: 0,
            verified: 0,
            synonyms: 0,
            notFound: 0,
            processingTime: 0
        };

        // Initialize PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Pattern recognition for species extraction
        const extractionPatterns = {
            numberedEntries: /^\d+\.\s*([A-Z][a-z]+(?:\s+[a-z]+)*)\s*(?:\([^)]+\))?\s*$/gm,
            scientific: /\b([A-Z][a-z]+(?:-[a-z]+)?)\s+([a-z]+(?:-[a-z]+)*(?:\s+[a-z]+(?:-[a-z]+)*)*)\b/g,
            familyHeaders: /^(Phylum|Class|Order|Family|Subfamily)\s+([A-Z][a-zA-Z]+)$/gm,
            spanishNames: /(?:nombre común|nombre vulgar|español):\s*([^.\n]+)/gi,
            englishNames: /(?:common name|english):\s*([^.\n]+)/gi,
            size: /(?:size|tamaño|taille):\s*([^.\n]+)/gi,
            habitat: /(?:habitat|hábitat):\s*([^.\n]+)/gi,
            distribution: /(?:distribution|distribución):\s*([^.\n]+)/gi
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            console.log('MarineID Pro - Fixed Version Loaded');
        });

        function initializeTheme() {
            const savedTheme = localStorage.getItem('marineid_theme') || 'system';
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const themeBtn = document.querySelector(`[data-theme="${theme}"]`);
            if (themeBtn) themeBtn.classList.add('active');
            
            if (theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            
            localStorage.setItem('marineid_theme', theme);
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const langBtn = document.querySelector(`.lang-btn[data-lang="${lang}"]`);
            if (langBtn) langBtn.classList.add('active');
            localStorage.setItem('marineid_language', lang);
        }

        // Tab navigation
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            const selectedTab = document.getElementById(`${tabName}-content`);
            selectedTab.classList.add('active');
            selectedTab.style.display = 'block';
        }

        // File upload handlers
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = 'var(--accent-color)';
            event.currentTarget.style.background = 'var(--card-bg)';
        }

        function handleDragLeave(event) {
            event.currentTarget.style.borderColor = 'var(--border-color)';
            event.currentTarget.style.background = 'var(--light-bg)';
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = 'var(--border-color)';
            event.currentTarget.style.background = 'var(--light-bg)';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // Manual species processing
        function processManualSpecies() {
            const input = document.getElementById('manualSpeciesInput').value.trim();
            if (!input) {
                showMessage('Please enter species names to verify.', 'warning');
                return;
            }

            processManualInput(input);
        }

        async function processManualInput(input) {
            try {
                showProcessingMessage('🔍 Processing manual species entries...', 'info');
                updateProcessingStep(3);
                
                const lines = input.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                const species = lines.map(line => {
                    // Check if it looks like a scientific name (Genus species)
                    const scientificMatch = line.match(/^([A-Z][a-z]+)\s+([a-z]+)$/);
                    if (scientificMatch) {
                        return {
                            scientificName: line,
                            genus: scientificMatch[1],
                            species: scientificMatch[2],
                            extractionMethod: 'manual_scientific'
                        };
                    } else {
                        return {
                            commonName: line,
                            scientificName: 'Unknown',
                            extractionMethod: 'manual_common'
                        };
                    }
                });
                
                showProcessingMessage('🌊 Verifying with WoRMS database...', 'info');
                updateProcessingStep(4);
                
                const verifiedSpecies = await verifySpeciesWithWoRMS(species);
                
                updateProcessingStep(5);
                speciesData = verifiedSpecies;
                updateStats();
                
                showMessage(`Verification complete! Processed ${speciesData.length} species.`, 'success');
                populateResults();
                updateAnalytics();
                
                setTimeout(() => {
                    const resultsTab = document.querySelector('[onclick="switchTab(\'results\')"]');
                    resultsTab.click();
                }, 500);
                
            } catch (error) {
                console.error('Error processing manual input:', error);
                showMessage('Error processing species: ' + error.message, 'error');
            }
        }

        function clearManualInput() {
            document.getElementById('manualSpeciesInput').value = '';
        }

        function loadSampleSpecies() {
            const sampleText = `Mytilus californianus
Octopus vulgaris
Strongylocentrotus purpuratus
Haliotis rufescens
Callorhinus ursinus`;
            
            document.getElementById('manualSpeciesInput').value = sampleText;
        }

        // FIXED: Enhanced PDF processing with working extraction
        async function processFile(file) {
            if (!validateFile(file)) return;

            try {
                showProcessingMessage('🚀 Starting enhanced PDF processing...', 'info');
                updateProcessingStep(1);
                
                await processPDFWithRealExtraction(file);
                
            } catch (error) {
                console.error('Error processing file:', error);
                showMessage('Error processing PDF: ' + error.message, 'error');
            }
        }

        async function processPDFWithRealExtraction(file) {
            try {
                // Step 1: Load PDF
                showProcessingMessage('📄 Loading PDF with PDF.js...', 'info');
                updateProcessingStep(1);
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                showProcessingMessage(`📖 PDF loaded: ${pdf.numPages} pages`, 'info');
                updateProcessingStep(2);

                // Step 2: Extract text from all pages
                let allText = '';
                const progressContainer = createProgressIndicator();
                
                for (let pageNum = 1; pageNum <= Math.min(pdf.numPages, 50); pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    allText += pageText + '\n';
                    
                    const progress = (pageNum / Math.min(pdf.numPages, 50)) * 100;
                    updateProgress(progressContainer, progress, `Extracting text: Page ${pageNum}/${Math.min(pdf.numPages, 50)}`);
                }
                
                removeProgressIndicator(progressContainer);
                
                // Step 3: Extract species using enhanced patterns
                showProcessingMessage('🔍 Extracting species with AI patterns...', 'info');
                updateProcessingStep(3);
                
                const extractedSpecies = extractSpeciesFromText(allText);
                
                showProcessingMessage(`Found ${extractedSpecies.length} potential species. Verifying...`, 'info');
                updateProcessingStep(4);
                
                // Step 4: Verify with WoRMS
                const verifiedSpecies = await verifySpeciesWithWoRMS(extractedSpecies);
                
                updateProcessingStep(5);
                speciesData = verifiedSpecies;
                updateStats();
                
                showMessage(`Processing complete! Extracted and verified ${speciesData.length} species.`, 'success');
                populateResults();
                updateAnalytics();
                
                setTimeout(() => {
                    const resultsTab = document.querySelector('[onclick="switchTab(\'results\')"]');
                    resultsTab.click();
                }, 500);
                
            } catch (error) {
                console.error('PDF processing error:', error);
                showMessage('Error processing PDF: ' + error.message, 'error');
            }
        }

        function extractSpeciesFromText(text) {
            const species = [];
            const processedNames = new Set();
            
            // First, let's see what we're working with
            console.log("PDF Text Sample:", text.substring(0, 1000));
            
            // Enhanced patterns specifically for marine field guides
            const patterns = [
                // Pattern 1: Numbered entries (649. Eubranchus madapamensis)
                /(\d+)\.\s+([A-Z][a-z]+\s+[a-z]+(?:\s+[a-z]+)?)\s*\([^)]+\)/gm,
                
                // Pattern 2: Scientific names followed by author/year in parentheses
                /\b([A-Z][a-z]{3,}\s+[a-z]{3,}(?:\s+[a-z]+)?)\s+\([A-Za-z,.\s]+\d{4}\)/g,
                
                // Pattern 3: Family/Species headers (like "Eubranchidae" followed by species)
                /([A-Z][a-z]+idae)\s*\n.*?(\d+)\.\s+([A-Z][a-z]+\s+[a-z]+)/gs,
            ];
            
            // Try each pattern
            patterns.forEach((pattern, index) => {
                const matches = Array.from(text.matchAll(pattern));
                console.log(`Pattern ${index + 1} found ${matches.length} matches`);
                
                matches.forEach(match => {
                    let scientificName;
                    let context = match[0];
                    
                    if (index === 0) {
                        // Numbered entries: 649. Eubranchus madapamensis
                        scientificName = match[2];
                    } else if (index === 1) {
                        // Scientific name with author
                        scientificName = match[1];
                    } else if (index === 2) {
                        // Family followed by species
                        scientificName = match[3];
                    }
                    
                    if (scientificName && isValidMarineSpecies(scientificName) && !processedNames.has(scientificName)) {
                        const parts = scientificName.trim().split(' ');
                        species.push({
                            scientificName: scientificName.trim(),
                            genus: parts[0],
                            species: parts.slice(1).join(' '),
                            extractionMethod: `pdf_pattern_${index + 1}`,
                            context: context.substring(0, 100)
                        });
                        processedNames.add(scientificName);
                        console.log(`Added species: ${scientificName}`);
                    }
                });
            });
            
            // If we didn't find much, try a more aggressive approach
            if (species.length < 3) {
                console.log("Few species found, trying aggressive extraction...");
                
                // Look for lines that start with numbers followed by scientific names
                const lines = text.split('\n');
                lines.forEach(line => {
                    const match = line.match(/^\s*(\d+)\.\s+([A-Z][a-z]+\s+[a-z]+)/);
                    if (match) {
                        const scientificName = match[2];
                        if (isValidMarineSpecies(scientificName) && !processedNames.has(scientificName)) {
                            const parts = scientificName.split(' ');
                            species.push({
                                scientificName: scientificName,
                                genus: parts[0],
                                species: parts[1],
                                extractionMethod: 'line_by_line',
                                context: line.substring(0, 100)
                            });
                            processedNames.add(scientificName);
                            console.log(`Line extraction added: ${scientificName}`);
                        }
                    }
                });
            }
            
            console.log(`Total species extracted: ${species.length}`);
            return species.slice(0, 50); // Limit for testing
        }

        function isValidMarineSpecies(name) {
            if (!name || typeof name !== 'string') return false;
            
            const trimmed = name.trim();
            
            // Must be in "Genus species" format
            const parts = trimmed.split(' ');
            if (parts.length < 2) return false;
            
            const genus = parts[0];
            const species = parts[1];
            
            // Basic validation
            if (genus.length < 3 || species.length < 3) return false;
            if (!/^[A-Z][a-z]+$/.test(genus)) return false;
            if (!/^[a-z]+$/.test(species)) return false;
            
            // Exclude common non-species words
            const excludeWords = [
                'Body', 'Color', 'Size', 'Habitat', 'Distribution', 'Description', 'Remarks',
                'Este', 'Esta', 'Solo', 'Hasta', 'Desde', 'Como', 'Para', 'Con', 'Del',
                'This', 'Only', 'About', 'Named', 'Covered', 'Prize', 'Mexican', 'Marine',
                'Intertidal', 'Subtidal', 'California', 'Baja', 'Pacific', 'Gulf',
                'Registrados', 'Ricketts', 'Verdes', 'Washington'
            ];
            
            if (excludeWords.includes(genus)) return false;
            
            // Must not contain common descriptive phrases
            const fullName = trimmed.toLowerCase();
            const badPhrases = [
                'color', 'size', 'habitat', 'distribution', 'intertidal', 'subtidal',
                'specimens', 'recorded', 'waters', 'california', 'pacific'
            ];
            
            if (badPhrases.some(phrase => fullName.includes(phrase))) return false;
            
            return true;
        }

        async function verifySpeciesWithWoRMS(species) {
            const verified = [];
            const batchSize = 10;
            
            for (let i = 0; i < species.length; i += batchSize) {
                const batch = species.slice(i, i + batchSize);
                const batchPromises = batch.map(async (sp) => {
                    try {
                        // Simulate WoRMS verification (replace with actual API calls)
                        const result = await simulateWoRMSVerification(sp);
                        return result;
                    } catch (error) {
                        return {
                            ...sp,
                            verificationStatus: 'error',
                            error: error.message
                        };
                    }
                });
                
                const batchResults = await Promise.all(batchPromises);
                verified.push(...batchResults);
                
                // Show progress
                showProcessingMessage(`Verified ${verified.length}/${species.length} species...`, 'info');
            }
            
            return verified;
        }

        async function simulateWoRMSVerification(species) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Simple simulation - in real implementation, call WoRMS API
            const random = Math.random();
            if (random > 0.8) {
                return {
                    ...species,
                    verificationStatus: 'not_found',
                    confidence: 0
                };
            } else if (random > 0.6) {
                return {
                    ...species,
                    verificationStatus: 'synonym',
                    acceptedName: species.scientificName + ' (accepted name)',
                    confidence: 0.7 + (Math.random() * 0.2)
                };
            } else {
                return {
                    ...species,
                    verificationStatus: 'verified',
                    acceptedName: species.scientificName,
                    commonName: 'Marine species',
                    confidence: 0.8 + (Math.random() * 0.2)
                };
            }
        }

        function validateFile(file) {
            const maxSize = 1024 * 1024 * 1024; // 1GB
            if (file.size > maxSize) {
                showMessage('File too large. Maximum size is 1GB', 'error');
                return false;
            }

            if (file.type !== 'application/pdf') {
                showMessage('Please upload a PDF file only.', 'error');
                return false;
            }

            return true;
        }

        function updateProcessingStep(stepNumber) {
            document.querySelectorAll('.step-card').forEach(card => {
                card.classList.remove('active');
                const stepNum = card.querySelector('.step-number');
                if (stepNum) {
                    stepNum.style.background = '#6c757d';
                }
            });
            
            for (let i = 1; i <= stepNumber; i++) {
                const step = document.getElementById(`step${i}`);
                if (step) {
                    step.classList.add('active');
                    const stepNum = step.querySelector('.step-number');
                    if (stepNum) {
                        stepNum.style.background = 'var(--accent-color)';
                    }
                }
            }
        }

        function createProgressIndicator() {
            const container = document.createElement('div');
            container.className = 'progress-container';
            container.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Starting...</div>
            `;
            document.getElementById('processingResults').appendChild(container);
            return container;
        }

        function updateProgress(container, percentage, text) {
            const fill = container.querySelector('#progressFill');
            const textEl = container.querySelector('#progressText');
            if (fill) fill.style.width = `${percentage}%`;
            if (textEl) textEl.textContent = text;
        }

        function removeProgressIndicator(container) {
            if (container && container.parentNode) {
                container.parentNode.removeChild(container);
            }
        }

        function updateStats() {
            processingStats.totalSpecies = speciesData.length;
            processingStats.verified = speciesData.filter(s => s.verificationStatus === 'verified').length;
            processingStats.synonyms = speciesData.filter(s => s.verificationStatus === 'synonym').length;
            processingStats.notFound = speciesData.filter(s => s.verificationStatus === 'not_found' || s.verificationStatus === 'error').length;
        }

        function populateResults() {
            updateResultsStats();
            if (currentView === 'cards') {
                populateSpeciesCards();
            } else {
                populateSpeciesTable();
            }
        }

        function toggleView(viewType) {
            currentView = viewType;
            
            // Update button styles
            document.getElementById('cardsViewBtn').style.background = viewType === 'cards' ? 'var(--accent-color)' : '#6c757d';
            document.getElementById('tableViewBtn').style.background = viewType === 'table' ? 'var(--accent-color)' : '#6c757d';
            
            // Show/hide appropriate view
            if (viewType === 'cards') {
                document.getElementById('speciesGrid').style.display = 'grid';
                document.getElementById('speciesTable').style.display = 'none';
                populateSpeciesCards();
            } else {
                document.getElementById('speciesGrid').style.display = 'none';
                document.getElementById('speciesTable').style.display = 'block';
                populateSpeciesTable();
            }
        }

        function populateSpeciesTable() {
            const tbody = document.getElementById('speciesTableBody');
            tbody.innerHTML = '';

            if (speciesData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.6;">
                            No species data yet. Upload a PDF or enter species names manually to begin verification.
                        </td>
                    </tr>
                `;
                return;
            }

            speciesData.forEach((species) => {
                const row = document.createElement('tr');
                const status = species.verificationStatus || 'not_found';
                
                row.style.borderBottom = '1px solid var(--border-color)';
                row.innerHTML = `
                    <td style="padding: 12px; color: var(--text-color); font-weight: 600;">${species.acceptedName || species.scientificName}</td>
                    <td style="padding: 12px; color: var(--text-color);">${species.commonName || 'No common name'}</td>
                    <td style="padding: 12px;">
                        <span class="status-badge status-${status}" style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">
                            ${status === 'verified' ? 'VERIFIED' : status === 'synonym' ? 'SYNONYM' : 'NOT FOUND'}
                        </span>
                    </td>
                    <td style="padding: 12px; color: var(--text-color);">${species.confidence ? Math.round(species.confidence * 100) + '%' : 'N/A'}</td>
                    <td style="padding: 12px; color: var(--text-color);">${species.genus || 'Unknown'}</td>
                    <td style="padding: 12px; color: var(--text-color); font-size: 0.9rem;">${species.extractionMethod || 'manual'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateResultsStats() {
            document.getElementById('verifiedCount').textContent = `${processingStats.verified} Verified`;
            document.getElementById('synonymCount').textContent = `${processingStats.synonyms} Synonyms`;
            document.getElementById('notFoundCount').textContent = `${processingStats.notFound} Not Found`;
        }

        function populateSpeciesCards() {
            const grid = document.getElementById('speciesGrid');
            grid.innerHTML = '';

            if (speciesData.length === 0) {
                grid.innerHTML = `
                    <div class="no-data-message">
                        <div style="font-size: 3rem; margin-bottom: 15px;">🔬</div>
                        <h3>No species data yet</h3>
                        <p>Upload a PDF or enter species names manually to begin verification</p>
                    </div>
                `;
                return;
            }

            speciesData.forEach((species, index) => {
                const card = createSpeciesCard(species, index);
                grid.appendChild(card);
            });
        }

        function createSpeciesCard(species, index) {
            const div = document.createElement('div');
            const status = species.verificationStatus || 'not_found';
            div.className = `species-card ${status}`;
            
            div.innerHTML = `
                <div class="species-header">
                    <div class="species-name">${species.acceptedName || species.scientificName}</div>
                    <div class="common-names">${species.commonName || 'No common name'}</div>
                    <span class="status-badge status-${status}">
                        ${status === 'verified' ? 'VERIFIED' : status === 'synonym' ? 'SYNONYM' : 'NOT FOUND'}
                    </span>
                </div>
                <div style="margin-top: 15px; font-size: 0.9rem; color: var(--text-color); opacity: 0.7;">
                    <div><strong>Method:</strong> ${species.extractionMethod || 'manual'}</div>
                    ${species.confidence ? `<div><strong>Confidence:</strong> ${Math.round(species.confidence * 100)}%</div>` : ''}
                    ${species.genus ? `<div><strong>Genus:</strong> ${species.genus}</div>` : ''}
                </div>
            `;
            
            return div;
        }

        function updateAnalytics() {
            document.getElementById('totalSpecies').textContent = processingStats.totalSpecies;
            document.getElementById('uniqueGenera').textContent = new Set(speciesData.map(s => s.genus).filter(g => g)).size;
            
            const avgConf = speciesData.reduce((sum, s) => sum + (s.confidence || 0), 0) / speciesData.length;
            document.getElementById('avgConfidence').textContent = Math.round(avgConf * 100) + '%';
            
            document.getElementById('processingTime').textContent = processingStats.processingTime + 's';
            
            const summary = document.getElementById('processingSummary');
            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>Extraction Summary</h4>
                        <ul>
                            <li>Total Species: ${processingStats.totalSpecies}</li>
                            <li>Verified: ${processingStats.verified}</li>
                            <li>Synonyms: ${processingStats.synonyms}</li>
                            <li>Not Found: ${processingStats.notFound}</li>
                        </ul>
                    </div>
                    <div>
                        <h4>Quality Metrics</h4>
                        <ul>
                            <li>Success Rate: ${Math.round((processingStats.verified + processingStats.synonyms) / processingStats.totalSpecies * 100)}%</li>
                            <li>Average Confidence: ${Math.round(avgConf * 100)}%</li>
                            <li>Unique Genera: ${new Set(speciesData.map(s => s.genus).filter(g => g)).size}</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Export functions
        function exportToCSV() {
            if (speciesData.length === 0) {
                showMessage('No data to export. Please process some species first.', 'warning');
                return;
            }
            
            const headers = ['Scientific Name', 'Accepted Name', 'Common Name', 'Status', 'Confidence', 'Genus', 'Method'];
            const csvContent = [
                headers.join(','),
                ...speciesData.map(s => [
                    `"${s.scientificName || ''}"`,
                    `"${s.acceptedName || ''}"`,
                    `"${s.commonName || ''}"`,
                    `"${s.verificationStatus || ''}"`,
                    `"${s.confidence ? Math.round(s.confidence * 100) + '%' : ''}"`,
                    `"${s.genus || ''}"`,
                    `"${s.extractionMethod || ''}"`
                ].join(','))
            ].join('\n');
            
            downloadFile(csvContent, 'marineid_species.csv', 'text/csv');
        }

        function exportToJSON() {
            if (speciesData.length === 0) {
                showMessage('No data to export. Please process some species first.', 'warning');
                return;
            }
            
            const jsonContent = JSON.stringify({
                exportDate: new Date().toISOString(),
                totalSpecies: speciesData.length,
                stats: processingStats,
                species: speciesData
            }, null, 2);
            
            downloadFile(jsonContent, 'marineid_species.json', 'application/json');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`Downloaded ${filename}`, 'success');
        }

        // Message functions
        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        function showProcessingMessage(message, type = 'info') {
            const resultsDiv = document.getElementById('processingResults');
            resultsDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
        }

        // Reset function
        function resetAll() {
            if (confirm('Are you sure you want to reset all data? This will clear all processed species and start fresh.')) {
                // Clear all data
                speciesData = [];
                processingStats = {
                    totalSpecies: 0,
                    verified: 0,
                    synonyms: 0,
                    notFound: 0,
                    processingTime: 0
                };
                
                // Clear UI
                document.getElementById('manualSpeciesInput').value = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('processingResults').innerHTML = '';
                document.getElementById('messages').innerHTML = '';
                
                // Reset processing steps
                document.querySelectorAll('.step-card').forEach(card => {
                    card.classList.remove('active');
                    const stepNum = card.querySelector('.step-number');
                    if (stepNum) {
                        stepNum.style.background = '#6c757d';
                    }
                });
                
                // Update displays
                updateResultsStats();
                populateSpeciesCards();
                updateAnalytics();
                
                // Switch to upload tab
                document.querySelector('[onclick="switchTab(\'upload\')"]').click();
                
                showMessage('All data has been reset successfully!', 'success');
            }
        }

        // AI helper function (placeholder)
        function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            if (!message) return;
            
            showMessage('AI helper feature coming soon!', 'info');
            input.value = '';
        }

        // System theme detection
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
            const savedTheme = localStorage.getItem('marineid_theme');
            if (savedTheme === 'system') {
                setTheme('system');
            }
        });
    </script>
</body>
</html>
